(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-index-index~pages-post-detail-post-detail~pages-user-profile-user-profile"],{"05f6":function(e,t,r){var n=r("5014").default,o=r("d189").default,a=r("883d").default,l=r("4db6").default;r("bf0f"),r("f3f7"),r("18f7"),r("de6c"),r("c223"),r("2797"),r("aa9c"),r("8f71"),r("fd3c"),r("dc8a"),r("9db6"),r("9327");var c=r("3ab8").default,s=r("11ca"),u=s.cloudCall;function i(e){return c.namespace("follow:".concat(e),{persistent:!0,maxItems:4e3})}var f=function(){"use strict";function e(){a(this,e),this.loadingFollows=new Set}return l(e,[{key:"callCloudFunction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u(e,t,{pageTag:"followCache",requireAuth:!0})}},{key:"getFollowStatus",value:function(e,t){if(!e||!t||e===t)return Promise.resolve(null);var r=i(e).get(t);return r?(console.log("【关注缓存】命中缓存: ".concat(e," -> ").concat(t)),Promise.resolve(r)):this.loadingFollows.has("".concat(e,"_").concat(t))?(console.log("【关注缓存】正在加载中，等待: ".concat(e," -> ").concat(t)),this.waitForFollowLoad(e,t)):this.loadFollowStatus(e,t)}},{key:"waitForFollowLoad",value:function(e,t){var r=this;return new Promise((function(n){var o="".concat(e,"_").concat(t),a=setInterval((function(){if(!r.loadingFollows.has(o)){clearInterval(a);var l=i(e).get(t);n(l)}}),100);setTimeout((function(){clearInterval(a),r.loadingFollows.delete(o),n(null)}),3e3)}))}},{key:"loadFollowStatus",value:function(e,t){var r=this,n="".concat(e,"_").concat(t);return this.loadingFollows.add(n),console.log("【关注缓存】开始加载关注状态: ".concat(e," -> ").concat(t)),new Promise((function(o){r.callCloudFunction("follow",{action:"checkFollow",targetOpenid:t}).then((function(r){if(r.result&&r.result.success){var n={isFollowing:!!r.result.isFollowing,isFollowedByAuthor:!!r.result.isFollower,isMutualFollow:!!r.result.isMutual,lastUpdated:Date.now()};i(e).set(t,n,{ttlMs:36e5}),console.log("【关注缓存】加载并缓存成功: ".concat(e," -> ").concat(t),n),o(n)}else console.warn("【关注缓存】获取关注状态失败: ".concat(e," -> ").concat(t),r.result),o(null)})).catch((function(r){console.error("【关注缓存】加载关注状态失败: ".concat(e," -> ").concat(t),r),o(null)})).finally((function(){r.loadingFollows.delete(n)}))}))}},{key:"getBatchFollowStatus",value:function(e,t){var r=this;if(!e||!t||0===t.length)return Promise.resolve({});var n={},o=[];return t.forEach((function(t){if(t!==e){var r=i(e).get(t);r?n[t]=r:o.push(t)}})),o.length>0?(console.log("【关注缓存】批量加载关注状态: ".concat(o.length,"个")),new Promise((function(t){r.callCloudFunction("getBatchFollowStatus",{currentUserId:e,targetUserIds:o}).then((function(r){r.result&&r.result.success&&r.result.followStatuses&&r.result.followStatuses.forEach((function(t){if(t&&t.targetUserId){var r={isFollowing:!!t.isFollowing,isFollowedByAuthor:!!t.isFollowedByAuthor,isMutualFollow:!!t.isMutualFollow,lastUpdated:Date.now()};n[t.targetUserId]=r,i(e).set(t.targetUserId,r,{ttlMs:36e5})}})),t(n)})).catch((function(e){console.error("【关注缓存】批量加载失败:",e),t(n)}))}))):Promise.resolve(n)}},{key:"preloadFollowStatusFromPosts",value:function(e,t){var r=this;if(e&&0!==e.length&&t){var n=o(new Set(e.map((function(e){return e._openid})).filter((function(e){return e&&e!==t}))));0!==n.length&&setTimeout((function(){r.getBatchFollowStatus(t,n).then((function(e){console.log("【关注缓存】预加载完成: ".concat(Object.keys(e).length,"个关注状态"))}))}),100)}}},{key:"updateFollowStatus",value:function(e,t,r){if(!e||!t||!r)return!1;var o=n(n({},r),{},{lastUpdated:Date.now()});try{return i(e).set(t,o,{ttlMs:36e5}),!0}catch(a){return!1}}},{key:"toggleFollowStatus",value:function(e,t){var r=this;return e&&t&&e!==t?new Promise((function(n){r.callCloudFunction("follow",{action:"toggleFollow",targetOpenid:t}).then((function(o){if(o.result&&o.result.success){var a={isFollowing:!!o.result.isFollowing,isFollowedByAuthor:!!o.result.isFollower,isMutualFollow:!!o.result.isMutual,lastUpdated:Date.now()};r.updateFollowStatus(e,t,a),console.log("【关注缓存】切换关注状态成功: ".concat(e," -> ").concat(t),a),n(a)}else console.warn("【关注缓存】切换关注状态失败: ".concat(e," -> ").concat(t),o.result),n(null)})).catch((function(r){console.error("【关注缓存】切换关注状态失败: ".concat(e," -> ").concat(t),r),n(null)}))})):Promise.resolve(null)}},{key:"clearUserFollowCache",value:function(e){if(!e)return!1;try{return i(e).clear(),!0}catch(t){return console.log("CatchClause",t),console.log("CatchClause",t),console.error("清理用户关注缓存失败:",t),!1}}},{key:"clearAllFollowCache",value:function(){try{var e=uni.getStorageInfoSync&&uni.getStorageInfoSync(),t=e&&e.keys||[];return t.forEach((function(e){if("string"===typeof e&&e.startsWith("__cm__:follow:")&&e.endsWith(":__keys__")){var t=e.substring("__cm__:".length,e.length-":__keys__".length);try{c.namespace(t,{persistent:!0}).clear()}catch(r){}}})),!0}catch(r){return console.log("CatchClause",r),console.log("CatchClause",r),console.error("清理所有关注缓存失败:",r),!1}}}]),e}(),d=new f;e.exports=d},"139b":function(e,t,r){r("795c"),r("64aa"),r("5c47"),r("a1c1"),r("c223"),r("f7a5");var n=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return String(e).padStart(t,"0")},o=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yyyy-MM-dd HH:mm:ss",r=e instanceof Date?e:new Date(e);if(Number.isNaN(r.getTime()))return"";var o={yyyy:String(r.getFullYear()),MM:n(r.getMonth()+1),dd:n(r.getDate()),HH:n(r.getHours()),mm:n(r.getMinutes()),ss:n(r.getSeconds())};return t.replace(/yyyy|MM|dd|HH|mm|ss/g,(function(e){return o[e]}))};e.exports={formatTimeAgo:function(e){var t=new Date,r=new Date(e),n=t.getTime()-r.getTime(),o=Math.floor(n/1e3),a=Math.floor(o/60),l=Math.floor(a/60),c=Math.floor(l/24);if(c>=7){var s=r.getFullYear(),u=("0"+(r.getMonth()+1)).slice(-2),i=("0"+r.getDate()).slice(-2);return"".concat(s,"-").concat(u,"-").concat(i)}return c>=1?"".concat(c,"天前"):l>=1?"".concat(l,"小时前"):a>=1?"".concat(a,"分钟前"):"刚刚"},formatRelativeTime:function(e){var t=Date.now(),r=e instanceof Date?e.getTime():new Date(e).getTime();if(Number.isNaN(r))return"";var n=t-r,a=Math.floor(Math.abs(n)/1e3),l=n>=0?"前":"后";if(a<60)return"刚刚";var c=Math.floor(a/60);if(c<60)return"".concat(c,"分钟").concat(l);var s=Math.floor(c/60);if(s<24)return"".concat(s,"小时").concat(l);var u=Math.floor(s/24);return u<7?"".concat(u,"天").concat(l):o(r,"yyyy-MM-dd")},formatDate:o}},2774:function(e,t,r){r("01a2"),r("e39c"),r("bf0f"),r("844d"),r("18f7"),r("de6c"),r("08eb"),e.exports=function(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},e.exports.__esModule=!0,e.exports["default"]=e.exports},"4db6":function(e,t,r){r("6a54");var n=r("8bcf");function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,n(o.key),o)}}e.exports=function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e},e.exports.__esModule=!0,e.exports["default"]=e.exports},5014:function(e,t,r){r("dc8a"),r("01a2"),r("8f71"),r("bf0f"),r("9a2c"),r("aa9c"),r("2797"),r("a644"),r("a03a"),r("6a54");var n=r("4550");function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}e.exports=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e},e.exports.__esModule=!0,e.exports["default"]=e.exports},"73e1":function(e,t,r){"use strict";var n=r("29d8");e.exports=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(n)},"795c":function(e,t,r){"use strict";var n=r("8bdb"),o=r("db04").start,a=r("73e1");n({target:"String",proto:!0,forced:a},{padStart:function(e){return o(this,e,arguments.length>1?arguments[1]:void 0)}})},"883d":function(e,t,r){r("7a76"),r("c9b5"),e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.__esModule=!0,e.exports["default"]=e.exports},"8e86":function(e,t,r){function n(e){if(!e)return{current:"",urls:[]};if(e.currentTarget&&e.currentTarget.dataset){var t=e.currentTarget.dataset,r=t.src||t.current||t.url||Array.isArray(t.urls)&&t.urls[0]||"",n=t.originalImageUrls||t.urls||t.urlList,o=Array.isArray(n)?n.filter(Boolean):"string"===typeof n&&n?[n]:[];return{current:r,urls:o}}var a=e.current||e.src||Array.isArray(e.urls)&&e.urls[0]||Array.isArray(e.list)&&e.list[0]||"",l=Array.isArray(e.urls)?e.urls.filter(Boolean):Array.isArray(e.list)?e.list.filter(Boolean):[];return{current:a,urls:l}}function o(e){"undefined"!==typeof uni&&uni.showToast&&uni.showToast({title:e,icon:"none"})}r("8f71"),r("bf0f"),e.exports={previewImage:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.fallbackToast,a=void 0===r||r,l=n(e);if(!l.current&&0===l.urls.length)return a&&o("图片数据缺失"),!1;var c=l.urls.length?l.urls:[l.current],s=l.current||c[0];return s&&0!==c.length?uni.previewImage({current:s,urls:c}):(a&&o("图片不可预览"),!1)}}},9376:function(e,t,r){r("7a76"),r("c9b5"),e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.__esModule=!0,e.exports["default"]=e.exports},a7cb:function(e,t,r){var n=r("5014").default,o=r("d189").default,a=r("4cf1").default,l=r("dd7e").default,c=r("46c5").default,s=r("883d").default,u=r("4db6").default;r("bf0f"),r("f3f7"),r("18f7"),r("de6c"),r("9db6"),r("2797"),r("aa9c"),r("8f71"),r("fd3c"),r("dc8a");var i=r("3ab8").default,f=r("c605").default||r("c605"),d=r("11ca"),v=d.cloudCall,g=i.namespace("avatars",{persistent:!0,maxItems:2048}),p=function(){"use strict";function e(){s(this,e),this.loadingAvatars=new Set}return u(e,[{key:"callCloudFunction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return v(e,t,{pageTag:"avatarCache"})}},{key:"getUserAvatar",value:function(e){if(!e)return Promise.resolve(null);var t=g.get(e);return t?(console.log("【头像缓存】命中缓存: ".concat(e)),Promise.resolve(t)):this.loadingAvatars.has(e)?(console.log("【头像缓存】正在加载中，等待: ".concat(e)),this.waitForAvatarLoad(e)):this.loadUserAvatar(e)}},{key:"waitForAvatarLoad",value:function(e){var t=this;return new Promise((function(r){var n=setInterval((function(){if(!t.loadingAvatars.has(e)){clearInterval(n);var o=g.get(e);r(o)}}),100);setTimeout((function(){clearInterval(n),t.loadingAvatars.delete(e),r(null)}),5e3)}))}},{key:"loadUserAvatar",value:function(e){var t=this;return this.loadingAvatars.add(e),console.log("【头像缓存】开始加载头像: ".concat(e)),new Promise((function(r){t.callCloudFunction("getUserProfile",{userId:e}).then(function(){var t=c(l().mark((function t(n){var o,a,c;return l().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!(n.result&&n.result.success&&n.result.userInfo)){t.next=23;break}if(o=n.result.userInfo,a=o.avatarUrl,t.prev=3,"string"!==typeof a||!a.startsWith("cloud://")){t.next=13;break}if(!f||!f.getTempUrl){t.next=11;break}return t.next=8,f.getTempUrl(a);case 8:t.t0=t.sent,t.next=12;break;case 11:t.t0=a;case 12:a=t.t0;case 13:t.next=17;break;case 15:t.prev=15,t.t1=t["catch"](3);case 17:c={avatarUrl:a,nickName:o.nickName,bio:o.bio,lastUpdated:Date.now()},g.set(e,c,{ttlMs:864e5}),console.log("【头像缓存】加载并缓存成功: ".concat(e)),r(c),t.next=25;break;case 23:console.warn("【头像缓存】获取用户信息失败: ".concat(e),n.result),r(null);case 25:case"end":return t.stop()}}),t,null,[[3,15]])})));return function(e){return t.apply(this,arguments)}}()).catch((function(t){console.error("【头像缓存】加载头像失败: ".concat(e),t),r(null)})).finally((function(){t.loadingAvatars.delete(e)}))}))}},{key:"getBatchUserAvatars",value:function(e){var t=this;if(!e||0===e.length)return Promise.resolve({});var r={},n=[];return e.forEach((function(e){var t=g.get(e);t?r[e]=t:n.push(e)})),n.length>0?(console.log("【头像缓存】批量加载头像: ".concat(n.length,"个")),new Promise((function(e){t.callCloudFunction("getBatchUserProfiles",{userIds:n}).then(function(){var t=c(l().mark((function t(n){var o,c,s,u,i;return l().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!(n.result&&n.result.success&&n.result.userProfiles)){t.next=35;break}o=a(n.result.userProfiles),t.prev=2,o.s();case 4:if((c=o.n()).done){t.next=27;break}if(s=c.value,!s||!s._openid){t.next=25;break}if(u=s.avatarUrl,t.prev=8,"string"!==typeof u||!u.startsWith("cloud://")){t.next=18;break}if(!f||!f.getTempUrl){t.next=16;break}return t.next=13,f.getTempUrl(u);case 13:t.t0=t.sent,t.next=17;break;case 16:t.t0=u;case 17:u=t.t0;case 18:t.next=22;break;case 20:t.prev=20,t.t1=t["catch"](8);case 22:i={avatarUrl:u,nickName:s.nickName,bio:s.bio,lastUpdated:Date.now()},r[s._openid]=i,g.set(s._openid,i,{ttlMs:864e5});case 25:t.next=4;break;case 27:t.next=32;break;case 29:t.prev=29,t.t2=t["catch"](2),o.e(t.t2);case 32:return t.prev=32,o.f(),t.finish(32);case 35:e(r);case 36:case"end":return t.stop()}}),t,null,[[2,29,32,35],[8,20]])})));return function(e){return t.apply(this,arguments)}}()).catch((function(t){console.error("【头像缓存】批量加载失败:",t),e(r)}))}))):Promise.resolve(r)}},{key:"preloadAvatarsFromPosts",value:function(e){var t=this;if(e&&0!==e.length){var r=o(new Set(e.map((function(e){return e._openid})).filter(Boolean)));0!==r.length&&setTimeout((function(){t.getBatchUserAvatars(r).then((function(e){console.log("【头像缓存】预加载完成: ".concat(Object.keys(e).length,"个头像"))}))}),100)}}},{key:"updateUserAvatar",value:function(e,t){if(!e||!t)return!1;var r=n(n({},t),{},{lastUpdated:Date.now()});try{return g.set(e,r,{ttlMs:864e5}),!0}catch(o){return!1}}},{key:"clearUserAvatar",value:function(e){if(!e)return!1;try{return g.delete(e),!0}catch(t){return!1}}},{key:"getDefaultAvatar",value:function(){return"/static/images/avatar.png"}}]),e}(),h=new p;e.exports=h},d189:function(e,t,r){var n=r("e2db"),o=r("2774"),a=r("79b7"),l=r("9376");e.exports=function(e){return n(e)||o(e)||a(e)||l()},e.exports.__esModule=!0,e.exports["default"]=e.exports},db04:function(e,t,r){"use strict";var n=r("bb80"),o=r("c435"),a=r("9e70"),l=r("f298"),c=r("862c"),s=n(l),u=n("".slice),i=Math.ceil,f=function(e){return function(t,r,n){var l,f,d=a(c(t)),v=o(r),g=d.length,p=void 0===n?" ":a(n);return v<=g||""===p?d:(l=v-g,f=s(p,i(l/p.length)),f.length>l&&(f=u(f,0,l)),e?d+f:f+d)}};e.exports={start:f(!1),end:f(!0)}},e2db:function(e,t,r){var n=r("e476");e.exports=function(e){if(Array.isArray(e))return n(e)},e.exports.__esModule=!0,e.exports["default"]=e.exports}}]);