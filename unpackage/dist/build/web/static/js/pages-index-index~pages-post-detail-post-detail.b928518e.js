(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-index-index~pages-post-detail-post-detail"],{"0123":function(e,t,r){var n=r("5014").default,o=r("d189").default,a=r("4cf1").default,l=r("dd7e").default,s=r("46c5").default,c=r("883d").default,i=r("4db6").default;r("bf0f"),r("f3f7"),r("18f7"),r("de6c"),r("9db6"),r("2797"),r("aa9c"),r("8f71"),r("fd3c"),r("dc8a");var u=r("7ef8").default,f=r("9384").default||r("9384"),d=r("38db"),g=d.cloudCall,v=u.namespace("avatars",{persistent:!0,maxItems:2048}),h=function(){"use strict";function e(){c(this,e),this.loadingAvatars=new Set}return i(e,[{key:"callCloudFunction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return g(e,t,{pageTag:"avatarCache"})}},{key:"getUserAvatar",value:function(e){if(!e)return Promise.resolve(null);var t=v.get(e);return t?(console.log("【头像缓存】命中缓存: ".concat(e)),Promise.resolve(t)):this.loadingAvatars.has(e)?(console.log("【头像缓存】正在加载中，等待: ".concat(e)),this.waitForAvatarLoad(e)):this.loadUserAvatar(e)}},{key:"waitForAvatarLoad",value:function(e){var t=this;return new Promise((function(r){var n=setInterval((function(){if(!t.loadingAvatars.has(e)){clearInterval(n);var o=v.get(e);r(o)}}),100);setTimeout((function(){clearInterval(n),t.loadingAvatars.delete(e),r(null)}),5e3)}))}},{key:"loadUserAvatar",value:function(e){var t=this;return this.loadingAvatars.add(e),console.log("【头像缓存】开始加载头像: ".concat(e)),new Promise((function(r){t.callCloudFunction("getUserProfile",{userId:e}).then(function(){var t=s(l().mark((function t(n){var o,a,s;return l().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!(n.result&&n.result.success&&n.result.userInfo)){t.next=23;break}if(o=n.result.userInfo,a=o.avatarUrl,t.prev=3,"string"!==typeof a||!a.startsWith("cloud://")){t.next=13;break}if(!f||!f.getTempUrl){t.next=11;break}return t.next=8,f.getTempUrl(a);case 8:t.t0=t.sent,t.next=12;break;case 11:t.t0=a;case 12:a=t.t0;case 13:t.next=17;break;case 15:t.prev=15,t.t1=t["catch"](3);case 17:s={avatarUrl:a,nickName:o.nickName,bio:o.bio,lastUpdated:Date.now()},v.set(e,s,{ttlMs:864e5}),console.log("【头像缓存】加载并缓存成功: ".concat(e)),r(s),t.next=25;break;case 23:console.warn("【头像缓存】获取用户信息失败: ".concat(e),n.result),r(null);case 25:case"end":return t.stop()}}),t,null,[[3,15]])})));return function(e){return t.apply(this,arguments)}}()).catch((function(t){console.error("【头像缓存】加载头像失败: ".concat(e),t),r(null)})).finally((function(){t.loadingAvatars.delete(e)}))}))}},{key:"getBatchUserAvatars",value:function(e){var t=this;if(!e||0===e.length)return Promise.resolve({});var r={},n=[];return e.forEach((function(e){var t=v.get(e);t?r[e]=t:n.push(e)})),n.length>0?(console.log("【头像缓存】批量加载头像: ".concat(n.length,"个")),new Promise((function(e){t.callCloudFunction("getBatchUserProfiles",{userIds:n}).then(function(){var t=s(l().mark((function t(n){var o,s,c,i,u;return l().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!(n.result&&n.result.success&&n.result.userProfiles)){t.next=35;break}o=a(n.result.userProfiles),t.prev=2,o.s();case 4:if((s=o.n()).done){t.next=27;break}if(c=s.value,!c||!c._openid){t.next=25;break}if(i=c.avatarUrl,t.prev=8,"string"!==typeof i||!i.startsWith("cloud://")){t.next=18;break}if(!f||!f.getTempUrl){t.next=16;break}return t.next=13,f.getTempUrl(i);case 13:t.t0=t.sent,t.next=17;break;case 16:t.t0=i;case 17:i=t.t0;case 18:t.next=22;break;case 20:t.prev=20,t.t1=t["catch"](8);case 22:u={avatarUrl:i,nickName:c.nickName,bio:c.bio,lastUpdated:Date.now()},r[c._openid]=u,v.set(c._openid,u,{ttlMs:864e5});case 25:t.next=4;break;case 27:t.next=32;break;case 29:t.prev=29,t.t2=t["catch"](2),o.e(t.t2);case 32:return t.prev=32,o.f(),t.finish(32);case 35:e(r);case 36:case"end":return t.stop()}}),t,null,[[2,29,32,35],[8,20]])})));return function(e){return t.apply(this,arguments)}}()).catch((function(t){console.error("【头像缓存】批量加载失败:",t),e(r)}))}))):Promise.resolve(r)}},{key:"preloadAvatarsFromPosts",value:function(e){var t=this;if(e&&0!==e.length){var r=o(new Set(e.map((function(e){return e._openid})).filter(Boolean)));0!==r.length&&setTimeout((function(){t.getBatchUserAvatars(r).then((function(e){console.log("【头像缓存】预加载完成: ".concat(Object.keys(e).length,"个头像"))}))}),100)}}},{key:"updateUserAvatar",value:function(e,t){if(!e||!t)return!1;var r=n(n({},t),{},{lastUpdated:Date.now()});try{return v.set(e,r,{ttlMs:864e5}),!0}catch(o){return!1}}},{key:"clearUserAvatar",value:function(e){if(!e)return!1;try{return v.delete(e),!0}catch(t){return!1}}},{key:"getDefaultAvatar",value:function(){return"/static/images/avatar.png"}}]),e}(),p=new h;e.exports=p},"05ef":function(e,t,r){"use strict";r("6a54");var n=r("f5bd").default;Object.defineProperty(t,"__esModule",{value:!0}),t.hydrateTempUrls=function(){return c.apply(this,arguments)},t.warmTempUrlsFromPosts=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=new Set;e.forEach((function(e){return s(e).forEach((function(e){return t.add(e)}))})),t.size>0&&l.default.warm(Array.from(t))};var o=n(r("2634")),a=n(r("2fdc"));r("9db6"),r("aa9c"),r("bf0f"),r("2797"),r("f3f7"),r("18f7"),r("de6c"),r("08eb"),r("fd3c");var l=n(r("9384"));function s(e){var t=[],r=function(e){"string"===typeof e&&e.startsWith("cloud://")&&t.push(e)};return r(e.imageUrl),r(e.originalImageUrl),r(e.authorAvatar),r(e.poemBgImage),Array.isArray(e.imageUrls)&&e.imageUrls.forEach(r),Array.isArray(e.originalImageUrls)&&e.originalImageUrls.forEach(r),t}function c(){return c=(0,a.default)((0,o.default)().mark((function e(){var t,r,n,a,c=arguments;return(0,o.default)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t=c.length>0&&void 0!==c[0]?c[0]:[],Array.isArray(t)&&0!==t.length){e.next=3;break}return e.abrupt("return",t);case 3:if(r=new Set,t.forEach((function(e){return s(e).forEach((function(e){return r.add(e)}))})),0!==r.size){e.next=7;break}return e.abrupt("return",t);case 7:return e.next=9,l.default.getTempUrls(Array.from(r));case 9:return n=e.sent,a=function(e){return"string"===typeof e&&n[e]?n[e]:e},t.forEach((function(e){e.imageUrl&&(e.imageUrl=a(e.imageUrl)),e.originalImageUrl&&(e.originalImageUrl=a(e.originalImageUrl)),e.authorAvatar&&(e.authorAvatar=a(e.authorAvatar)),e.poemBgImage&&(e.poemBgImage=a(e.poemBgImage)),Array.isArray(e.imageUrls)&&(e.imageUrls=e.imageUrls.map(a)),Array.isArray(e.originalImageUrls)&&(e.originalImageUrls=e.originalImageUrls.map(a))})),e.abrupt("return",t);case 13:case"end":return e.stop()}}),e)}))),c.apply(this,arguments)}},"4db6":function(e,t,r){r("6a54");var n=r("8bcf");function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,n(o.key),o)}}e.exports=function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e},e.exports.__esModule=!0,e.exports["default"]=e.exports},"7cd7":function(e,t,r){var n=r("dd7e").default,o=r("46c5").default;r("64aa"),r("dc8a"),r("8f71"),r("bf0f"),r("9db6"),r("2797"),r("de6c"),r("7a76"),r("c9b5");var a=r("38db"),l=a.cloudCall,s=r("9167"),c=r("7ef8").default;function i(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=Number(e);return Number.isFinite(r)?r:t}function u(e,t,r){if("function"===typeof e)try{return e(t,r)}catch(n){console.warn("[likeService] likeIcon resolver 执行失败",n)}return s.getLikeIcon(t,r)}function f(e){var t=e.votes,r=e.isLiked,n=e.icon;return{votes:t,isLiked:r,likeIcon:n}}function d(e,t,r,n){try{if(!e)return;var o=c.getStats?c.getStats():{},a=Object.keys(o),l=a.filter((function(e){return"posts:home"===e||"posts:discover"===e||e.startsWith("posts:tag:")||e.startsWith("me:posts")||e.startsWith("userPosts:")}));l.forEach((function(o){try{var a=c.namespace(o),l=a.keys&&a.keys()||[];l.forEach((function(o){try{a.update(o,(function(o){if(!Array.isArray(o))return o;for(var a=0;a<o.length;a+=1){var l=o[a];!l||l._id!==e&&l.id!==e||(l.votes=t,l.isVoted=r,l.likeIcon=n,!0)}return o}))}catch(l){}}))}catch(s){}}))}catch(s){console.warn("[likeService] updatePostInCaches failed",s)}}function g(e){if("undefined"!==typeof uni&&"function"===typeof uni.showToast)try{uni.showToast({title:e||"操作失败，请稍后重试",icon:"none"})}catch(t){console.warn("[likeService] showToast 调用失败",t)}}function v(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.pageTag,r=void 0===t?"like-service":t,n=e.context,o=void 0===n?null:n,a=e.currentVotes,l=void 0===a?0:a,c=e.currentIsLiked,u=void 0!==c&&c,f=e.likeIconResolver,d=void 0===f?s.getLikeIcon:f,g=e.requireAuth,v=void 0===g||g,h=e.retry,p=void 0===h?0:h,w=e.updateCache,m=void 0===w||w,k=e.showErrorToast,y=void 0===k||k,b=e.cloudOptions,F=void 0===b?{}:b;return{pageTag:r,context:o,currentVotes:i(l,0),currentIsLiked:Boolean(u),likeIconResolver:d,requireAuth:v,retry:p,updateCache:m,showErrorToast:y,cloudOptions:F}}function h(){return h=o(n().mark((function e(t){var r,o,a,s,c,h,p,w,m,k,y,b,F,U,I,x,A,S,_,P,C,T,B,E=arguments;return n().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=E.length>1&&void 0!==E[1]?E[1]:{},t){e.next=3;break}return e.abrupt("return",Promise.reject(new Error("[likeService] postId 不能为空")));case 3:return o=v(r),a=o.pageTag,s=o.context,c=o.currentVotes,h=o.currentIsLiked,p=o.likeIconResolver,w=o.requireAuth,m=o.retry,k=o.updateCache,y=o.showErrorToast,b=o.cloudOptions,F=i(c,0),U=Boolean(h),I=u(p,F,U),x=f({votes:F,isLiked:U,icon:I}),e.prev=8,e.next=11,l("vote",{postId:t},Object.assign({pageTag:"likeService:".concat(a),context:s,requireAuth:w,retry:m},b));case 11:A=e.sent,e.next=19;break;case 14:return e.prev=14,e.t0=e["catch"](8),console.error("[likeService] 调用云函数失败",e.t0),y&&g(e.t0&&e.t0.message),e.abrupt("return",{success:!1,error:e.t0,rollback:x});case 19:if(S=A&&A.result?A.result:A,_=S&&!0===S.success,_){e.next=26;break}return P=S&&S.message?S.message:"操作失败，请稍后重试",console.warn("[likeService] 云函数返回失败结果",S),y&&g(P),e.abrupt("return",{success:!1,error:S,rollback:x});case 26:return C=i(S.votes,F),T=Boolean(S.isLiked),B=u(p,C,T),k&&d(t,C,T,B),e.abrupt("return",{success:!0,votes:C,isLiked:T,likeIcon:B,response:S});case 31:case"end":return e.stop()}}),e,null,[[8,14]])}))),h.apply(this,arguments)}e.exports={togglePostLike:function(e){return h.apply(this,arguments)}}},"883d":function(e,t,r){r("7a76"),r("c9b5"),e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.__esModule=!0,e.exports["default"]=e.exports},9167:function(e,t){e.exports={getLikeIcon:function(e,t){var r="";return r=e<=3?t?"seedplus.png":"seed.png":e<=7?t?"leafplus.png":"leaf.png":e<=15?t?"flowerplus .png":"flower.png":t?"peachplus.png":"peach.png","/static/images/"+r},getLikeIconDescription:function(e){return e<=3?"种子":e<=7?"叶子":e<=15?"花":"果实"}}},acbf:function(e,t,r){var n=r("5014").default,o=r("d189").default,a=r("883d").default,l=r("4db6").default;r("bf0f"),r("f3f7"),r("18f7"),r("de6c"),r("c223"),r("2797"),r("aa9c"),r("8f71"),r("fd3c"),r("dc8a"),r("9db6"),r("9327");var s=r("7ef8").default,c=r("38db"),i=c.cloudCall;function u(e){return s.namespace("follow:".concat(e),{persistent:!0,maxItems:4e3})}var f=function(){"use strict";function e(){a(this,e),this.loadingFollows=new Set}return l(e,[{key:"callCloudFunction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return i(e,t,{pageTag:"followCache",requireAuth:!0})}},{key:"getFollowStatus",value:function(e,t){if(!e||!t||e===t)return Promise.resolve(null);var r=u(e).get(t);return r?(console.log("【关注缓存】命中缓存: ".concat(e," -> ").concat(t)),Promise.resolve(r)):this.loadingFollows.has("".concat(e,"_").concat(t))?(console.log("【关注缓存】正在加载中，等待: ".concat(e," -> ").concat(t)),this.waitForFollowLoad(e,t)):this.loadFollowStatus(e,t)}},{key:"waitForFollowLoad",value:function(e,t){var r=this;return new Promise((function(n){var o="".concat(e,"_").concat(t),a=setInterval((function(){if(!r.loadingFollows.has(o)){clearInterval(a);var l=u(e).get(t);n(l)}}),100);setTimeout((function(){clearInterval(a),r.loadingFollows.delete(o),n(null)}),3e3)}))}},{key:"loadFollowStatus",value:function(e,t){var r=this,n="".concat(e,"_").concat(t);return this.loadingFollows.add(n),console.log("【关注缓存】开始加载关注状态: ".concat(e," -> ").concat(t)),new Promise((function(o){r.callCloudFunction("follow",{action:"checkFollow",targetOpenid:t}).then((function(r){if(r.result&&r.result.success){var n={isFollowing:!!r.result.isFollowing,isFollowedByAuthor:!!r.result.isFollower,isMutualFollow:!!r.result.isMutual,lastUpdated:Date.now()};u(e).set(t,n,{ttlMs:36e5}),console.log("【关注缓存】加载并缓存成功: ".concat(e," -> ").concat(t),n),o(n)}else console.warn("【关注缓存】获取关注状态失败: ".concat(e," -> ").concat(t),r.result),o(null)})).catch((function(r){console.error("【关注缓存】加载关注状态失败: ".concat(e," -> ").concat(t),r),o(null)})).finally((function(){r.loadingFollows.delete(n)}))}))}},{key:"getBatchFollowStatus",value:function(e,t){var r=this;if(!e||!t||0===t.length)return Promise.resolve({});var n={},o=[];return t.forEach((function(t){if(t!==e){var r=u(e).get(t);r?n[t]=r:o.push(t)}})),o.length>0?(console.log("【关注缓存】批量加载关注状态: ".concat(o.length,"个")),new Promise((function(t){r.callCloudFunction("getBatchFollowStatus",{currentUserId:e,targetUserIds:o}).then((function(r){r.result&&r.result.success&&r.result.followStatuses&&r.result.followStatuses.forEach((function(t){if(t&&t.targetUserId){var r={isFollowing:!!t.isFollowing,isFollowedByAuthor:!!t.isFollowedByAuthor,isMutualFollow:!!t.isMutualFollow,lastUpdated:Date.now()};n[t.targetUserId]=r,u(e).set(t.targetUserId,r,{ttlMs:36e5})}})),t(n)})).catch((function(e){console.error("【关注缓存】批量加载失败:",e),t(n)}))}))):Promise.resolve(n)}},{key:"preloadFollowStatusFromPosts",value:function(e,t){var r=this;if(e&&0!==e.length&&t){var n=o(new Set(e.map((function(e){return e._openid})).filter((function(e){return e&&e!==t}))));0!==n.length&&setTimeout((function(){r.getBatchFollowStatus(t,n).then((function(e){console.log("【关注缓存】预加载完成: ".concat(Object.keys(e).length,"个关注状态"))}))}),100)}}},{key:"updateFollowStatus",value:function(e,t,r){if(!e||!t||!r)return!1;var o=n(n({},r),{},{lastUpdated:Date.now()});try{return u(e).set(t,o,{ttlMs:36e5}),!0}catch(a){return!1}}},{key:"toggleFollowStatus",value:function(e,t){var r=this;return e&&t&&e!==t?new Promise((function(n){r.callCloudFunction("follow",{action:"toggleFollow",targetOpenid:t}).then((function(o){if(o.result&&o.result.success){var a={isFollowing:!!o.result.isFollowing,isFollowedByAuthor:!!o.result.isFollower,isMutualFollow:!!o.result.isMutual,lastUpdated:Date.now()};r.updateFollowStatus(e,t,a),console.log("【关注缓存】切换关注状态成功: ".concat(e," -> ").concat(t),a),n(a)}else console.warn("【关注缓存】切换关注状态失败: ".concat(e," -> ").concat(t),o.result),n(null)})).catch((function(r){console.error("【关注缓存】切换关注状态失败: ".concat(e," -> ").concat(t),r),n(null)}))})):Promise.resolve(null)}},{key:"clearUserFollowCache",value:function(e){if(!e)return!1;try{return u(e).clear(),!0}catch(t){return console.log("CatchClause",t),console.log("CatchClause",t),console.error("清理用户关注缓存失败:",t),!1}}},{key:"clearAllFollowCache",value:function(){try{var e=uni.getStorageInfoSync&&uni.getStorageInfoSync(),t=e&&e.keys||[];return t.forEach((function(e){if("string"===typeof e&&e.startsWith("__cm__:follow:")&&e.endsWith(":__keys__")){var t=e.substring("__cm__:".length,e.length-":__keys__".length);try{s.namespace(t,{persistent:!0}).clear()}catch(r){}}})),!0}catch(r){return console.log("CatchClause",r),console.log("CatchClause",r),console.error("清理所有关注缓存失败:",r),!1}}}]),e}(),d=new f;e.exports=d}}]);