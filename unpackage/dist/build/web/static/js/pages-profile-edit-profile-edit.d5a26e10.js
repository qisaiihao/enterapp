(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-profile-edit-profile-edit"],{"0904":function(n,t,e){"use strict";e.r(t);var a=e("84a8"),i=e("38d9");for(var o in i)["default"].indexOf(o)<0&&function(n){e.d(t,n,(function(){return i[n]}))}(o);e("b4bc");var r=e("828b"),s=Object(r["a"])(i["default"],a["b"],a["c"],!1,null,"255b13e6",null,!1,a["a"],void 0);t["default"]=s.exports},"38d9":function(n,t,e){"use strict";e.r(t);var a=e("4e8e"),i=e.n(a);for(var o in a)["default"].indexOf(o)<0&&function(n){e.d(t,n,(function(){return a[n]}))}(o);t["default"]=i.a},"4e8e":function(n,t,e){"use strict";e("6a54");var a=e("f5bd").default;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(e("5de6"));e("795c"),e("c9b5"),e("bf0f"),e("ab80"),e("c223"),e("7a76"),e("4626"),e("5ac7"),e("5c47"),e("18f7"),e("de6c");getApp();var o=e("7ab1"),r=o.compressAvatar,s=e("11ca"),c=s.cloudCall,l={data:function(){return{avatarUrl:"",nickName:"",birthday:"",bio:"",endDate:"",isSaving:!1,tempAvatarPath:null,signatureUrl:"",signaturePreview:"",signatureTempPath:null,isProcessingSignature:!1}},onLoad:function(n){this.fetchUserProfile();var t=new Date,e=t.getFullYear()+"-"+(t.getMonth()+1).toString().padStart(2,"0")+"-"+t.getDate().toString().padStart(2,"0");this.setData({endDate:e})},methods:{callCloudFunction:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return c(n,t,Object.assign({pageTag:"profile-edit",context:this,requireAuth:!0},e))},uploadFile:function(n,t){return console.log("🔍 [ProfileEdit] 上传文件: ".concat(n),t),new Promise((function(a,i){var o=e("fd09"),r=o.getCurrentPlatform,s=o.getCloudFunctionMethod,c=r(),l=s();if(console.log("🔍 [ProfileEdit] 运行环境: ".concat(c,", 调用方式: ").concat(l)),"tcb"===l){var u=getApp();u&&u.$tcb&&u.$tcb.uploadFile?(console.log("🔍 [ProfileEdit] ".concat(c,"环境使用TCB上传文件: ").concat(n)),u.$tcb.uploadFile({cloudPath:n,filePath:t}).then(a).catch(i)):(console.error("❌ [ProfileEdit] ".concat(c,"环境TCB不可用")),console.error("❌ [ProfileEdit] app:",u),console.error("❌ [ProfileEdit] app.$tcb:",u&&u.$tcb),i(new Error("TCB实例不可用")))}else"wx-cloud"===l?wx.cloud&&wx.cloud.uploadFile?(console.log("🔍 [ProfileEdit] 小程序环境使用微信云开发上传文件: ".concat(n)),wx.cloud.uploadFile({cloudPath:n,filePath:t,success:function(t){console.log("✅ [ProfileEdit] 文件上传成功: ".concat(n),t),a(t)},fail:function(t){console.error("❌ [ProfileEdit] 文件上传失败: ".concat(n),t),i(t)}})):(console.error("❌ [ProfileEdit] 小程序环境微信云开发不可用"),i(new Error("微信云开发不可用"))):(console.error("❌ [ProfileEdit] 不支持的云函数调用方式: ".concat(l)),i(new Error("不支持的云函数调用方式: ".concat(l))))}))},fetchUserProfile:function(){var n=this;this.callCloudFunction("getMyProfileData",{}).then((function(t){if(t.result&&t.result.success&&t.result.userInfo){var e=t.result.userInfo;n.setData({avatarUrl:e.avatarUrl||"",nickName:e.nickName||"",birthday:e.birthday||"",bio:e.bio||"",signatureUrl:e.signatureUrl||"",signaturePreview:e.signatureUrl||"",signatureTempPath:null})}else uni.showToast({title:"加载失败",icon:"none"})})).catch((function(n){console.error("获取用户资料失败:",n),uni.showToast({title:"加载失败",icon:"none"})}))},onChooseAvatar:function(n){var t=this;console.log("🔍 [ProfileEdit] 开始选择头像...");var a=e("fd09"),i=a.getCurrentPlatform,o=i();if(console.log("🔍 [ProfileEdit] 当前平台: ".concat(o)),"mp-weixin"===o&&n.detail&&n.detail.avatarUrl){var r=n.detail.avatarUrl;console.log("🔍 [ProfileEdit] 微信小程序选择头像，原始路径:",r),this.processAvatar(r)}else console.log("🔍 [ProfileEdit] H5/App环境，使用uni.chooseImage选择头像"),uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:function(n){var e=n.tempFilePaths[0];console.log("🔍 [ProfileEdit] 选择头像成功，原始路径:",e),t.processAvatar(e)},fail:function(n){console.error("🔍 [ProfileEdit] 选择头像失败:",n),uni.showToast({title:"选择头像失败",icon:"none"})}})},processAvatar:function(n){var t=this;console.log("🔍 [ProfileEdit] 开始处理头像:",n),uni.showLoading({title:"压缩头像中..."}),r(n).then((function(n){console.log("✅ [ProfileEdit] 头像压缩完成，压缩后路径:",n),t.setData({avatarUrl:n,tempAvatarPath:n}),uni.hideLoading(),uni.showToast({title:"头像压缩完成",icon:"success",duration:1500})})).catch((function(e){console.error("❌ [ProfileEdit] 头像压缩失败:",e),t.setData({avatarUrl:n,tempAvatarPath:n}),uni.hideLoading(),uni.showToast({title:"压缩失败，使用原图",icon:"none",duration:2e3})}))},onChooseSignature:function(){var n=this;if(!this.isProcessingSignature){var t=function(t){t?n.processSignatureImage(t):uni.showToast({title:"未选择图片",icon:"none"})},e={count:1,mediaType:["image"],sourceType:["album","camera"],success:function(n){var e=n.tempFiles&&n.tempFiles[0];t(e&&(e.tempFilePath||e.filePath))},fail:function(n){n&&n.errMsg&&n.errMsg.includes("cancel")||uni.showToast({title:"选择图片失败",icon:"none"})}};uni.chooseMedia?uni.chooseMedia(e):uni.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(n){return t(n.tempFilePaths&&n.tempFilePaths[0])},fail:function(n){n&&n.errMsg&&n.errMsg.includes("cancel")||uni.showToast({title:"选择图片失败",icon:"none"})}})}},processSignatureImage:function(n){var t=this;uni.showLoading({title:"处理中...",mask:!0}),this.setData({isProcessingSignature:!0}),uni.createSelectorQuery().in(uni).select("#signatureCanvas").node().exec((function(e){var a=e&&e[0]&&e[0].node;if(!a)return uni.hideLoading(),uni.showToast({title:"获取画布失败",icon:"none"}),void t.setData({isProcessingSignature:!1});var i=a,o=i.getContext("2d"),r=i.createImage();r.src=n,r.onload=function(){var n=r.width,e=r.height,a=Math.min(1,800/Math.max(n,e)),s=Math.max(1,Math.round(n*a)),c=Math.max(1,Math.round(e*a));i.width=s,i.height=c,o.clearRect(0,0,s,c),o.drawImage(r,0,0,s,c);try{for(var l=o.getImageData(0,0,s,c),u=l.data,d=0;d<u.length;d+=4){var h=u[d],f=u[d+1],g=u[d+2],v=(h+f+g)/3,p=Math.max(Math.abs(h-f),Math.abs(h-g),Math.abs(f-g));v>235&&p<25?u[d+3]=0:v>220&&p<30&&(u[d+3]=Math.min(u[d+3],120))}o.putImageData(l,0,0)}catch(m){return console.log("CatchClause",m),console.log("CatchClause",m),console.error("签名像素处理失败:",m),uni.hideLoading(),uni.showToast({title:"处理失败",icon:"none"}),void t.setData({isProcessingSignature:!1})}uni.canvasToTempFilePath({canvas:i,x:0,y:0,width:s,height:c,destWidth:s,destHeight:c,fileType:"png",success:function(n){uni.hideLoading(),uni.showToast({title:"签名已优化",icon:"success",duration:1500}),t.setData({signaturePreview:n.tempFilePath,signatureTempPath:n.tempFilePath,signatureUrl:""})},fail:function(n){console.error("导出签名失败:",n),uni.hideLoading(),uni.showToast({title:"导出失败",icon:"none"})},complete:function(){t.setData({isProcessingSignature:!1})}})},r.onerror=function(n){console.error("签名图片加载失败:",n),uni.hideLoading(),uni.showToast({title:"图片加载失败",icon:"none"}),t.setData({isProcessingSignature:!1})}}))},onNicknameInput:function(n){this.setData({nickName:n.detail.value})},onBirthdayChange:function(n){this.setData({birthday:n.detail.value})},onBioInput:function(n){this.setData({bio:n.detail.value})},onSaveChanges:function(){var n=this;if(!this.isSaving&&!this.isProcessingSignature){this.setData({isSaving:!0}),uni.showLoading({title:"保存中...",mask:!0});var t=this.tempAvatarPath?this.uploadFile("user_avatars/".concat(Date.now(),"_").concat(Math.floor(1e3*Math.random())),this.tempAvatarPath):Promise.resolve(null),e=this.signatureTempPath?this.uploadFile("user_signatures/".concat(Date.now(),"_").concat(Math.floor(1e3*Math.random()),".png"),this.signatureTempPath):Promise.resolve(null);Promise.all([t,e]).then((function(t){var e=(0,i.default)(t,2),a=e[0],o=e[1];return n.callCloudFunction("updateUserProfile",{avatarUrl:a,nickName:n.nickName,birthday:n.birthday,bio:n.bio,signatureUrl:o})})).then((function(n){if(!n.result.success)throw new Error(n.result.message||"云函数保存失败");uni.hideLoading(),uni.showToast({title:"保存成功"});var t=getCurrentPages();if(t.length>1){var e=t[t.length-2];e&&"function"===typeof e.fetchUserProfile&&e.fetchUserProfile()}setTimeout((function(){return uni.navigateBack()}),1e3)})).catch((function(n){console.error("保存资料失败:",n),uni.hideLoading(),uni.showToast({title:n.message||"操作失败",icon:"none"})})).finally((function(){n.setData({isSaving:!1})}))}}}};t.default=l},"4f60":function(n,t,e){var a=e("dbeb");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[n.i,a,""]]),a.locals&&(n.exports=a.locals);var i=e("967d").default;i("01325704",a,!0,{sourceMap:!1,shadowMode:!1})},"73e1":function(n,t,e){"use strict";var a=e("29d8");n.exports=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(a)},"795c":function(n,t,e){"use strict";var a=e("8bdb"),i=e("db04").start,o=e("73e1");a({target:"String",proto:!0,forced:o},{padStart:function(n){return i(this,n,arguments.length>1?arguments[1]:void 0)}})},"7ab1":function(n,t,e){e("bf0f"),e("5c47"),e("0506"),n.exports={compressAvatar:function(n){return new Promise((function(t,e){uni.getSystemInfo({success:function(a){a.pixelRatio;var i=a.system,o=/(ios)/gi.test(i),r={maxWidth:200,maxHeight:200,quality:o?.3:.2,maxSize:51200};console.log("开始压缩头像，原始路径:",n),console.log("压缩配置:",r),uni.getImageInfo({src:n,success:function(a){console.log("原始图片信息:",{width:a.width,height:a.height,path:a.path});var i=a.width,o=a.height,s=r.maxWidth,c=r.maxHeight;if(i>s||o>c){var l=Math.min(s/i,c/o);i=Math.floor(i*l),o=Math.floor(o*l)}console.log("压缩后尺寸:",{width:i,height:o});var u=uni.createCanvasContext("avatarCompressCanvas");u.drawImage(n,0,0,i,o),u.draw(!1,(function(){uni.canvasToTempFilePath({canvasId:"avatarCompressCanvas",x:0,y:0,width:i,height:o,destWidth:i,destHeight:o,fileType:"jpg",quality:r.quality,success:function(n){console.log("Canvas压缩完成，临时文件:",n.tempFilePath),uni.getFileInfo({filePath:n.tempFilePath,success:function(e){console.log("压缩后文件大小:",(e.size/1024).toFixed(2),"KB"),e.size>r.maxSize?(console.log("文件仍然过大，使用wx.compressImage进一步压缩"),uni.compressImage({src:n.tempFilePath,quality:.1,success:function(n){console.log("最终压缩完成:",n.tempFilePath),t(n.tempFilePath)},fail:function(e){console.error("wx.compressImage压缩失败:",e),t(n.tempFilePath)}})):t(n.tempFilePath)},fail:function(e){console.error("获取压缩后文件信息失败:",e),t(n.tempFilePath)}})},fail:function(a){console.error("Canvas压缩失败:",a),uni.compressImage({src:n,quality:r.quality,success:function(n){console.log("备选压缩完成:",n.tempFilePath),t(n.tempFilePath)},fail:function(n){console.error("备选压缩也失败:",n),e(n)}})}})}))},fail:function(a){console.error("获取图片信息失败:",a),uni.compressImage({src:n,quality:r.quality,success:function(n){console.log("直接压缩完成:",n.tempFilePath),t(n.tempFilePath)},fail:function(n){console.error("直接压缩失败:",n),e(n)}})}})},fail:function(n){console.error("获取系统信息失败:",n),e(n)}})}))},createAvatarCompressCanvas:function(){}}},"84a8":function(n,t,e){"use strict";e.d(t,"b",(function(){return a})),e.d(t,"c",(function(){return i})),e.d(t,"a",(function(){}));var a=function(){var n=this,t=n.$createElement,e=n._self._c||t;return e("v-uni-view",[e("v-uni-view",{staticClass:"container"},[e("v-uni-view",{staticClass:"form-group"},[e("v-uni-view",{staticClass:"label"},[n._v("头像")]),e("v-uni-button",{staticClass:"avatar-wrapper",on:{click:function(t){arguments[0]=t=n.$handleEvent(t),n.onChooseAvatar.apply(void 0,arguments)}}},[e("v-uni-image",{staticClass:"avatar-preview",attrs:{src:n.avatarUrl||"/static/images/avatar.png"}}),n.avatarUrl?n._e():e("v-uni-view",{staticClass:"avatar-placeholder"},[e("v-uni-text",{staticClass:"avatar-placeholder-text"},[n._v("点击选择头像")])],1)],1)],1),e("v-uni-view",{staticClass:"form-group-column signature-section"},[e("v-uni-label",{staticClass:"label"},[n._v("手写签名")]),e("v-uni-view",{staticClass:"signature-actions"},[e("v-uni-button",{staticClass:"signature-upload-btn",attrs:{loading:n.isProcessingSignature,disabled:n.isProcessingSignature},on:{click:function(t){arguments[0]=t=n.$handleEvent(t),n.onChooseSignature.apply(void 0,arguments)}}},[n._v("上传签名图片")])],1),e("v-uni-view",{staticClass:"signature-tip"},[n._v("请上传白底黑字签名，系统会自动去除白色背景并生成透明PNG。")]),n.signaturePreview?e("v-uni-image",{staticClass:"signature-preview",attrs:{src:n.signaturePreview,mode:"aspectFit"}}):n._e()],1),e("v-uni-view",{staticClass:"form-group"},[e("v-uni-label",{staticClass:"label",attrs:{for:"nickname"}},[n._v("昵称")]),e("v-uni-input",{staticClass:"input",attrs:{id:"nickname",type:"nickname",placeholder:"请输入昵称",value:n.nickName},on:{input:function(t){arguments[0]=t=n.$handleEvent(t),n.onNicknameInput.apply(void 0,arguments)}}})],1),e("v-uni-view",{staticClass:"form-group"},[e("v-uni-label",{staticClass:"label"},[n._v("生日")]),e("v-uni-picker",{attrs:{mode:"date",value:n.birthday,start:"1920-01-01",end:n.endDate},on:{change:function(t){arguments[0]=t=n.$handleEvent(t),n.onBirthdayChange.apply(void 0,arguments)}}},[e("v-uni-view",{staticClass:"picker-display"},[n._v(n._s(n.birthday||"请选择您的生日"))])],1)],1),e("v-uni-view",{staticClass:"form-group-column"},[e("v-uni-label",{staticClass:"label"},[n._v("个性签名")]),e("v-uni-textarea",{staticClass:"textarea",attrs:{placeholder:"介绍一下自己吧...",value:n.bio,maxlength:"100"},on:{input:function(t){arguments[0]=t=n.$handleEvent(t),n.onBioInput.apply(void 0,arguments)}}})],1),e("v-uni-button",{staticClass:"save-button",attrs:{loading:n.isSaving},on:{click:function(t){arguments[0]=t=n.$handleEvent(t),n.onSaveChanges.apply(void 0,arguments)}}},[n._v("保存")])],1),e("v-uni-canvas",{staticStyle:{position:"fixed",top:"-9999px",left:"-9999px",width:"400px",height:"200px"},attrs:{type:"2d",id:"signatureCanvas"}}),e("v-uni-canvas",{staticStyle:{position:"fixed",top:"-9999px",left:"-9999px",width:"200px",height:"200px"},attrs:{"canvas-id":"avatarCompressCanvas"}})],1)},i=[]},b4bc:function(n,t,e){"use strict";var a=e("4f60"),i=e.n(a);i.a},db04:function(n,t,e){"use strict";var a=e("bb80"),i=e("c435"),o=e("9e70"),r=e("f298"),s=e("862c"),c=a(r),l=a("".slice),u=Math.ceil,d=function(n){return function(t,e,a){var r,d,h=o(s(t)),f=i(e),g=h.length,v=void 0===a?" ":o(a);return f<=g||""===v?h:(r=f-g,d=c(v,u(r/v.length)),d.length>r&&(d=l(d,0,r)),n?h+d:d+h)}};n.exports={start:d(!1),end:d(!0)}},dbeb:function(n,t,e){var a=e("c86c");t=a(!1),t.push([n.i,"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n/* pages/profile-edit/profile-edit.wxss */.container[data-v-255b13e6]{padding:%?30?%}.form-group[data-v-255b13e6],\n.form-group-column[data-v-255b13e6]{display:flex;align-items:center;padding:%?20?% 0;border-bottom:1px solid #f0f0f0}.form-group-column[data-v-255b13e6]{flex-direction:column;align-items:flex-start}.label[data-v-255b13e6]{width:%?180?%;font-size:%?32?%;color:#333;flex-shrink:0;margin-bottom:%?10?% /* For column layout */}.avatar-wrapper[data-v-255b13e6]{padding:0;margin:0;background:none;border:none;line-height:normal;width:%?120?%;height:%?120?%}.avatar-wrapper[data-v-255b13e6]::after{border:none}.avatar-preview[data-v-255b13e6]{width:%?120?%;height:%?120?%;border-radius:50%}.avatar-placeholder[data-v-255b13e6]{position:absolute;top:0;left:0;width:%?120?%;height:%?120?%;border-radius:50%;background-color:#f0f0f0;display:flex;align-items:center;justify-content:center;border:%?2?% dashed #ccc}.avatar-placeholder-text[data-v-255b13e6]{font-size:%?20?%;color:#999;text-align:center}.input[data-v-255b13e6],\n.picker-display[data-v-255b13e6],\n.textarea[data-v-255b13e6]{flex-grow:1;font-size:%?32?%;color:#555}.picker-display[data-v-255b13e6]{text-align:right}.textarea[data-v-255b13e6]{width:100%;height:%?150?%;padding:%?10?%;background-color:#f7f7f7;border-radius:%?10?%;margin-top:%?10?%}.save-button[data-v-255b13e6]{margin-top:%?60?%;background-color:#9ed7ee;color:#fff}.signature-section[data-v-255b13e6]{width:100%}.signature-actions[data-v-255b13e6]{display:flex;align-items:center;gap:%?20?%;width:100%}.signature-upload-btn[data-v-255b13e6]{background-color:#1c9bd6;color:#fff;border-radius:%?8?%;padding:0 %?30?%;height:%?72?%;line-height:%?72?%}.signature-upload-btn[data-v-255b13e6]::after{border:none}.signature-tip[data-v-255b13e6]{margin-top:%?12?%;font-size:%?24?%;color:#888}.signature-preview[data-v-255b13e6]{width:100%;max-height:%?260?%;margin-top:%?24?%;background:#f7f7f7;border-radius:%?12?%;padding:%?20?%;box-sizing:border-box}",""]),n.exports=t}}]);