(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-user-profile-user-profile"],{"0123":function(n,t,e){var r=e("5014").default,a=e("d189").default,o=e("4cf1").default,i=e("dd7e").default,s=e("46c5").default,l=e("883d").default,c=e("4db6").default;e("bf0f"),e("f3f7"),e("18f7"),e("de6c"),e("9db6"),e("2797"),e("aa9c"),e("8f71"),e("fd3c"),e("dc8a");var u=e("7ef8").default,d=e("9384").default||e("9384"),f=e("38db"),g=f.cloudCall,v=u.namespace("avatars",{persistent:!0,maxItems:2048}),h=function(){"use strict";function n(){l(this,n),this.loadingAvatars=new Set}return c(n,[{key:"callCloudFunction",value:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return g(n,t,{pageTag:"avatarCache"})}},{key:"getUserAvatar",value:function(n){if(!n)return Promise.resolve(null);var t=v.get(n);return t?(console.log("【头像缓存】命中缓存: ".concat(n)),Promise.resolve(t)):this.loadingAvatars.has(n)?(console.log("【头像缓存】正在加载中，等待: ".concat(n)),this.waitForAvatarLoad(n)):this.loadUserAvatar(n)}},{key:"waitForAvatarLoad",value:function(n){var t=this;return new Promise((function(e){var r=setInterval((function(){if(!t.loadingAvatars.has(n)){clearInterval(r);var a=v.get(n);e(a)}}),100);setTimeout((function(){clearInterval(r),t.loadingAvatars.delete(n),e(null)}),5e3)}))}},{key:"loadUserAvatar",value:function(n){var t=this;return this.loadingAvatars.add(n),console.log("【头像缓存】开始加载头像: ".concat(n)),new Promise((function(e){t.callCloudFunction("getUserProfile",{userId:n}).then(function(){var t=s(i().mark((function t(r){var a,o,s;return i().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!(r.result&&r.result.success&&r.result.userInfo)){t.next=23;break}if(a=r.result.userInfo,o=a.avatarUrl,t.prev=3,"string"!==typeof o||!o.startsWith("cloud://")){t.next=13;break}if(!d||!d.getTempUrl){t.next=11;break}return t.next=8,d.getTempUrl(o);case 8:t.t0=t.sent,t.next=12;break;case 11:t.t0=o;case 12:o=t.t0;case 13:t.next=17;break;case 15:t.prev=15,t.t1=t["catch"](3);case 17:s={avatarUrl:o,nickName:a.nickName,bio:a.bio,lastUpdated:Date.now()},v.set(n,s,{ttlMs:864e5}),console.log("【头像缓存】加载并缓存成功: ".concat(n)),e(s),t.next=25;break;case 23:console.warn("【头像缓存】获取用户信息失败: ".concat(n),r.result),e(null);case 25:case"end":return t.stop()}}),t,null,[[3,15]])})));return function(n){return t.apply(this,arguments)}}()).catch((function(t){console.error("【头像缓存】加载头像失败: ".concat(n),t),e(null)})).finally((function(){t.loadingAvatars.delete(n)}))}))}},{key:"getBatchUserAvatars",value:function(n){var t=this;if(!n||0===n.length)return Promise.resolve({});var e={},r=[];return n.forEach((function(n){var t=v.get(n);t?e[n]=t:r.push(n)})),r.length>0?(console.log("【头像缓存】批量加载头像: ".concat(r.length,"个")),new Promise((function(n){t.callCloudFunction("getBatchUserProfiles",{userIds:r}).then(function(){var t=s(i().mark((function t(r){var a,s,l,c,u;return i().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!(r.result&&r.result.success&&r.result.userProfiles)){t.next=35;break}a=o(r.result.userProfiles),t.prev=2,a.s();case 4:if((s=a.n()).done){t.next=27;break}if(l=s.value,!l||!l._openid){t.next=25;break}if(c=l.avatarUrl,t.prev=8,"string"!==typeof c||!c.startsWith("cloud://")){t.next=18;break}if(!d||!d.getTempUrl){t.next=16;break}return t.next=13,d.getTempUrl(c);case 13:t.t0=t.sent,t.next=17;break;case 16:t.t0=c;case 17:c=t.t0;case 18:t.next=22;break;case 20:t.prev=20,t.t1=t["catch"](8);case 22:u={avatarUrl:c,nickName:l.nickName,bio:l.bio,lastUpdated:Date.now()},e[l._openid]=u,v.set(l._openid,u,{ttlMs:864e5});case 25:t.next=4;break;case 27:t.next=32;break;case 29:t.prev=29,t.t2=t["catch"](2),a.e(t.t2);case 32:return t.prev=32,a.f(),t.finish(32);case 35:n(e);case 36:case"end":return t.stop()}}),t,null,[[2,29,32,35],[8,20]])})));return function(n){return t.apply(this,arguments)}}()).catch((function(t){console.error("【头像缓存】批量加载失败:",t),n(e)}))}))):Promise.resolve(e)}},{key:"preloadAvatarsFromPosts",value:function(n){var t=this;if(n&&0!==n.length){var e=a(new Set(n.map((function(n){return n._openid})).filter(Boolean)));0!==e.length&&setTimeout((function(){t.getBatchUserAvatars(e).then((function(n){console.log("【头像缓存】预加载完成: ".concat(Object.keys(n).length,"个头像"))}))}),100)}}},{key:"updateUserAvatar",value:function(n,t){if(!n||!t)return!1;var e=r(r({},t),{},{lastUpdated:Date.now()});try{return v.set(n,e,{ttlMs:864e5}),!0}catch(a){return!1}}},{key:"clearUserAvatar",value:function(n){if(!n)return!1;try{return v.delete(n),!0}catch(t){return!1}}},{key:"getDefaultAvatar",value:function(){return"/static/images/avatar.png"}}]),n}(),w=new h;n.exports=w},"05f1":function(n,t,e){"use strict";e.d(t,"b",(function(){return r})),e.d(t,"c",(function(){return a})),e.d(t,"a",(function(){}));var r=function(){var n=this,t=n.$createElement,e=n._self._c||t;return e("v-uni-view",{staticClass:"container"},[n.isLoading&&0===n.userPosts.length?e("v-uni-view",{staticClass:"loading-container"},[e("v-uni-view",{staticClass:"loading-text"},[n._v("加载中...")])],1):e("v-uni-view",[e("v-uni-view",{staticClass:"profile-header"},[e("v-uni-view",{staticClass:"header-actions"},[e("v-uni-view",{staticClass:"action-btn"}),e("v-uni-view",{staticClass:"action-btn"})],1),e("v-uni-view",{staticClass:"avatar-section"},[e("v-uni-view",{staticClass:"avatar-wrapper"},[e("v-uni-image",{staticClass:"user-avatar",attrs:{src:n.userInfo.avatarUrl||"/images/avatar.png",mode:"aspectFill"},on:{error:function(t){arguments[0]=t=n.$handleEvent(t),n.onAvatarError.apply(void 0,arguments)}}})],1)],1),e("v-uni-view",{staticClass:"user-info"},[e("v-uni-view",{staticClass:"username"},[n._v(n._s(n.userInfo.nickName||"微信用户"))]),e("v-uni-view",{staticClass:"user-bio"},[n._v(n._s(n.userInfo.bio||"这个用户很懒，什么都没留下..."))]),e("v-uni-view",{staticClass:"follow-stats"},[e("v-uni-view",{staticClass:"stat-item"},[e("v-uni-view",{staticClass:"stat-number"},[n._v(n._s(n.userInfo.followingCount||0))]),e("v-uni-view",{staticClass:"stat-label"},[n._v("关注")])],1),e("v-uni-view",{staticClass:"stat-item"},[e("v-uni-view",{staticClass:"stat-number"},[n._v(n._s(n.userInfo.followersCount||0))]),e("v-uni-view",{staticClass:"stat-label"},[n._v("被关注")])],1)],1),e("v-uni-view",{staticClass:"follow-section"},[n.showFollowButton?e("v-uni-button",{class:"follow-btn "+(n.isFollowing?"following":""),attrs:{loading:n.followPending,disabled:n.followPending},on:{click:function(t){arguments[0]=t=n.$handleEvent(t),n.onFollowTap.apply(void 0,arguments)}}},[n._v(n._s(n.isFollowing?"已关注":"关注"))]):n._e(),n.isMutualFollow?e("v-uni-view",{staticClass:"mutual-indicator"},[n._v("互相关注")]):n.isFollowedByTarget?e("v-uni-view",{staticClass:"followed-indicator"},[n._v("TA关注了你")]):n._e()],1)],1)],1),e("v-uni-view",{staticClass:"posts-section"},[e("v-uni-view",{staticClass:"section-title"},[n._v("TA的帖子")]),n.userPosts.length>0?[n._l(n.userPosts,(function(t,r){return e("v-uni-view",{key:r,staticClass:"post-card",attrs:{"data-id":t._id,"hover-class":"post-item-active"},on:{click:function(t){arguments[0]=t=n.$handleEvent(t),n.navigateToPostDetail.apply(void 0,arguments)}}},[e("v-uni-view",{staticClass:"post-header"},[e("v-uni-text",{staticClass:"post-title"},[n._v(n._s(t.title))])],1),t.imageUrls&&t.imageUrls.length>0?e("v-uni-view",{staticClass:"image-container"},[t.imageUrls.length>1?[e("v-uni-swiper",{staticClass:"image-swiper",style:"width: 100%; height: "+(n.swiperHeights[r]?n.swiperHeights[r]+"px":"220px")+";",attrs:{id:"swiper-"+r,"indicator-dots":!0,circular:!1,autoplay:!1}},[n._l(t.imageUrls,(function(a,o){return[e("v-uni-swiper-item",[e("v-uni-image",{staticClass:"post-image",staticStyle:{width:"100%",height:"100%","object-fit":"cover","background-color":"#f0f0f0"},attrs:{id:"user-swiper-img-"+r+"-"+o,src:a,mode:"aspectFill","data-src":a,"data-original-image-urls":t.originalImageUrls||t.imageUrls,"data-postindex":r,"data-imgindex":o,"data-type":"multi","lazy-load":!0},on:{error:function(t){arguments[0]=t=n.$handleEvent(t),n.onImageError.apply(void 0,arguments)},load:function(t){arguments[0]=t=n.$handleEvent(t),n.onImageLoad.apply(void 0,arguments)},click:function(t){t.stopPropagation(),t.preventDefault(),arguments[0]=t=n.$handleEvent(t),n.handlePreview.apply(void 0,arguments)}}})],1)]}))],2)]:1===t.imageUrls.length?[e("v-uni-image",{staticClass:"post-image",style:"width: 100%; height: "+(n.imageClampHeights[r]?n.imageClampHeights[r]+"px":"auto")+"; object-fit: "+(n.imageClampHeights[r]?"cover":"contain")+"; background-color: #f0f0f0;",attrs:{id:"single-image-"+r,src:t.imageUrls[0],mode:n.imageClampHeights[r]?"aspectFill":"widthFix","data-src":t.imageUrls[0],"data-original-image-urls":t.originalImageUrls||t.imageUrls,"data-postindex":r,"data-imgindex":"0","data-type":"single","lazy-load":!0},on:{error:function(t){arguments[0]=t=n.$handleEvent(t),n.onImageError.apply(void 0,arguments)},load:function(t){arguments[0]=t=n.$handleEvent(t),n.onImageLoad.apply(void 0,arguments)},click:function(t){t.stopPropagation(),t.preventDefault(),arguments[0]=t=n.$handleEvent(t),n.handlePreview.apply(void 0,arguments)}}})]:n._e()],2):n._e(),t.content?e("v-uni-view",{staticClass:"post-content"},[n._v(n._s(t.content))]):n._e(),e("v-uni-view",{staticClass:"post-footer"},[e("v-uni-view",{staticClass:"post-stats"},[e("v-uni-text",{staticClass:"stat-item"},[n._v("❤️ "+n._s(t.votes||0))]),e("v-uni-text",{staticClass:"stat-item"},[n._v("💬 "+n._s(t.commentCount||0))])],1),e("v-uni-view",{staticClass:"post-time"},[n._v(n._s(t.formattedCreateTime))])],1)],1)})),n.isLoading&&n.userPosts.length>0?e("v-uni-view",{staticClass:"loading-container"},[e("v-uni-view",{staticClass:"loading-text"},[n._v("加载中...")])],1):n._e(),e("v-uni-view",{staticStyle:{height:"100rpx"}})]:e("v-uni-view",{staticClass:"empty-tip"},[e("v-uni-text",[n._v("TA还没有发布过帖子")])],1)],2)],1)],1)},a=[]},"2b3c":function(n,t,e){var r=e("c86c");t=r(!1),t.push([n.i,"\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/* pages/user-profile/user-profile.wxss */.container[data-v-06c2ea8e]{min-height:100vh;background-color:#f7f8fa}\r\n/* 加载状态 */.loading-container[data-v-06c2ea8e]{display:flex;justify-content:center;align-items:center;height:%?400?%;background-color:#fff;border-radius:%?16?%;margin:%?30?%;box-shadow:0 %?4?% %?12?% rgba(0,0,0,.05)}.loading-text[data-v-06c2ea8e]{font-size:%?28?%;color:#999}\r\n/* 用户信息头部 */.profile-header[data-v-06c2ea8e]{background-color:#fff;padding:0 %?30?% %?40?% %?30?%;position:relative}.header-actions[data-v-06c2ea8e]{display:flex;justify-content:space-between;align-items:center;padding:%?20?% 0;height:%?80?%}.action-btn[data-v-06c2ea8e]{width:%?40?%;height:%?40?%;background-color:#f5f5f5;border-radius:%?20?%}.avatar-section[data-v-06c2ea8e]{display:flex;justify-content:center;margin:%?20?% 0 %?30?% 0}.avatar-wrapper[data-v-06c2ea8e]{position:relative}.user-avatar[data-v-06c2ea8e]{width:%?120?%;height:%?120?%;border-radius:%?60?%;background-color:#f0f0f0}.user-info[data-v-06c2ea8e]{text-align:center}.username[data-v-06c2ea8e]{font-size:%?32?%;font-weight:600;color:#000;margin-bottom:%?12?%}.user-bio[data-v-06c2ea8e]{font-size:%?24?%;color:#666;line-height:1.4;margin-bottom:%?30?%;padding:0 %?40?%}.follow-stats[data-v-06c2ea8e]{display:flex;justify-content:center;gap:%?80?%;margin-bottom:%?30?%}.stat-item[data-v-06c2ea8e]{text-align:center}.stat-number[data-v-06c2ea8e]{font-size:%?28?%;font-weight:600;color:#000;margin-bottom:%?4?%}.stat-label[data-v-06c2ea8e]{font-size:%?22?%;color:#999}.follow-section[data-v-06c2ea8e]{display:flex;justify-content:center;align-items:center;gap:%?20?%}.follow-btn[data-v-06c2ea8e]{padding:0 %?40?%;height:%?56?%;line-height:%?56?%;background-color:#007aff;color:#fff;border:none;border-radius:%?28?%;font-size:%?26?%;font-weight:500}.follow-btn.following[data-v-06c2ea8e]{background-color:#f0f0f0;color:#666}.follow-btn[data-v-06c2ea8e]::after{border:none}.follow-btn[disabled][data-v-06c2ea8e]{opacity:.7}.mutual-indicator[data-v-06c2ea8e],\r\n.followed-indicator[data-v-06c2ea8e]{padding:%?8?% %?20?%;border-radius:%?20?%;font-size:%?22?%;background-color:#f0f8ff;color:#007aff}\r\n/* 帖子部分 */.posts-section[data-v-06c2ea8e]{margin:%?20?% %?30?% %?30?% %?30?%}.section-title[data-v-06c2ea8e]{font-size:%?32?%;font-weight:700;color:#333;margin-bottom:%?20?%;padding:0 %?10?%}.post-card[data-v-06c2ea8e]{background:#fff;border-radius:%?16?%;box-shadow:0 %?4?% %?12?% rgba(0,0,0,.05);margin-bottom:%?20?%;box-sizing:border-box;padding:%?30?%;transition:-webkit-transform .2s ease;transition:transform .2s ease;transition:transform .2s ease,-webkit-transform .2s ease}.post-card[data-v-06c2ea8e]:active{-webkit-transform:translateY(%?2?%);transform:translateY(%?2?%);box-shadow:0 %?2?% %?8?% rgba(0,0,0,.1)}.post-header[data-v-06c2ea8e]{margin-bottom:%?15?%}.post-title[data-v-06c2ea8e]{font-size:%?32?%;font-weight:700;color:#333;line-height:1.4;word-break:break-word;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical}\r\n/* 图片容器 */.image-container[data-v-06c2ea8e]{width:100%;margin:%?15?% 0}.image-swiper[data-v-06c2ea8e]{width:100%;background-color:#fff;border-radius:%?12?%;overflow:hidden}.post-image[data-v-06c2ea8e]{width:100%;height:100%;display:block;object-fit:contain;border-radius:%?12?%}.post-content[data-v-06c2ea8e]{font-size:%?28?%;color:#666;line-height:1.5;margin:%?15?% 0;word-break:break-word;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;line-clamp:3;-webkit-box-orient:vertical}.post-footer[data-v-06c2ea8e]{display:flex;justify-content:space-between;align-items:center;margin-top:%?20?%;padding-top:%?20?%;border-top:%?1?% solid #f0f0f0}.post-stats[data-v-06c2ea8e]{display:flex;align-items:center;gap:%?20?%}.stat-item[data-v-06c2ea8e]{font-size:%?26?%;color:#999}.post-time[data-v-06c2ea8e]{font-size:%?24?%;color:#ccc}.empty-tip[data-v-06c2ea8e]{text-align:center;color:#bbb;font-size:%?28?%;margin:%?40?% 0;padding:%?60?% 0;background-color:#fff;border-radius:%?16?%;box-shadow:0 %?4?% %?12?% rgba(0,0,0,.05)}\r\n/* 资料详情（与我的主页风格一致） */.profile-detail-card[data-v-06c2ea8e]{margin:0 %?30?% %?20?% %?30?%;padding:%?20?% %?24?%;background:#fff;border-radius:%?16?%;box-shadow:0 %?4?% %?12?% rgba(0,0,0,.05);display:flex;flex-wrap:wrap;gap:%?16?% %?24?%}.detail-item-inline[data-v-06c2ea8e]{color:#666;font-size:%?28?%;margin-right:%?24?%}",""]),n.exports=t},"2ed3":function(n,t,e){"use strict";e("6a54");var r=e("f5bd").default;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=r(e("5de6"));e("bf0f"),e("18f7"),e("de6c"),e("2797"),e("c223");var o=e("a1cb"),i=e("962f"),s=i.formatRelativeTime,l=e("0123"),c=e("acbf"),u=e("edf3"),d=u.previewImage,f=e("38db"),g=f.cloudCall,v=e("9c8b"),h={mixins:[v],data:function(){return{userInfo:{avatarUrl:"",nickName:"",bio:""},isLoading:!1,userPosts:[],page:0,hasMore:!0,PAGE_SIZE:5,swiperHeights:{},imageClampHeights:{},targetUserId:"",showFollowButton:!1,isFollowing:!1,isFollowedByTarget:!1,isMutualFollow:!1,followPending:!1,imgindex:0,imageUrl:""}},onLoad:function(n){var t=this;console.log("【用户主页】页面加载,options:",n);var e=n.userId;if(!e)return uni.showToast({title:"用户信息获取失败",icon:"none"}),void uni.navigateBack();this.setData({targetUserId:e}),this.loadUserProfile();try{uni.$on&&uni.$on("avatar-updated",(function(n){n&&n.userId===t.targetUserId&&((0,o.invalidateUserInfo)(t.targetUserId),t.loadUserProfile())})),uni.$on&&uni.$on("post-created",(function(n){n&&n.userId===t.targetUserId&&((0,o.invalidateUserPosts)(t.targetUserId),t.setData({userPosts:[],page:0,hasMore:!0}),t.loadUserProfile())})),uni.$on&&uni.$on("favorite-changed",(function(n){n&&n.userId===t.targetUserId&&((0,o.invalidateUserPosts)(t.targetUserId),t.setData({userPosts:[],page:0,hasMore:!0}),t.loadUserProfile())}))}catch(r){}},onPullDownRefresh:function(){this.setData({userPosts:[],page:0,hasMore:!0,swiperHeights:{},imageClampHeights:{}}),this.loadUserProfile((function(){uni.stopPullDownRefresh()}))},onReachBottom:function(){this.hasMore&&!this.isLoading&&this.loadUserPosts()},methods:{callCloudFunction:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return g(n,t,Object.assign({pageTag:"user-profile",context:this},e))},loadUserProfile:function(n){var t=this;this.setData({isLoading:!0}),Promise.all([(0,o.getUserInfo)(this.targetUserId,this),(0,o.getUserPosts)({userId:this.targetUserId,page:0,pageSize:this.PAGE_SIZE,context:this})]).then((function(n){var e=(0,a.default)(n,2),r=e[0],o=e[1];o.forEach((function(n){n.createTime&&(n.formattedCreateTime=t.formatTime(n.createTime))})),t.setData({userInfo:r,userPosts:o,page:1,hasMore:o.length===t.PAGE_SIZE}),l.updateUserAvatar(t.targetUserId,r),t.prepareFollowStateWithCache(),uni.setNavigationBarTitle({title:r.nickName||"用户主页"})})).catch((function(n){console.error("【用户主页】缓存加载失败",n),uni.showToast({title:"网络异常，请稍后重试",icon:"none"})})).finally((function(){t.setData({isLoading:!1}),"function"===typeof n&&n()}))},loadUserPosts:function(){var n=this;if(!this.isLoading){var t=this.page,e=this.PAGE_SIZE;this.setData({isLoading:!0}),(0,o.getUserPosts)({userId:this.targetUserId,page:t,pageSize:e,context:this}).then((function(r){r.forEach((function(t){t.createTime&&(t.formattedCreateTime=n.formatTime(t.createTime))}));var a=n.userPosts.concat(r);n.setData({userPosts:a,page:t+1,hasMore:r.length===e})})).catch((function(n){console.error("【用户主页】加载更多帖子失败",n)})).finally((function(){n.setData({isLoading:!1})}))}},prepareFollowState:function(){var n=this.targetUserId,t=this.getCurrentUserId();n&&t&&n!==t?(this.setData({showFollowButton:!0,isFollowing:!1,isFollowedByTarget:!1,isMutualFollow:!1}),this.fetchFollowStatusWithCache(n)):this.setData({showFollowButton:!1,isFollowing:!1,isFollowedByTarget:!1,isMutualFollow:!1})},prepareFollowStateWithCache:function(){var n=this.targetUserId,t=this.getCurrentUserId();n&&t&&n!==t?(this.setData({showFollowButton:!0,isFollowing:!1,isFollowedByTarget:!1,isMutualFollow:!1}),this.fetchFollowStatusWithCache(n)):this.setData({showFollowButton:!1,isFollowing:!1,isFollowedByTarget:!1,isMutualFollow:!1})},fetchFollowStatusWithCache:function(n){var t=this;if(n){var e=this.getCurrentUserId();e&&c.getFollowStatus(e,n).then((function(n){n&&t.setData({isFollowing:n.isFollowing,isFollowedByTarget:n.isFollowedByAuthor,isMutualFollow:n.isMutualFollow})}))}},fetchFollowStatus:function(n){var t=this;n&&this.callCloudFunction("follow",{action:"checkFollow",targetOpenid:n},{requireAuth:!0}).then((function(n){n.result&&n.result.success?t.setData({isFollowing:!!n.result.isFollowing,isFollowedByTarget:!!n.result.isFollower,isMutualFollow:!!n.result.isMutual}):console.warn("检查关注状态失败",n.result)})).catch((function(n){console.error("检查关注状态调用失败:",n)}))},onFollowTap:function(){var n=this;if(!this.followPending){var t=this.targetUserId;if(t){var e=this.getCurrentUserId();e?(this.setData({followPending:!0}),c.toggleFollowStatus(e,t).then((function(t){t?(n.setData({isFollowing:t.isFollowing,isFollowedByTarget:t.isFollowedByAuthor,isMutualFollow:t.isMutualFollow}),uni.showToast({title:t.isFollowing?"关注成功":"已取消关注",icon:"success"})):uni.showToast({title:"操作失败",icon:"none"})})).catch((function(n){console.error("切换关注状态失败:",n),uni.showToast({title:"网络错误",icon:"none"})})).finally((function(){n.setData({followPending:!1})}))):uni.showToast({title:"请先登录",icon:"none"})}}},getCurrentUserId:function(){return getApp().globalData.openid||uni.getStorageSync("openid")||uni.getStorageSync("userOpenId")},navigateToPostDetail:function(n){var t=n.currentTarget.dataset.id;uni.navigateTo({url:"/pages/post-detail/post-detail?id=".concat(t)})},handlePreview:function(n){return d(n,{fallbackToast:!1})},formatTime:function(n){return s(n)},onImageError:function(n){console.error("图片加载失败:",n.detail)},onAvatarError:function(n){console.error("头像加载失败:",n.detail)}}};t.default=h},"4db6":function(n,t,e){e("6a54");var r=e("8bcf");function a(n,t){for(var e=0;e<t.length;e++){var a=t[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(n,r(a.key),a)}}n.exports=function(n,t,e){return t&&a(n.prototype,t),e&&a(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n},n.exports.__esModule=!0,n.exports["default"]=n.exports},"5bfe":function(n,t,e){"use strict";var r=e("7d73"),a=e.n(r);a.a},"7d73":function(n,t,e){var r=e("2b3c");r.__esModule&&(r=r.default),"string"===typeof r&&(r=[[n.i,r,""]]),r.locals&&(n.exports=r.locals);var a=e("967d").default;a("df3c4960",r,!0,{sourceMap:!1,shadowMode:!1})},"883d":function(n,t,e){e("7a76"),e("c9b5"),n.exports=function(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")},n.exports.__esModule=!0,n.exports["default"]=n.exports},acbf:function(n,t,e){var r=e("5014").default,a=e("d189").default,o=e("883d").default,i=e("4db6").default;e("bf0f"),e("f3f7"),e("18f7"),e("de6c"),e("c223"),e("2797"),e("aa9c"),e("8f71"),e("fd3c"),e("dc8a"),e("9db6"),e("9327");var s=e("7ef8").default,l=e("38db"),c=l.cloudCall;function u(n){return s.namespace("follow:".concat(n),{persistent:!0,maxItems:4e3})}var d=function(){"use strict";function n(){o(this,n),this.loadingFollows=new Set}return i(n,[{key:"callCloudFunction",value:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return c(n,t,{pageTag:"followCache",requireAuth:!0})}},{key:"getFollowStatus",value:function(n,t){if(!n||!t||n===t)return Promise.resolve(null);var e=u(n).get(t);return e?(console.log("【关注缓存】命中缓存: ".concat(n," -> ").concat(t)),Promise.resolve(e)):this.loadingFollows.has("".concat(n,"_").concat(t))?(console.log("【关注缓存】正在加载中，等待: ".concat(n," -> ").concat(t)),this.waitForFollowLoad(n,t)):this.loadFollowStatus(n,t)}},{key:"waitForFollowLoad",value:function(n,t){var e=this;return new Promise((function(r){var a="".concat(n,"_").concat(t),o=setInterval((function(){if(!e.loadingFollows.has(a)){clearInterval(o);var i=u(n).get(t);r(i)}}),100);setTimeout((function(){clearInterval(o),e.loadingFollows.delete(a),r(null)}),3e3)}))}},{key:"loadFollowStatus",value:function(n,t){var e=this,r="".concat(n,"_").concat(t);return this.loadingFollows.add(r),console.log("【关注缓存】开始加载关注状态: ".concat(n," -> ").concat(t)),new Promise((function(a){e.callCloudFunction("follow",{action:"checkFollow",targetOpenid:t}).then((function(e){if(e.result&&e.result.success){var r={isFollowing:!!e.result.isFollowing,isFollowedByAuthor:!!e.result.isFollower,isMutualFollow:!!e.result.isMutual,lastUpdated:Date.now()};u(n).set(t,r,{ttlMs:36e5}),console.log("【关注缓存】加载并缓存成功: ".concat(n," -> ").concat(t),r),a(r)}else console.warn("【关注缓存】获取关注状态失败: ".concat(n," -> ").concat(t),e.result),a(null)})).catch((function(e){console.error("【关注缓存】加载关注状态失败: ".concat(n," -> ").concat(t),e),a(null)})).finally((function(){e.loadingFollows.delete(r)}))}))}},{key:"getBatchFollowStatus",value:function(n,t){var e=this;if(!n||!t||0===t.length)return Promise.resolve({});var r={},a=[];return t.forEach((function(t){if(t!==n){var e=u(n).get(t);e?r[t]=e:a.push(t)}})),a.length>0?(console.log("【关注缓存】批量加载关注状态: ".concat(a.length,"个")),new Promise((function(t){e.callCloudFunction("getBatchFollowStatus",{currentUserId:n,targetUserIds:a}).then((function(e){e.result&&e.result.success&&e.result.followStatuses&&e.result.followStatuses.forEach((function(t){if(t&&t.targetUserId){var e={isFollowing:!!t.isFollowing,isFollowedByAuthor:!!t.isFollowedByAuthor,isMutualFollow:!!t.isMutualFollow,lastUpdated:Date.now()};r[t.targetUserId]=e,u(n).set(t.targetUserId,e,{ttlMs:36e5})}})),t(r)})).catch((function(n){console.error("【关注缓存】批量加载失败:",n),t(r)}))}))):Promise.resolve(r)}},{key:"preloadFollowStatusFromPosts",value:function(n,t){var e=this;if(n&&0!==n.length&&t){var r=a(new Set(n.map((function(n){return n._openid})).filter((function(n){return n&&n!==t}))));0!==r.length&&setTimeout((function(){e.getBatchFollowStatus(t,r).then((function(n){console.log("【关注缓存】预加载完成: ".concat(Object.keys(n).length,"个关注状态"))}))}),100)}}},{key:"updateFollowStatus",value:function(n,t,e){if(!n||!t||!e)return!1;var a=r(r({},e),{},{lastUpdated:Date.now()});try{return u(n).set(t,a,{ttlMs:36e5}),!0}catch(o){return!1}}},{key:"toggleFollowStatus",value:function(n,t){var e=this;return n&&t&&n!==t?new Promise((function(r){e.callCloudFunction("follow",{action:"toggleFollow",targetOpenid:t}).then((function(a){if(a.result&&a.result.success){var o={isFollowing:!!a.result.isFollowing,isFollowedByAuthor:!!a.result.isFollower,isMutualFollow:!!a.result.isMutual,lastUpdated:Date.now()};e.updateFollowStatus(n,t,o),console.log("【关注缓存】切换关注状态成功: ".concat(n," -> ").concat(t),o),r(o)}else console.warn("【关注缓存】切换关注状态失败: ".concat(n," -> ").concat(t),a.result),r(null)})).catch((function(e){console.error("【关注缓存】切换关注状态失败: ".concat(n," -> ").concat(t),e),r(null)}))})):Promise.resolve(null)}},{key:"clearUserFollowCache",value:function(n){if(!n)return!1;try{return u(n).clear(),!0}catch(t){return console.log("CatchClause",t),console.log("CatchClause",t),console.error("清理用户关注缓存失败:",t),!1}}},{key:"clearAllFollowCache",value:function(){try{var n=uni.getStorageInfoSync&&uni.getStorageInfoSync(),t=n&&n.keys||[];return t.forEach((function(n){if("string"===typeof n&&n.startsWith("__cm__:follow:")&&n.endsWith(":__keys__")){var t=n.substring("__cm__:".length,n.length-":__keys__".length);try{s.namespace(t,{persistent:!0}).clear()}catch(e){}}})),!0}catch(e){return console.log("CatchClause",e),console.log("CatchClause",e),console.error("清理所有关注缓存失败:",e),!1}}}]),n}(),f=new d;n.exports=f},c045:function(n,t,e){"use strict";e.r(t);var r=e("05f1"),a=e("f3ec");for(var o in a)["default"].indexOf(o)<0&&function(n){e.d(t,n,(function(){return a[n]}))}(o);e("5bfe");var i=e("828b"),s=Object(i["a"])(a["default"],r["b"],r["c"],!1,null,"06c2ea8e",null,!1,r["a"],void 0);t["default"]=s.exports},f3ec:function(n,t,e){"use strict";e.r(t);var r=e("2ed3"),a=e.n(r);for(var o in r)["default"].indexOf(o)<0&&function(n){e.d(t,n,(function(){return r[n]}))}(o);t["default"]=a.a}}]);