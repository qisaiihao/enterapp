(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-create-discussion-create-discussion"],{1203:function(t,e,n){"use strict";n("6a54");var i=n("f5bd").default;Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=i(n("9b1b")),o=i(n("b7c7")),s=i(n("2634")),c=i(n("2fdc"));n("bf0f"),n("0c26"),n("5c47"),n("dfcf"),n("e966"),n("f7a5"),n("5ef2"),n("dd2b"),n("aa9c"),n("4100"),n("8f71"),n("fd3c"),n("c223"),n("3efd"),n("7a76"),n("c9b5");var r=n("38db"),l=r.cloudCall,d={data:function(){return{quotedPost:null,isPublishing:!1,currentPostId:"",discussionTitle:"",hasSelectedSentences:!1,selectedSentenceGroups:[],currentSelectingGroup:0,highlightSelectedLineIndices:[],showHighlightHint:!1}},computed:{canPublish:function(){var t=this.selectedSentenceGroups.some((function(t){return t.comment&&t.comment.trim().length>0}));return t&&!this.isPublishing},splitContentLines:function(){var t=this.quotedPost?this.quotedPost.fullContent:"";return t.split(/\r?\n/)}},onLoad:function(t){var e=t.postId;e?(this.currentPostId=e,this.loadQuotedPost(e)):(uni.showToast({title:"参数错误",icon:"none"}),setTimeout((function(){uni.navigateBack()}),1500))},methods:{onPageTap:function(){uni.hideKeyboard()},noop:function(){},callCloudFunction:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return l(t,e,Object.assign({pageTag:"create-discussion",context:this,requireAuth:!0},n))},onTitleInput:function(t){this.setData({discussionTitle:t.detail.value})},loadQuotedPost:function(t){var e=this;return(0,c.default)((0,s.default)().mark((function n(){var i,a;return(0,s.default)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,uni.showLoading({title:"加载中...",mask:!0}),n.next=4,e.callCloudFunction("getPostDetail",{postId:t});case 4:i=n.sent,i.result&&i.result.post?(a=i.result.post,e.setData({quotedPost:{postId:a._id,title:a.title,fullContent:a.content,authorName:a.authorName,authorAvatar:a.authorAvatar,createTime:a.createTime}}),e.setData({showHighlightHint:!0}),setTimeout((function(){e.setData({showHighlightHint:!1})}),3e3)):(uni.showToast({title:"帖子不存在",icon:"none"}),setTimeout((function(){uni.navigateBack()}),1500)),n.next=12;break;case 8:n.prev=8,n.t0=n["catch"](0),console.error("加载引用帖子失败:",n.t0),uni.showToast({title:"加载失败",icon:"none"});case 12:return n.prev=12,uni.hideLoading(),n.finish(12);case 15:case"end":return n.stop()}}),n,null,[[0,8,12,15]])})))()},toggleLineSelection:function(t){var e=parseInt(t.currentTarget.dataset.index);console.log("【create-discussion】点击行索引:",e);var n=this.highlightSelectedLineIndices.slice(),i=n.indexOf(e);console.log("【create-discussion】当前选中索引:",n,"点击的索引:",e,"是否已选中:",i>=0),i>=0?(n.splice(i,1),console.log("【create-discussion】取消选中行:",e)):(n.push(e),console.log("【create-discussion】选中行:",e)),n.sort((function(t,e){return t-e})),console.log("【create-discussion】更新后的选中索引:",n),this.setData({highlightSelectedLineIndices:n})},finishSelection:function(){if(0!==this.highlightSelectedLineIndices.length){var t=this.splitContentLines,e=this.highlightSelectedLineIndices.map((function(e){return t[e]||""})).filter((function(t){return""!==t.trim()}));if(0!==e.length){var n={sentences:e,comment:""};this.setData({selectedSentenceGroups:[].concat((0,o.default)(this.selectedSentenceGroups),[n]),hasSelectedSentences:!0,highlightSelectedLineIndices:[]}),uni.showToast({title:"句子选择完成",icon:"success"})}else uni.showToast({title:"请选择有效的句子",icon:"none"})}else uni.showToast({title:"请至少选择一行",icon:"none"})},onCommentInput:function(t){var e=parseInt(t.currentTarget.dataset.groupIndex),n=t.detail.value,i=this.selectedSentenceGroups.slice();i[e].comment=n,this.setData({selectedSentenceGroups:i})},addMoreSentences:function(){var t=this;this.setData({hasSelectedSentences:!1,highlightSelectedLineIndices:[],showHighlightHint:!0}),setTimeout((function(){t.setData({showHighlightHint:!1})}),3e3)},saveDraft:function(){if(this.quotedPost)try{var t={quotedPostId:this.currentPostId,quotedPost:this.quotedPost,selectedSentenceGroups:this.selectedSentenceGroups,hasSelectedSentences:this.hasSelectedSentences,saveTime:(new Date).getTime(),isDraft:!0,type:"discussion"},e=[];try{var n=uni.getStorageSync("discussion_drafts");n&&Array.isArray(n)&&(e=n)}catch(i){console.log("获取草稿列表失败，创建新列表")}e.unshift(t),e.length>10&&(e=e.slice(0,10)),uni.setStorageSync("discussion_drafts",e),uni.showToast({title:"草稿已保存",icon:"success"})}catch(i){console.error("保存草稿失败:",i),uni.showToast({title:"保存失败",icon:"none"})}else uni.showToast({title:"没有内容可保存",icon:"none"})},deleteContent:function(){var t=this;uni.showModal({title:"确认删除",content:"确定要删除所有已选内容吗？",confirmText:"删除",cancelText:"取消",confirmColor:"#ff4757",success:function(e){e.confirm&&(t.setData({selectedSentenceGroups:[],hasSelectedSentences:!1,highlightSelectedLineIndices:[],showHighlightHint:!0}),setTimeout((function(){t.setData({showHighlightHint:!1})}),3e3),uni.showToast({title:"已清除内容",icon:"success"}))}})},publishDiscussion:function(){var t=this;return(0,c.default)((0,s.default)().mark((function e(){var n,i,o;return(0,s.default)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.canPublish&&t.currentPostId){e.next=3;break}return uni.showToast({title:"请至少输入一条评论",icon:"none"}),e.abrupt("return");case 3:if(!t.isPublishing){e.next=5;break}return e.abrupt("return");case 5:return t.setData({isPublishing:!0}),uni.showLoading({title:"发布中...",mask:!0}),e.prev=7,n={quotedPostId:t.currentPostId,sentenceGroups:t.selectedSentenceGroups,publishMode:"discussion",isDiscussion:!0},e.next=11,t.callCloudFunction("createDiscussionPost",(0,a.default)((0,a.default)({},n),{},{content:t.generateDiscussionContent(),imageUrls:[],sentenceData:t.selectedSentenceGroups}));case 11:if(i=e.sent,!i.result||!i.result.success){e.next=18;break}uni.showToast({title:"发布成功",icon:"success"}),t.clearDraft(),setTimeout((function(){uni.navigateBack()}),1500),e.next=19;break;case 18:throw new Error((null===(o=i.result)||void 0===o?void 0:o.message)||"发布失败");case 19:e.next=25;break;case 21:e.prev=21,e.t0=e["catch"](7),console.error("发布讨论失败:",e.t0),uni.showToast({title:e.t0.message||"发布失败",icon:"none",duration:3e3});case 25:return e.prev=25,t.setData({isPublishing:!1}),uni.hideLoading(),e.finish(25);case 29:case"end":return e.stop()}}),e,null,[[7,21,25,29]])})))()},clearDraft:function(){try{uni.removeStorageSync("discussion_drafts")}catch(t){console.error("清除草稿失败:",t)}},generateDiscussionContent:function(){var t=this.selectedSentenceGroups.map((function(t){var e=t.sentences.join("\n"),n=t.comment||"";return"".concat(e,"\n\n").concat(n)}));return t.join("\n\n---\n\n")},goBack:function(){uni.navigateBack()}}};e.default=d},"32eb":function(t,e,n){"use strict";var i=n("fd27"),a=n.n(i);a.a},"33bd":function(t,e,n){var i=n("c86c");e=i(!1),e.push([t.i,".create-discussion-container[data-v-386fb960]{background:#fff;min-height:100vh;padding-top:env(safe-area-inset-top);padding-bottom:0; /* 移除底部padding，让固定按钮真正固定 */position:relative}\r\n\r\n/* 返回按钮 */.back-button[data-v-386fb960]{position:relative;top:%?40?%;left:%?30?%;width:%?80?%;height:%?80?%;background:transparent;border-radius:0;display:flex;align-items:center;justify-content:center;z-index:10;box-shadow:none;-webkit-backdrop-filter:none;backdrop-filter:none;margin-top:calc(%?40?% + env(safe-area-inset-top));margin-left:0}\r\n\r\n/* 标题输入框 */.title-input-wrapper[data-v-386fb960]{margin:%?120?% %?30?% %?20?% %?30?%;position:relative}.title-input[data-v-386fb960]{width:100%;height:%?88?%; /* 44px * 2 */font-family:Inter,sans-serif;font-weight:600;font-size:%?48?%; /* 24px * 2 */line-height:%?58?%; /* 29px * 2 */color:#000;background:transparent;border:none;outline:none;padding:0}.back-button[data-v-386fb960]:active{-webkit-transform:scale(.9);transform:scale(.9);opacity:.8}.back-icon[data-v-386fb960]{width:%?100?%;height:%?100?%}\r\n\r\n/* 引用帖子区域 */.quoted-post[data-v-386fb960]{background:#fff;margin:%?180?% %?30?% %?20?%;border-radius:%?16?%;padding:%?30?%;border-left:%?6?% solid #9ed7ee}.quoted-header[data-v-386fb960]{display:flex;align-items:center;margin-bottom:%?20?%}.quoted-label[data-v-386fb960]{font-size:%?24?%;color:#666;margin-right:%?20?%}.author-avatar[data-v-386fb960]{width:%?40?%;height:%?40?%;border-radius:50%;margin-right:%?15?%}.author-name[data-v-386fb960]{font-size:%?26?%;color:#666}.quoted-content[data-v-386fb960]{margin-left:%?100?%}.post-title[data-v-386fb960]{font-size:%?30?%;font-weight:500;color:#333;margin-bottom:%?10?%;display:block}.post-content-preview[data-v-386fb960]{font-size:%?26?%;color:#666;line-height:1.4;display:block}\r\n\r\n/* 主输入区域 */.main-input-area[data-v-386fb960]{background:#fff;margin:%?20?% %?30?%;border-radius:%?16?%;padding:%?30?%;position:relative}.discussion-input[data-v-386fb960]{width:100%;min-height:%?200?%;font-size:%?30?%;line-height:1.5;color:#333;background:transparent;border:none;outline:none}.char-count[data-v-386fb960]{position:absolute;bottom:%?20?%;right:%?30?%;font-size:%?24?%;color:#999}.selection-header[data-v-386fb960]{margin-bottom:%?40?%;text-align:center;position:relative;z-index:1001}.selection-title[data-v-386fb960]{font-size:%?36?%;font-weight:500;color:#333;display:block;margin-bottom:%?10?%}.selection-subtitle[data-v-386fb960]{font-size:%?26?%;color:#666;display:block}.original-content-wrapper[data-v-386fb960]{position:relative;border:none;border-radius:0;padding:%?40?%;background:#fff;margin-bottom:%?40?%}.original-content-display[data-v-386fb960]{font-size:%?36?%;line-height:1.8;color:#333}.content-line[data-v-386fb960]{display:block;margin-bottom:%?16?%;padding:%?12?% %?16?%;border-radius:%?8?%;transition:all .2s ease;white-space:pre-wrap;word-break:break-word;color:#999;background-color:rgba(0,0,0,.05)}.content-line.selected-line[data-v-386fb960]{color:#333;background-color:rgba(158,215,238,.2);font-weight:500;border-left:%?4?% solid #9ed7ee;padding-left:%?20?%}\r\n\r\n/* 高光选择提示 */.highlight-hint[data-v-386fb960]{position:fixed;bottom:%?100?%;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);background:hsla(0,0%,50.2%,.8);color:#fff;padding:%?12?% %?24?%;border-radius:%?20?%;z-index:1000;text-align:center;white-space:nowrap}.hint-text[data-v-386fb960]{font-size:%?24?%;line-height:1.2}.selection-actions[data-v-386fb960]{position:fixed;bottom:%?60?%;right:%?30?%;z-index:1001}.select-done-btn[data-v-386fb960]{width:%?100?%;height:%?100?%;background:#9ed7ee;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 %?4?% %?12?% rgba(0,0,0,.15);transition:all .3s ease}.select-done-btn[data-v-386fb960]:active{-webkit-transform:scale(.95);transform:scale(.95)}.select-done-btn.disabled[data-v-386fb960]{background:#ccc;opacity:.5}.select-done-icon[data-v-386fb960]{width:%?60?%;height:%?60?%}.sentence-group[data-v-386fb960]{background:#fff;border-radius:%?16?%;padding:%?30?%;margin-bottom:%?20?%}.sentence-card[data-v-386fb960]{background:transparent;border-radius:0;padding:%?30?%;margin-bottom:%?20?%;width:100%;min-height:%?120?%;position:relative;box-sizing:border-box;max-width:100%}.sentence-content[data-v-386fb960]{position:relative;width:100%;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;box-sizing:border-box;max-width:100%}.sentence-line[data-v-386fb960]{font-family:Inter,sans-serif;font-style:italic;font-weight:600;font-size:%?40?%; /* 20px * 2 */line-height:%?48?%; /* 24px * 2 */color:#989090;display:block;margin-bottom:%?8?%;word-wrap:break-word;word-break:break-all;width:100%;max-width:100%;box-sizing:border-box;overflow-wrap:break-word}.sentence-line[data-v-386fb960]:last-child{margin-bottom:0}\r\n\r\n/* 响应式设计 - 根据屏幕宽度调整 */@media screen and (max-width:%?750?%){.sentence-card[data-v-386fb960]{padding:%?20?%;min-height:%?100?%}.sentence-line[data-v-386fb960]{font-size:%?36?%;line-height:%?44?%}}@media screen and (min-width:%?750?%){.sentence-card[data-v-386fb960]{padding:%?40?%;min-height:%?140?%}.sentence-line[data-v-386fb960]{font-size:%?44?%;line-height:%?52?%}}\r\n\r\n/* 评论输入框 */.comment-input-wrapper[data-v-386fb960]{position:relative;border:%?1?% solid #e0e0e0;border-radius:%?20?%;background:#fff}.comment-input[data-v-386fb960]{width:100%;min-height:%?100?%;font-family:Inter,sans-serif;font-weight:600;font-size:%?32?%; /* 16px * 2 */line-height:%?38?%; /* 19px * 2 */color:#000;padding:%?20?%;background:transparent;border:none;outline:none;resize:none}\r\n\r\n/* 底部按钮组 */.bottom-buttons[data-v-386fb960]{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:%?30?% %?40?% calc(%?60?% + env(safe-area-inset-bottom)) %?40?%;display:flex;justify-content:space-around;align-items:center;z-index:9999; /* 提高z-index确保在所有元素之上 */border-top:%?1?% solid #f0f0f0;box-shadow:0 %?-2?% %?10?% rgba(0,0,0,.1) /* 添加阴影效果 */}.button-item[data-v-386fb960]{display:flex;align-items:center;justify-content:center;padding:%?20?%;min-width:%?120?%;transition:all .2s ease;cursor:pointer}.button-item[data-v-386fb960]:active{-webkit-transform:scale(.9);transform:scale(.9);opacity:.8}.button-icon[data-v-386fb960]{width:%?80?%;height:%?80?%}\r\n\r\n/* 句子选择区域 */.sentence-selection-area[data-v-386fb960]{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff;z-index:1000;padding:calc(env(safe-area-inset-top) + %?120?%) %?30?% %?30?% %?30?%;box-sizing:border-box;overflow-y:auto}\r\n\r\n/* 已选句子区域 - 需要为底部按钮留出空间 */.selected-sentences-area[data-v-386fb960]{margin:%?20?% %?30?% %?20?% %?30?%; /* 调整上边距，因为标题输入框已经处理了间距 */margin-bottom:%?200?%; /* 为底部按钮留出空间 */padding-bottom:%?160?%; /* 增加底部padding，为固定按钮留出足够空间 */box-sizing:border-box;max-width:calc(100vw - %?60?%) /* 确保不超出屏幕，减去左右边距 */}",""]),t.exports=e},7012:function(t,e,n){"use strict";n.d(e,"b",(function(){return i})),n.d(e,"c",(function(){return a})),n.d(e,"a",(function(){}));var i=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("v-uni-view",{staticClass:"create-discussion-container",on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.onPageTap.apply(void 0,arguments)}}},[n("v-uni-view",{staticClass:"back-button",on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.goBack.apply(void 0,arguments)}}},[n("v-uni-image",{staticClass:"back-icon",attrs:{src:"/static/images/back_to_edit.png",mode:"aspectFit"}})],1),n("v-uni-view",{staticClass:"title-input-wrapper",on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.noop.apply(void 0,arguments)}}},[n("v-uni-input",{staticClass:"title-input",attrs:{placeholder:"输入标题",value:t.discussionTitle,maxlength:"50"},on:{input:function(e){arguments[0]=e=t.$handleEvent(e),t.onTitleInput.apply(void 0,arguments)},click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.noop.apply(void 0,arguments)}}})],1),t.hasSelectedSentences?n("v-uni-view",{staticClass:"selected-sentences-area"},t._l(t.selectedSentenceGroups,(function(e,i){return n("v-uni-view",{key:"group-"+i,staticClass:"sentence-group"},[n("v-uni-view",{staticClass:"sentence-card"},[n("v-uni-view",{staticClass:"sentence-content"},t._l(e.sentences,(function(e,i){return n("v-uni-text",{key:"sentence-"+i,staticClass:"sentence-line"},[t._v(t._s(e))])})),1)],1),n("v-uni-view",{staticClass:"comment-input-wrapper",on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.noop.apply(void 0,arguments)}}},[n("v-uni-textarea",{staticClass:"comment-input",attrs:{placeholder:0===i?"分享你对这句子的看法...":"继续分享你的看法...",value:e.comment,"data-group-index":i,"auto-height":!0,maxlength:"500","show-confirm-bar":!1},on:{input:function(e){arguments[0]=e=t.$handleEvent(e),t.onCommentInput.apply(void 0,arguments)},click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.noop.apply(void 0,arguments)}}}),n("v-uni-view",{staticClass:"char-count"},[t._v(t._s((e.comment||"").length)+"/500")])],1)],1)})),1):n("v-uni-view",{staticClass:"sentence-selection-area"},[n("v-uni-view",{staticClass:"original-content-wrapper"},[n("v-uni-view",{staticClass:"original-content-display"},t._l(t.splitContentLines,(function(e,i){return n("v-uni-text",{key:"content-line-"+i,staticClass:"content-line",class:{"selected-line":t.highlightSelectedLineIndices.includes(i)},attrs:{"data-index":i},on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.toggleLineSelection.apply(void 0,arguments)}}},[t._v(t._s(e||" "))])})),1),t.showHighlightHint?n("v-uni-view",{staticClass:"highlight-hint"},[n("v-uni-text",{staticClass:"hint-text"},[t._v("点击文字即可选择句子")])],1):t._e()],1),n("v-uni-view",{staticClass:"selection-actions"},[n("v-uni-view",{staticClass:"select-done-btn",class:{disabled:0===t.highlightSelectedLineIndices.length},on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.finishSelection.apply(void 0,arguments)}}},[n("v-uni-image",{staticClass:"select-done-icon",attrs:{src:"/static/images/confirm_selection.png",mode:"aspectFit"}})],1)],1)],1),t.hasSelectedSentences?n("v-uni-view",{staticClass:"bottom-buttons"},[n("v-uni-view",{staticClass:"button-item",on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.addMoreSentences.apply(void 0,arguments)}}},[n("v-uni-image",{staticClass:"button-icon",attrs:{src:"/static/images/add_tag.png",mode:"aspectFit"}})],1),n("v-uni-view",{staticClass:"button-item",on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.saveDraft.apply(void 0,arguments)}}},[n("v-uni-image",{staticClass:"button-icon",attrs:{src:"/static/images/save_draft.png",mode:"aspectFit"}})],1),n("v-uni-view",{staticClass:"button-item",on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.deleteContent.apply(void 0,arguments)}}},[n("v-uni-image",{staticClass:"button-icon",attrs:{src:"/static/images/delete.png",mode:"aspectFit"}})],1),n("v-uni-view",{staticClass:"button-item",on:{click:function(e){e.stopPropagation(),arguments[0]=e=t.$handleEvent(e),t.publishDiscussion.apply(void 0,arguments)}}},[n("v-uni-image",{staticClass:"button-icon",attrs:{src:"/static/images/publish.png",mode:"aspectFit"}})],1)],1):t._e()],1)},a=[]},8942:function(t,e,n){"use strict";n.r(e);var i=n("1203"),a=n.n(i);for(var o in i)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(o);e["default"]=a.a},e709:function(t,e,n){"use strict";n.r(e);var i=n("7012"),a=n("8942");for(var o in a)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return a[t]}))}(o);n("32eb");var s=n("828b"),c=Object(s["a"])(a["default"],i["b"],i["c"],!1,null,"386fb960",null,!1,i["a"],void 0);e["default"]=c.exports},fd27:function(t,e,n){var i=n("33bd");i.__esModule&&(i=i.default),"string"===typeof i&&(i=[[t.i,i,""]]),i.locals&&(t.exports=i.locals);var a=n("967d").default;a("318ce90e",i,!0,{sourceMap:!1,shadowMode:!1})}}]);