(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-register-register"],{"29f5":function(n,t,a){var e=a("c86c");t=e(!1),t.push([n.i,"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n/* 注册页面样式 */.container[data-v-174a3598]{display:flex;flex-direction:column;align-items:center;padding:%?120?% %?60?% %?60?%;height:100vh;background:linear-gradient(135deg,#f5f7fa,#c3cfe2)}.title[data-v-174a3598]{font-size:%?56?%;font-weight:700;margin-bottom:%?20?%;color:#333;text-align:center}.subtitle[data-v-174a3598]{font-size:%?28?%;color:#666;margin-bottom:%?80?%;text-align:center}.form-wrapper[data-v-174a3598]{width:100%;max-width:%?600?%}\n/* 头像上传区域 */.avatar-uploader[data-v-174a3598]{display:flex;align-items:center;gap:%?20?%;margin-bottom:%?30?%}.avatar-preview[data-v-174a3598]{width:%?120?%;height:%?120?%;border-radius:50%;overflow:hidden;position:relative;background:#f2f2f2;display:flex;align-items:center;justify-content:center}.avatar-preview uni-image[data-v-174a3598]{width:100%;height:100%}.avatar-tip[data-v-174a3598]{position:absolute;bottom:%?6?%;font-size:%?20?%;color:#666;background:hsla(0,0%,100%,.7);padding:%?2?% %?6?%;border-radius:%?6?%}.avatar-upload-btn[data-v-174a3598]{background-color:#1c9bd6;color:#fff;border-radius:%?8?%;height:%?72?%;line-height:%?72?%;padding:0 %?30?%}.input-wrapper[data-v-174a3598]{margin-bottom:%?30?%;background:#fff;border-radius:%?16?%;padding:%?30?%;box-shadow:0 %?4?% %?20?% rgba(0,0,0,.1)}.input-label[data-v-174a3598]{display:block;font-size:%?28?%;color:#333;margin-bottom:%?20?%;font-weight:500}.input-field[data-v-174a3598]{width:100%;font-size:%?32?%;color:#333;border:none;outline:none;background:transparent}.input-field[data-v-174a3598]::-webkit-input-placeholder{color:#999}.input-field[data-v-174a3598]::placeholder{color:#999}.register-button[data-v-174a3598]{width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-size:%?32?%;font-weight:500;border-radius:%?16?%;padding:%?30?%;margin:%?60?% 0 %?40?%;border:none;box-shadow:0 %?8?% %?25?% rgba(102,126,234,.3);transition:all .3s ease}.register-button[data-v-174a3598]:active{-webkit-transform:translateY(%?2?%);transform:translateY(%?2?%);box-shadow:0 %?4?% %?15?% rgba(102,126,234,.3)}.register-button[data-v-174a3598]:disabled{background:#ccc;box-shadow:none;-webkit-transform:none;transform:none}.register-button.loading[data-v-174a3598]{background:#ccc;box-shadow:none}.login-link-wrapper[data-v-174a3598]{display:flex;justify-content:center;align-items:center;margin-top:%?40?%}.login-text[data-v-174a3598]{font-size:%?28?%;color:#666;margin-right:%?10?%}.login-link[data-v-174a3598]{font-size:%?28?%;color:#667eea;font-weight:500;text-decoration:underline}\n/* 白色背景 + 顶部头像 + 底部悬浮按钮 */.white-page[data-v-174a3598]{background:#fff;min-height:100vh;position:relative}.container[data-v-174a3598]{display:flex;flex-direction:column;align-items:center;padding:%?60?% %?40?% %?140?%;background:#fff}.avatar-top[data-v-174a3598]{display:flex;flex-direction:column;align-items:center;margin:%?20?% 0 %?40?%}.avatar-preview[data-v-174a3598]{width:%?160?%;height:%?160?%;border-radius:50%;overflow:hidden;background:#f2f2f2;border:%?6?% solid #f1f1f1;box-shadow:0 %?6?% %?16?% rgba(0,0,0,.06)}.avatar-preview uni-image[data-v-174a3598]{width:100%;height:100%;display:block}.avatar-cta[data-v-174a3598]{margin-top:%?12?%;font-size:%?24?%;color:#999}.form-wrapper[data-v-174a3598]{width:100%;max-width:%?640?%}.input-wrapper[data-v-174a3598]{margin-bottom:%?24?%;background:transparent;border-radius:0;padding:0;border:none;box-shadow:none}.input-label[data-v-174a3598]{display:block;font-size:%?26?%;color:#888;margin-bottom:%?12?%}.input-field[data-v-174a3598]{width:100%;height:%?88?%;border:none;outline:none;background:#f5f6f7;border-radius:%?9999?%;padding:0 %?26?%;font-size:%?30?%;color:#333}\n/* 回车键形状按钮 */.enter-key-btn[data-v-174a3598]{position:fixed;right:%?40?%;bottom:%?40?%;width:%?220?%;height:%?180?%;cursor:pointer;transition:all .2s ease}.enter-key-btn[data-v-174a3598]:active{-webkit-transform:scale(.95);transform:scale(.95)}.enter-key-btn.disabled[data-v-174a3598]{opacity:.5;pointer-events:none}.enter-key-btn .ek-layer[data-v-174a3598]{position:absolute;inset:0}\n/* L 形剪裁：右侧竖条 + 底部横条 */.enter-key-btn .ek-border[data-v-174a3598]{background:#333;-webkit-filter:drop-shadow(0 %?6?% %?12?% rgba(0,0,0,.18));filter:drop-shadow(0 %?6?% %?12?% rgba(0,0,0,.18));-webkit-clip-path:polygon(55% 0,100% 0,100% 100%,0 100%,0 60%,55% 60%,55% 0);clip-path:polygon(55% 0,100% 0,100% 100%,0 100%,0 60%,55% 60%,55% 0);border-radius:%?24?%}.enter-key-btn .ek-fill[data-v-174a3598]{background:#fff;-webkit-clip-path:polygon(57% 2%,100% 2%,100% 100%,2% 100%,2% 62%,57% 62%,57% 2%);clip-path:polygon(57% 2%,100% 2%,100% 100%,2% 100%,2% 62%,57% 62%,57% 2%);border-radius:%?22?%}.enter-key-btn .ek-text[data-v-174a3598]{position:absolute;bottom:%?24?%;left:%?24?%;font-size:%?28?%;color:#333;font-weight:500}.login-link-wrapper.subtle[data-v-174a3598]{color:#999}",""]),n.exports=t},"2da8":function(n,t,a){"use strict";var e=a("e65c"),i=a.n(e);i.a},"50c0":function(n,t,a){"use strict";a.r(t);var e=a("a073"),i=a.n(e);for(var o in e)["default"].indexOf(o)<0&&function(n){a.d(t,n,(function(){return e[n]}))}(o);t["default"]=i.a},a073:function(n,t,a){"use strict";a("6a54");var e=a("f5bd").default;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=e(a("2634")),o=e(a("2fdc"));a("0c26"),a("bf0f"),a("7a76"),a("c9b5"),a("c223"),a("4626"),a("5ac7");getApp();var r=a("38db"),s=r.cloudCall,l={data:function(){return{poemId:"",password:"",confirmPassword:"",nickName:"",isRegistering:!1,localAvatarTempPath:"",avatarFileID:"",isUploadingAvatar:!1}},computed:{canRegister:function(){return this.poemId.trim()&&this.password.trim()&&this.confirmPassword.trim()&&this.nickName.trim()&&this.password===this.confirmPassword}},onLoad:function(){},methods:{callCloudFunction:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return s(n,t,Object.assign({pageTag:"register",context:this},a))},uploadAvatarViaCloudFunction:function(n){var t=this;return new Promise((function(a,e){if("undefined"===typeof window||"undefined"===typeof FileReader)try{var i=uni.getFileSystemManager&&uni.getFileSystemManager();if(!i)return e(new Error("不支持的环境"));i.readFile({filePath:n,encoding:"base64",success:function(n){var i=n.data;t.callCloudFunction("upload",{cloudPath:"user_avatars/".concat(Date.now(),"_").concat(Math.floor(1e3*Math.random()),".jpg"),fileContent:i}).then((function(n){n&&n.result&&n.result.success?a(n.result.fileID):e(new Error("上传失败"))})).catch(e)},fail:function(n){return e(n)}})}catch(o){e(o)}else fetch(n).then((function(n){if(!n.ok)throw new Error("HTTP "+n.status);return n.blob()})).then((function(n){var i=new FileReader;i.onload=function(){var n=i.result;if(!n||"string"!==typeof n)return e(new Error("读取失败"));var o=n.split(",")[1];t.callCloudFunction("upload",{cloudPath:"user_avatars/".concat(Date.now(),"_").concat(Math.floor(1e3*Math.random()),".jpg"),fileContent:o}).then((function(n){n&&n.result&&n.result.success?a(n.result.fileID):e(new Error("上传失败"))})).catch(e)},i.onerror=function(){return e(new Error("读取失败"))},i.readAsDataURL(n)})).catch(e)}))},onChooseAvatar:function(){var n=this;if(!this.isUploadingAvatar){var t=function(t){t&&(n.isUploadingAvatar=!0,n.localAvatarTempPath=t,n.uploadAvatarViaCloudFunction(t).then((function(t){n.avatarFileID=t,uni.showToast({title:"头像上传成功",icon:"success"})})).catch((function(t){console.error("上传头像失败:",t),n.avatarFileID="",uni.showToast({title:"头像上传失败",icon:"none"})})).finally((function(){n.isUploadingAvatar=!1})))};uni.chooseMedia?uni.chooseMedia({count:1,mediaType:["image"],sourceType:["album","camera"],success:function(n){var a=n.tempFiles&&n.tempFiles[0];t(a&&(a.tempFilePath||a.filePath))},fail:function(n){n&&n.errMsg&&n.errMsg.includes("cancel")||uni.showToast({title:"选择失败",icon:"none"})}}):uni.chooseImage({count:1,sizeType:["compressed","original"],sourceType:["album","camera"],success:function(n){t(n.tempFilePaths&&n.tempFilePaths[0])},fail:function(n){n&&n.errMsg&&n.errMsg.includes("cancel")||uni.showToast({title:"选择失败",icon:"none"})}})}},performAuth:function(){var n=this;return(0,o.default)((0,i.default)().mark((function t(){return(0,i.default)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return console.log("🔐 [Register] 开始认证流程"),t.abrupt("return",new Promise((function(t,e){var i=a("f3c3"),o=i.getCurrentPlatform,r=o();if("h5"===r||"app"===r)if(n.$tcb&&n.$tcb.auth){var s=n.$tcb.auth().currentUser;s?(console.log("✅ [注册] 用户已登录，跳过匿名登录"),t(s)):(console.log("🔐 [注册] 尝试匿名登录..."),n.$tcb.auth().signInAnonymously().then((function(n){console.log("✅ [注册] 匿名登录成功:",n),t(n)})).catch(e))}else e(new Error("TCB认证不可用"));else if("miniprogram"===r)if(wx.cloud&&wx.cloud.auth){var l=wx.cloud.auth().currentUser;l?(console.log("✅ [注册] 用户已登录，跳过匿名登录"),t(l)):(console.log("🔐 [注册] 尝试匿名登录..."),wx.cloud.auth().signInAnonymously().then((function(n){console.log("✅ [注册] 匿名登录成功:",n),t(n)})).catch(e))}else e(new Error("微信云开发认证不可用"));else e(new Error("不支持的平台: ".concat(r)))})));case 2:case"end":return t.stop()}}),t)})))()},onPoemIdInput:function(n){this.poemId=n.detail.value},onPasswordInput:function(n){this.password=n.detail.value},onConfirmPasswordInput:function(n){this.confirmPassword=n.detail.value},onNickNameInput:function(n){this.nickName=n.detail.value},onRegister:function(){var n=this;return(0,o.default)((0,i.default)().mark((function t(){var a,e,o,r,s,l;return(0,i.default)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n.canRegister&&!n.isRegistering){t.next=2;break}return t.abrupt("return");case 2:if(n.password===n.confirmPassword){t.next=5;break}return uni.showToast({title:"两次输入的密码不一致",icon:"none",duration:3e3}),t.abrupt("return");case 5:return n.isRegistering=!0,uni.showLoading({title:"注册中...",mask:!0}),t.prev=7,t.next=10,n.performAuth();case 10:return t.next=12,n.callCloudFunction("registerUser",{poemId:n.poemId.trim(),password:n.password.trim(),nickName:n.nickName.trim(),avatarFileID:n.avatarFileID||""});case 12:a=t.sent,console.log("🔍 [注册] 云函数返回结果:",a),a.result&&a.result.success?(e=a.result.userInfo,o=a.result.openid,console.log("✅ [注册] 注册成功:",e),r=getApp(),r.globalData.userInfo=e,r.globalData.openid=o,uni.setStorageSync("userInfo",e),uni.setStorageSync("userOpenId",o),uni.showToast({title:"注册成功",icon:"success"}),setTimeout((function(){uni.switchTab({url:"/pages/poem-square/poem-square"})}),1e3)):(l=(null===(s=a.result)||void 0===s?void 0:s.message)||"注册失败，请重试",uni.showToast({title:l,icon:"none",duration:3e3})),t.next=21;break;case 17:t.prev=17,t.t0=t["catch"](7),console.error("❌ [注册] 注册失败:",t.t0),uni.showToast({title:"注册失败，请重试",icon:"none",duration:3e3});case 21:return t.prev=21,uni.hideLoading(),n.isRegistering=!1,t.finish(21);case 25:case"end":return t.stop()}}),t,null,[[7,17,21,25]])})))()},goToLogin:function(){uni.navigateBack()}}};t.default=l},c137:function(n,t,a){"use strict";a.r(t);var e=a("c987"),i=a("50c0");for(var o in i)["default"].indexOf(o)<0&&function(n){a.d(t,n,(function(){return i[n]}))}(o);a("2da8");var r=a("828b"),s=Object(r["a"])(i["default"],e["b"],e["c"],!1,null,"174a3598",null,!1,e["a"],void 0);t["default"]=s.exports},c987:function(n,t,a){"use strict";a.d(t,"b",(function(){return e})),a.d(t,"c",(function(){return i})),a.d(t,"a",(function(){}));var e=function(){var n=this,t=n.$createElement,a=n._self._c||t;return a("v-uni-view",{staticClass:"white-page"},[a("v-uni-view",{staticClass:"container"},[a("v-uni-view",{staticClass:"avatar-top"},[a("v-uni-view",{staticClass:"avatar-preview",on:{click:function(t){arguments[0]=t=n.$handleEvent(t),n.onChooseAvatar.apply(void 0,arguments)}}},[a("v-uni-image",{attrs:{src:n.localAvatarTempPath||"/static/images/avatar.png",mode:"aspectFill"}})],1),a("v-uni-text",{staticClass:"avatar-cta"},[n._v("点击更换头像")])],1),a("v-uni-view",{staticClass:"form-wrapper compact"},[a("v-uni-view",{staticClass:"input-wrapper"},[a("v-uni-text",{staticClass:"input-label"},[n._v("Poem ID")]),a("v-uni-input",{staticClass:"input-field",attrs:{type:"text",placeholder:"请输入 Poem ID"},on:{input:function(t){arguments[0]=t=n.$handleEvent(t),n.onPoemIdInput.apply(void 0,arguments)}},model:{value:n.poemId,callback:function(t){n.poemId=t},expression:"poemId"}})],1),a("v-uni-view",{staticClass:"input-wrapper"},[a("v-uni-text",{staticClass:"input-label"},[n._v("密码")]),a("v-uni-input",{staticClass:"input-field",attrs:{type:"password",placeholder:"请输入密码"},on:{input:function(t){arguments[0]=t=n.$handleEvent(t),n.onPasswordInput.apply(void 0,arguments)}},model:{value:n.password,callback:function(t){n.password=t},expression:"password"}})],1),a("v-uni-view",{staticClass:"input-wrapper"},[a("v-uni-text",{staticClass:"input-label"},[n._v("确认密码")]),a("v-uni-input",{staticClass:"input-field",attrs:{type:"password",placeholder:"请再次输入密码"},on:{input:function(t){arguments[0]=t=n.$handleEvent(t),n.onConfirmPasswordInput.apply(void 0,arguments)}},model:{value:n.confirmPassword,callback:function(t){n.confirmPassword=t},expression:"confirmPassword"}})],1),a("v-uni-view",{staticClass:"input-wrapper"},[a("v-uni-text",{staticClass:"input-label"},[n._v("昵称")]),a("v-uni-input",{staticClass:"input-field",attrs:{type:"text",placeholder:"请输入昵称"},on:{input:function(t){arguments[0]=t=n.$handleEvent(t),n.onNickNameInput.apply(void 0,arguments)}},model:{value:n.nickName,callback:function(t){n.nickName=t},expression:"nickName"}})],1),a("v-uni-view",{staticClass:"login-link-wrapper subtle"},[a("v-uni-text",{staticClass:"login-text"},[n._v("已有账号？")]),a("v-uni-text",{staticClass:"login-link",on:{click:function(t){arguments[0]=t=n.$handleEvent(t),n.goToLogin.apply(void 0,arguments)}}},[n._v("去登录")])],1)],1)],1),a("v-uni-view",{staticClass:"enter-key-btn",class:{disabled:!n.canRegister||n.isRegistering},on:{click:function(t){arguments[0]=t=n.$handleEvent(t),n.onRegister.apply(void 0,arguments)}}},[a("v-uni-view",{staticClass:"ek-layer ek-border"}),a("v-uni-view",{staticClass:"ek-layer ek-fill"},[a("v-uni-text",{staticClass:"ek-text"},[n._v("Enter ↵")])],1)],1)],1)},i=[]},e65c:function(n,t,a){var e=a("29f5");e.__esModule&&(e=e.default),"string"===typeof e&&(e=[[n.i,e,""]]),e.locals&&(n.exports=e.locals);var i=a("967d").default;i("c3bc98ac",e,!0,{sourceMap:!1,shadowMode:!1})}}]);