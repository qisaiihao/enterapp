(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-messages-messages"],{"0aac":function(n,e,t){var a=t("c72c");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[n.i,a,""]]),a.locals&&(n.exports=a.locals);var i=t("967d").default;i("6a334a29",a,!0,{sourceMap:!1,shadowMode:!1})},"139b":function(n,e,t){t("795c"),t("64aa"),t("5c47"),t("a1c1"),t("c223"),t("f7a5");var a=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return String(n).padStart(e,"0")},i=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yyyy-MM-dd HH:mm:ss",t=n instanceof Date?n:new Date(n);if(Number.isNaN(t.getTime()))return"";var i={yyyy:String(t.getFullYear()),MM:a(t.getMonth()+1),dd:a(t.getDate()),HH:a(t.getHours()),mm:a(t.getMinutes()),ss:a(t.getSeconds())};return e.replace(/yyyy|MM|dd|HH|mm|ss/g,(function(n){return i[n]}))};n.exports={formatTimeAgo:function(n){var e=new Date,t=new Date(n),a=e.getTime()-t.getTime(),i=Math.floor(a/1e3),s=Math.floor(i/60),o=Math.floor(s/60),r=Math.floor(o/24);if(r>=7){var c=t.getFullYear(),l=("0"+(t.getMonth()+1)).slice(-2),u=("0"+t.getDate()).slice(-2);return"".concat(c,"-").concat(l,"-").concat(u)}return r>=1?"".concat(r,"天前"):o>=1?"".concat(o,"小时前"):s>=1?"".concat(s,"分钟前"):"刚刚"},formatRelativeTime:function(n){var e=Date.now(),t=n instanceof Date?n.getTime():new Date(n).getTime();if(Number.isNaN(t))return"";var a=e-t,s=Math.floor(Math.abs(a)/1e3),o=a>=0?"前":"后";if(s<60)return"刚刚";var r=Math.floor(s/60);if(r<60)return"".concat(r,"分钟").concat(o);var c=Math.floor(r/60);if(c<24)return"".concat(c,"小时").concat(o);var l=Math.floor(c/24);return l<7?"".concat(l,"天").concat(o):i(t,"yyyy-MM-dd")},formatDate:i}},"32e6":function(n,e,t){"use strict";var a=t("0aac"),i=t.n(a);i.a},"32fd":function(n,e,t){"use strict";t.d(e,"b",(function(){return a})),t.d(e,"c",(function(){return i})),t.d(e,"a",(function(){}));var a=function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("v-uni-view",{staticClass:"container"},[t("v-uni-view",{staticClass:"page-header"},[t("v-uni-text",{staticClass:"page-title"},[n._v("消息通知")]),t("v-uni-view",{staticClass:"header-actions"},[n.unreadCount>0?t("v-uni-text",{staticClass:"unread-count"},[n._v(n._s(n.unreadCount)+"条未读")]):n._e(),t("v-uni-text",{staticClass:"clear-btn",on:{click:function(e){arguments[0]=e=n.$handleEvent(e),n.clearAllMessages.apply(void 0,arguments)}}},[n._v("清空")])],1)],1),t("v-uni-view",{staticClass:"tab-container"},[t("v-uni-view",{class:"tab-item "+("all"===n.activeTab?"active":""),attrs:{"data-tab":"all"},on:{click:function(e){arguments[0]=e=n.$handleEvent(e),n.switchTab.apply(void 0,arguments)}}},[t("v-uni-text",[n._v("全部")]),"all"===n.activeTab?t("v-uni-view",{staticClass:"tab-indicator"}):n._e()],1),t("v-uni-view",{class:"tab-item "+("like"===n.activeTab?"active":""),attrs:{"data-tab":"like"},on:{click:function(e){arguments[0]=e=n.$handleEvent(e),n.switchTab.apply(void 0,arguments)}}},[t("v-uni-text",[n._v("点赞")]),"like"===n.activeTab?t("v-uni-view",{staticClass:"tab-indicator"}):n._e()],1),t("v-uni-view",{class:"tab-item "+("comment"===n.activeTab?"active":""),attrs:{"data-tab":"comment"},on:{click:function(e){arguments[0]=e=n.$handleEvent(e),n.switchTab.apply(void 0,arguments)}}},[t("v-uni-text",[n._v("评论")]),"comment"===n.activeTab?t("v-uni-view",{staticClass:"tab-indicator"}):n._e()],1),t("v-uni-view",{class:"tab-item "+("favorite"===n.activeTab?"active":""),attrs:{"data-tab":"favorite"},on:{click:function(e){arguments[0]=e=n.$handleEvent(e),n.switchTab.apply(void 0,arguments)}}},[t("v-uni-text",[n._v("收藏")]),"favorite"===n.activeTab?t("v-uni-view",{staticClass:"tab-indicator"}):n._e()],1),t("v-uni-view",{class:"tab-item "+("feedback"===n.activeTab?"active":""),attrs:{"data-tab":"feedback"},on:{click:function(e){arguments[0]=e=n.$handleEvent(e),n.switchTab.apply(void 0,arguments)}}},[t("v-uni-text",[n._v("反馈")]),"feedback"===n.activeTab?t("v-uni-view",{staticClass:"tab-indicator"}):n._e()],1)],1),t("v-uni-scroll-view",{staticClass:"message-list",attrs:{"scroll-y":!0},on:{scrolltolower:function(e){arguments[0]=e=n.$handleEvent(e),n.onReachBottom.apply(void 0,arguments)},scrolltoupper:function(e){arguments[0]=e=n.$handleEvent(e),n.onScrollToUpper.apply(void 0,arguments)}}},[0!==n.messages.length||n.isLoading?n._e():t("v-uni-view",{staticClass:"empty-container"},[t("v-uni-image",{staticClass:"empty-icon",attrs:{src:"/static/images/icons/empty-message.svg",mode:"aspectFit"}}),t("v-uni-text",{staticClass:"empty-text"},[n._v("暂无消息通知")])],1),n._l(n.messages,(function(e,a){return t("v-uni-view",{key:a,class:"message-item "+(e.isRead?"":"unread")},[t("v-uni-view",{staticClass:"message-content",attrs:{"data-postid":e.postId},on:{click:function(e){arguments[0]=e=n.$handleEvent(e),n.navigateToPost.apply(void 0,arguments)}}},[t("v-uni-image",{staticClass:"user-avatar",attrs:{src:e.fromUserAvatar||"/static/images/avatar.png",mode:"aspectFill"}}),t("v-uni-view",{staticClass:"message-body"},[t("v-uni-view",{staticClass:"message-header"},[t("v-uni-view",{staticClass:"message-type"},[t("v-uni-text",{staticClass:"type-icon"},[n._v(n._s("like"===e.type?"👍":"comment"===e.type?"💬":"favorite"===e.type?"⭐":"feedback"===e.type?"📝":"feedback_processed"===e.type?"✅":"📢"))]),t("v-uni-text",{staticClass:"type-text"},[n._v(n._s("like"===e.type?"点赞":"comment"===e.type?"评论":"favorite"===e.type?"收藏":"feedback"===e.type?"反馈":"feedback_processed"===e.type?"反馈处理":"通知"))])],1)],1),t("v-uni-text",{staticClass:"message-text"},[n._v(n._s(e.content))]),e.postTitle?t("v-uni-view",{staticClass:"post-preview"},[t("v-uni-text",{staticClass:"post-title"},[n._v(n._s(e.postTitle))])],1):n._e()],1)],1),t("v-uni-view",{staticClass:"delete-btn",attrs:{"data-messageid":e._id,"data-index":a},on:{click:function(e){arguments[0]=e=n.$handleEvent(e),n.deleteMessage.apply(void 0,arguments)}}},[t("v-uni-text",[n._v("删除")])],1),e.isRead?n._e():t("v-uni-view",{staticClass:"unread-dot"})],1)})),n.isLoading&&n.messages.length>0?t("v-uni-view",{staticClass:"loading-more"},[t("v-uni-text",[n._v("加载中...")])],1):n._e(),!n.hasMore&&n.messages.length>0?t("v-uni-view",{staticClass:"no-more"},[t("v-uni-text",[n._v("没有更多消息了")])],1):n._e()],2)],1)},i=[]},"73e1":function(n,e,t){"use strict";var a=t("29d8");n.exports=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(a)},"795c":function(n,e,t){"use strict";var a=t("8bdb"),i=t("db04").start,s=t("73e1");a({target:"String",proto:!0,forced:s},{padStart:function(n){return i(this,n,arguments.length>1?arguments[1]:void 0)}})},"967d":function(n,e,t){"use strict";function a(n,e){for(var t=[],a={},i=0;i<e.length;i++){var s=e[i],o=s[0],r=s[1],c=s[2],l=s[3],u={id:n+":"+i,css:r,media:c,sourceMap:l};a[o]?a[o].parts.push(u):t.push(a[o]={id:o,parts:[u]})}return t}t.r(e),t.d(e,"default",(function(){return v}));var i="undefined"!==typeof document;if("undefined"!==typeof DEBUG&&DEBUG&&!i)throw new Error("vue-style-loader cannot be used in a non-browser environment. Use { target: 'node' } in your Webpack config to indicate a server-rendering environment.");var s={},o=i&&(document.head||document.getElementsByTagName("head")[0]),r=null,c=0,l=!1,u=function(){},d=null,f="undefined"!==typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function v(n,e,t,i){l=t,d=i||{};var o=a(n,e);return p(o),function(e){for(var t=[],i=0;i<o.length;i++){var r=o[i],c=s[r.id];c.refs--,t.push(c)}e?(o=a(n,e),p(o)):o=[];for(i=0;i<t.length;i++){c=t[i];if(0===c.refs){for(var l=0;l<c.parts.length;l++)c.parts[l]();delete s[c.id]}}}}function p(n){for(var e=0;e<n.length;e++){var t=n[e],a=s[t.id];if(a){a.refs++;for(var i=0;i<a.parts.length;i++)a.parts[i](t.parts[i]);for(;i<t.parts.length;i++)a.parts.push(h(t.parts[i]));a.parts.length>t.parts.length&&(a.parts.length=t.parts.length)}else{var o=[];for(i=0;i<t.parts.length;i++)o.push(h(t.parts[i]));s[t.id]={id:t.id,refs:1,parts:o}}}}function g(){var n=document.createElement("style");return n.type="text/css",o.appendChild(n),n}function h(n){var e,t,a=document.querySelector('style[data-vue-ssr-id~="'+n.id+'"]');if(a){if(l)return u;a.parentNode.removeChild(a)}if(f){var i=c++;a=r||(r=g()),e=b.bind(null,a,i,!1),t=b.bind(null,a,i,!0)}else a=g(),e=y.bind(null,a),t=function(){a.parentNode.removeChild(a)};return e(n),function(a){if(a){if(a.css===n.css&&a.media===n.media&&a.sourceMap===n.sourceMap)return;e(n=a)}else t()}}var m=function(){var n=[];return function(e,t){return n[e]=t,n.filter(Boolean).join("\n")}}();function b(n,e,t,a){var i=t?"":A(a.css);if(n.styleSheet)n.styleSheet.cssText=m(e,i);else{var s=document.createTextNode(i),o=n.childNodes;o[e]&&n.removeChild(o[e]),o.length?n.insertBefore(s,o[e]):n.appendChild(s)}}function y(n,e){var t=A(e.css),a=e.media,i=e.sourceMap;if(a&&n.setAttribute("media",a),d.ssrId&&n.setAttribute("data-vue-ssr-id",e.id),i&&(t+="\n/*# sourceURL="+i.sources[0]+" */",t+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(i))))+" */"),n.styleSheet)n.styleSheet.cssText=t;else{while(n.firstChild)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(t))}}var w=/%\?([+-]?\d+(\.\d+)?)\?%/g,x=/\.\?%PAGE\?%/g,C=/\?%PAGE\?%\[data-v-[a-z0-9]{8}\]/g,M=/uni-page-body\[data-v-[a-z0-9]{8}\]/g,T=/var\(--status-bar-height\)/gi,k=/var\(--window-top\)/gi,_=/var\(--window-bottom\)/gi,D=/var\(--window-left\)/gi,E=/var\(--window-right\)/gi;function A(n){var e=function(){var n="function"===typeof getApp&&getApp();return n&&n.$route&&n.$route.meta&&n.$route.meta.name||""}();if("undefined"!==typeof uni&&!uni.canIUse("css.var")){var t=function(){var n="function"===typeof getApp&&getApp();if(n&&n.$route&&n.$route.meta&&n.$route.meta.name)return{top:n.$route.meta.windowTop,bottom:n.$route.meta.isTabBar?50:0};return{top:0,bottom:0}}();n=n.replace(T,"0px").replace(k,t.top+"px").replace(_,t.bottom+"px").replace(D,"0px").replace(E,"0px")}return n.replace(C,e).replace(x,"").replace(M,"body."+e+" uni-page-body").replace(/\{[\s\S]+?\}|@media.+?\{/g,(function(n){return"undefined"===typeof uni?n:n.replace(w,(function(n,e){return uni.upx2px(e)+"px"}))}))}},"9ef9":function(n,e,t){"use strict";t.r(e);var a=t("32fd"),i=t("b4e6");for(var s in i)["default"].indexOf(s)<0&&function(n){t.d(e,n,(function(){return i[n]}))}(s);t("32e6");var o=t("828b"),r=Object(o["a"])(i["default"],a["b"],a["c"],!1,null,"066bc75e",null,!1,a["a"],void 0);e["default"]=r.exports},b4e6:function(n,e,t){"use strict";t.r(e);var a=t("f63c"),i=t.n(a);for(var s in a)["default"].indexOf(s)<0&&function(n){t.d(e,n,(function(){return a[n]}))}(s);e["default"]=i.a},c72c:function(n,e,t){var a=t("c86c");e=a(!1),e.push([n.i,"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n/* pages/messages/messages.wxss */.container[data-v-066bc75e]{min-height:100vh;background-color:#f8f9fa}\n/* 页面标题 */.page-header[data-v-066bc75e]{display:flex;justify-content:space-between;align-items:center;padding:%?20?% %?30?%;background-color:#fff;border-bottom:%?1?% solid #eee}.page-title[data-v-066bc75e]{font-size:%?36?%;font-weight:700;color:#333}.header-actions[data-v-066bc75e]{display:flex;align-items:center;gap:%?20?%}.unread-count[data-v-066bc75e]{font-size:%?24?%;color:#ff6b6b;background-color:#ffe0e0;padding:%?4?% %?12?%;border-radius:%?20?%}.clear-btn[data-v-066bc75e]{font-size:%?28?%;color:#666;padding:%?8?% %?16?%}\n/* 标签容器 */.tab-container[data-v-066bc75e]{display:flex;background-color:#fff;padding:0 %?30?%;border-bottom:%?1?% solid #eee}.tab-item[data-v-066bc75e]{flex:1;display:flex;flex-direction:column;align-items:center;padding:%?30?% 0;position:relative}.tab-item uni-text[data-v-066bc75e]{font-size:%?30?%;color:#666;transition:color .3s}.tab-item.active uni-text[data-v-066bc75e]{color:#9ed7ee;font-weight:500}.tab-indicator[data-v-066bc75e]{position:absolute;bottom:0;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);width:%?60?%;height:%?4?%;background-color:#9ed7ee;border-radius:%?2?%}\n/* 消息列表 */.message-list[data-v-066bc75e]{height:calc(100vh - %?200?%);background-color:#f8f9fa}\n/* 空状态 */.empty-container[data-v-066bc75e]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:%?200?% 0}.empty-icon[data-v-066bc75e]{width:%?200?%;height:%?200?%;margin-bottom:%?30?%;opacity:.5}.empty-text[data-v-066bc75e]{font-size:%?30?%;color:#999}\n/* 消息项 */.message-item[data-v-066bc75e]{position:relative;background-color:#fff;margin:%?20?% %?30?%;border-radius:%?16?%;box-shadow:0 %?2?% %?8?% rgba(0,0,0,.1);overflow:hidden}.message-item.unread[data-v-066bc75e]{background-color:#f0f9ff;border-left:%?6?% solid #9ed7ee}.message-content[data-v-066bc75e]{display:flex;padding:%?30?%;gap:%?20?%}.user-avatar[data-v-066bc75e]{width:%?80?%;height:%?80?%;border-radius:50%;flex-shrink:0}.message-body[data-v-066bc75e]{flex:1;min-width:0}.message-header[data-v-066bc75e]{display:flex;justify-content:space-between;align-items:center;margin-bottom:%?10?%}.message-type[data-v-066bc75e]{display:flex;align-items:center;gap:%?8?%}.type-icon[data-v-066bc75e]{font-size:%?32?%}.type-text[data-v-066bc75e]{font-size:%?28?%;color:#333;font-weight:500}.message-time[data-v-066bc75e]{font-size:%?24?%;color:#999;flex-shrink:0}.message-text[data-v-066bc75e]{font-size:%?28?%;color:#666;line-height:1.5;margin-bottom:%?16?%;display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.post-preview[data-v-066bc75e]{background-color:#f8f9fa;padding:%?16?%;border-radius:%?8?%;border-left:%?4?% solid #9ed7ee}.post-title[data-v-066bc75e]{font-size:%?26?%;color:#333;display:-webkit-box;-webkit-line-clamp:1;line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}\n/* 时间信息样式 */.time-info[data-v-066bc75e]{margin:%?12?% 0;padding:%?8?% %?12?%;background-color:#f0f9ff;border-radius:%?8?%;border-left:%?3?% solid #9ed7ee}.time-text[data-v-066bc75e]{font-size:%?24?%;color:#9ed7ee;font-weight:500}.delete-btn[data-v-066bc75e]{position:absolute;top:%?20?%;right:%?20?%;padding:%?8?% %?16?%;background-color:#f5f5f5;border-radius:%?8?%;font-size:%?24?%;color:#999}.unread-dot[data-v-066bc75e]{position:absolute;top:%?20?%;left:%?20?%;width:%?16?%;height:%?16?%;background-color:#ff6b6b;border-radius:50%}\n/* 加载更多 */.loading-more[data-v-066bc75e],\n.no-more[data-v-066bc75e]{text-align:center;padding:%?40?%;font-size:%?28?%;color:#999}\n/* 响应式设计 */@media (max-width:375px){.message-content[data-v-066bc75e]{padding:%?24?%}.user-avatar[data-v-066bc75e]{width:%?70?%;height:%?70?%}.message-text[data-v-066bc75e]{font-size:%?26?%}}",""]),n.exports=e},c86c:function(n,e,t){"use strict";n.exports=function(n){var e=[];return e.toString=function(){return this.map((function(e){var t=function(n,e){var t=n[1]||"",a=n[3];if(!a)return t;if(e&&"function"===typeof btoa){var i=function(n){var e=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),t="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(e);return"/*# ".concat(t," */")}(a),s=a.sources.map((function(n){return"/*# sourceURL=".concat(a.sourceRoot||"").concat(n," */")}));return[t].concat(s).concat([i]).join("\n")}return[t].join("\n")}(e,n);return e[2]?"@media ".concat(e[2]," {").concat(t,"}"):t})).join("")},e.i=function(n,t,a){"string"===typeof n&&(n=[[null,n,""]]);var i={};if(a)for(var s=0;s<this.length;s++){var o=this[s][0];null!=o&&(i[o]=!0)}for(var r=0;r<n.length;r++){var c=[].concat(n[r]);a&&i[c[0]]||(t&&(c[2]?c[2]="".concat(t," and ").concat(c[2]):c[2]=t),e.push(c))}},e}},db04:function(n,e,t){"use strict";var a=t("bb80"),i=t("c435"),s=t("9e70"),o=t("f298"),r=t("862c"),c=a(o),l=a("".slice),u=Math.ceil,d=function(n){return function(e,t,a){var o,d,f=s(r(e)),v=i(t),p=f.length,g=void 0===a?" ":s(a);return v<=p||""===g?f:(o=v-p,d=c(g,u(o/g.length)),d.length>o&&(d=l(d,0,o)),n?f+d:d+f)}};n.exports={start:d(!1),end:d(!0)}},f63c:function(n,e,t){"use strict";t("6a54"),Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,t("bf0f"),t("2797"),t("c223"),t("4626"),t("5ac7"),t("fd3c"),t("8f71");getApp();var a=t("139b"),i=a.formatTimeAgo,s={data:function(){return{messages:[],isLoading:!1,hasMore:!0,page:0,PAGE_SIZE:10,activeTab:"all",unreadCount:0}},onLoad:function(n){this.loadMessages()},onShow:function(){0===this.messages.length?this.loadMessages():this.checkUnreadCount()},onPullDownRefresh:function(){this.setData({messages:[],page:0,hasMore:!0}),this.loadMessages((function(){uni.stopPullDownRefresh()}))},onReachBottom:function(){this.hasMore&&!this.isLoading&&this.loadMessages()},onScrollToUpper:function(){console.log("滚动到顶部")},methods:{callCloudFunction:function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return cloudCall(n,e,Object.assign({pageTag:"messages",context:this,requireAuth:!0},t))},switchTab:function(n){var e=n.currentTarget.dataset.tab;e!==this.activeTab&&(this.setData({activeTab:e,messages:[],page:0,hasMore:!0}),this.loadMessages())},loadMessages:function(n){var e=this;if(!this.isLoading){console.log("🔍 [消息页] 开始加载消息，页码:",this.page,"类型:",this.activeTab),this.setData({isLoading:!0});var t=this.page,a=this.PAGE_SIZE,s=this.activeTab;this.callCloudFunction("getMessages",{skip:t*a,limit:a,type:"all"===s?null:s}).then((function(n){if(console.log("🔍 [消息页] 云函数返回结果:",n),n.result&&n.result.success){var s=n.result.messages||[];n.result.totalCount;s.forEach((function(n){if(n.createTime){var e=i(n.createTime);n.formattedTime=e;var t=n.fromUserName||"某用户",a=n.content||"";if("like"===n.type)n.content="".concat(t," ").concat(e,"点赞了你的帖子");else if("comment"===n.type){var s=a.includes("回复了你的评论"),o=s?"回复了你的评论":"评论了你的帖子";n.content="".concat(t," ").concat(e).concat(o)}else"favorite"===n.type?n.content="".concat(t," ").concat(e,"收藏了你的帖子"):"feedback"===n.type?n.content="".concat(t," ").concat(e,"提交了新的意见反馈"):"feedback_processed"===n.type&&(n.content="管理员 ".concat(e,"处理了您的意见反馈"))}}));var o=0===t?s:e.messages.concat(s);e.setData({messages:o,page:t+1,hasMore:s.length===a,unreadCount:n.result.unreadCount||0}),s.length>0&&e.markMessagesAsRead(s.filter((function(n){return!n.isRead})).map((function(n){return n._id})))}})).catch((function(n){console.error("获取消息失败:",n),uni.showToast({title:"获取消息失败",icon:"none"})})).finally((function(){e.setData({isLoading:!1}),n&&n()}))}},checkUnreadCount:function(){var n=this;this.callCloudFunction("getUnreadMessageCount",{}).then((function(e){e.result&&e.result.success&&n.setData({unreadCount:e.result.count||0})})).catch((function(n){console.error("获取未读消息数量失败:",n)}))},markMessagesAsRead:function(n){var e=this;n&&0!==n.length&&this.callCloudFunction("markMessagesAsRead",{messageIds:n}).then((function(t){if(t.result&&t.result.success){var a=e.messages.map((function(e){return n.includes(e._id)&&(e.isRead=!0),e}));e.setData({messages:a,unreadCount:Math.max(0,e.unreadCount-n.length)})}})).catch((function(n){console.error("标记消息为已读失败:",n)}))},navigateToPost:function(n){var e=n.currentTarget.dataset.postid;e&&uni.navigateTo({url:"/pages/post-detail/post-detail?id=".concat(e)})},deleteMessage:function(n){var e=this,t=n.currentTarget.dataset.messageid,a=n.currentTarget.dataset.index;uni.showModal({title:"确认删除",content:"确定要删除这条消息吗？",success:function(n){n.confirm&&e.callCloudFunction("deleteMessage",{messageId:t}).then((function(n){if(n.result&&n.result.success){var t=e.messages.filter((function(n,e){return e!==a}));e.setData({messages:t}),uni.showToast({title:"删除成功",icon:"success"})}})).catch((function(n){console.error("删除消息失败:",n),uni.showToast({title:"删除失败",icon:"none"})}))}})},clearAllMessages:function(){var n=this;uni.showModal({title:"清空消息",content:"确定要清空所有消息吗？此操作不可恢复。",success:function(e){e.confirm&&n.callCloudFunction("clearAllMessages",{}).then((function(e){e.result&&e.result.success&&(n.setData({messages:[],page:0,hasMore:!1,unreadCount:0}),uni.showToast({title:"已清空",icon:"success"}))})).catch((function(n){console.error("清空消息失败:",n),uni.showToast({title:"清空失败",icon:"none"})}))}})}}};e.default=s}}]);