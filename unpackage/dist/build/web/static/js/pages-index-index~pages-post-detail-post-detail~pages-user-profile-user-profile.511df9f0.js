(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-index-index~pages-post-detail-post-detail~pages-user-profile-user-profile"],{"05f6":function(e,t,r){var n=r("5014").default,a=r("d189").default,o=r("883d").default,l=r("4db6").default;r("bf0f"),r("f3f7"),r("18f7"),r("de6c"),r("c223"),r("2797"),r("aa9c"),r("8f71"),r("fd3c"),r("dc8a"),r("9db6"),r("9327");var i=r("3ab8").default,c=r("11ca"),s=c.cloudCall;function u(e){return i.namespace("follow:".concat(e),{persistent:!0,maxItems:4e3})}var f=function(){"use strict";function e(){o(this,e),this.loadingFollows=new Set}return l(e,[{key:"callCloudFunction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s(e,t,{pageTag:"followCache",requireAuth:!0})}},{key:"getFollowStatus",value:function(e,t){if(!e||!t||e===t)return Promise.resolve(null);var r=u(e).get(t);return r?(console.log("【关注缓存】命中缓存: ".concat(e," -> ").concat(t)),Promise.resolve(r)):this.loadingFollows.has("".concat(e,"_").concat(t))?(console.log("【关注缓存】正在加载中，等待: ".concat(e," -> ").concat(t)),this.waitForFollowLoad(e,t)):this.loadFollowStatus(e,t)}},{key:"waitForFollowLoad",value:function(e,t){var r=this;return new Promise((function(n){var a="".concat(e,"_").concat(t),o=setInterval((function(){if(!r.loadingFollows.has(a)){clearInterval(o);var l=u(e).get(t);n(l)}}),100);setTimeout((function(){clearInterval(o),r.loadingFollows.delete(a),n(null)}),3e3)}))}},{key:"loadFollowStatus",value:function(e,t){var r=this,n="".concat(e,"_").concat(t);return this.loadingFollows.add(n),console.log("【关注缓存】开始加载关注状态: ".concat(e," -> ").concat(t)),new Promise((function(a){r.callCloudFunction("follow",{action:"checkFollow",targetOpenid:t}).then((function(r){if(r.result&&r.result.success){var n={isFollowing:!!r.result.isFollowing,isFollowedByAuthor:!!r.result.isFollower,isMutualFollow:!!r.result.isMutual,lastUpdated:Date.now()};u(e).set(t,n,{ttlMs:36e5}),console.log("【关注缓存】加载并缓存成功: ".concat(e," -> ").concat(t),n),a(n)}else console.warn("【关注缓存】获取关注状态失败: ".concat(e," -> ").concat(t),r.result),a(null)})).catch((function(r){console.error("【关注缓存】加载关注状态失败: ".concat(e," -> ").concat(t),r),a(null)})).finally((function(){r.loadingFollows.delete(n)}))}))}},{key:"getBatchFollowStatus",value:function(e,t){var r=this;if(!e||!t||0===t.length)return Promise.resolve({});var n={},a=[];return t.forEach((function(t){if(t!==e){var r=u(e).get(t);r?n[t]=r:a.push(t)}})),a.length>0?(console.log("【关注缓存】批量加载关注状态: ".concat(a.length,"个")),new Promise((function(t){r.callCloudFunction("getBatchFollowStatus",{currentUserId:e,targetUserIds:a}).then((function(r){r.result&&r.result.success&&r.result.followStatuses&&r.result.followStatuses.forEach((function(t){if(t&&t.targetUserId){var r={isFollowing:!!t.isFollowing,isFollowedByAuthor:!!t.isFollowedByAuthor,isMutualFollow:!!t.isMutualFollow,lastUpdated:Date.now()};n[t.targetUserId]=r,u(e).set(t.targetUserId,r,{ttlMs:36e5})}})),t(n)})).catch((function(e){console.error("【关注缓存】批量加载失败:",e),t(n)}))}))):Promise.resolve(n)}},{key:"preloadFollowStatusFromPosts",value:function(e,t){var r=this;if(e&&0!==e.length&&t){var n=a(new Set(e.map((function(e){return e._openid})).filter((function(e){return e&&e!==t}))));0!==n.length&&setTimeout((function(){r.getBatchFollowStatus(t,n).then((function(e){console.log("【关注缓存】预加载完成: ".concat(Object.keys(e).length,"个关注状态"))}))}),100)}}},{key:"updateFollowStatus",value:function(e,t,r){if(!e||!t||!r)return!1;var a=n(n({},r),{},{lastUpdated:Date.now()});try{return u(e).set(t,a,{ttlMs:36e5}),!0}catch(o){return!1}}},{key:"toggleFollowStatus",value:function(e,t){var r=this;return e&&t&&e!==t?new Promise((function(n){r.callCloudFunction("follow",{action:"toggleFollow",targetOpenid:t}).then((function(a){if(a.result&&a.result.success){var o={isFollowing:!!a.result.isFollowing,isFollowedByAuthor:!!a.result.isFollower,isMutualFollow:!!a.result.isMutual,lastUpdated:Date.now()};r.updateFollowStatus(e,t,o),console.log("【关注缓存】切换关注状态成功: ".concat(e," -> ").concat(t),o),n(o)}else console.warn("【关注缓存】切换关注状态失败: ".concat(e," -> ").concat(t),a.result),n(null)})).catch((function(r){console.error("【关注缓存】切换关注状态失败: ".concat(e," -> ").concat(t),r),n(null)}))})):Promise.resolve(null)}},{key:"clearUserFollowCache",value:function(e){if(!e)return!1;try{return u(e).clear(),!0}catch(t){return console.log("CatchClause",t),console.log("CatchClause",t),console.error("清理用户关注缓存失败:",t),!1}}},{key:"clearAllFollowCache",value:function(){try{var e=uni.getStorageInfoSync&&uni.getStorageInfoSync(),t=e&&e.keys||[];return t.forEach((function(e){if("string"===typeof e&&e.startsWith("__cm__:follow:")&&e.endsWith(":__keys__")){var t=e.substring("__cm__:".length,e.length-":__keys__".length);try{i.namespace(t,{persistent:!0}).clear()}catch(r){}}})),!0}catch(r){return console.log("CatchClause",r),console.log("CatchClause",r),console.error("清理所有关注缓存失败:",r),!1}}}]),e}(),d=new f;e.exports=d},"139b":function(e,t,r){r("795c"),r("64aa"),r("5c47"),r("a1c1"),r("c223"),r("f7a5");var n=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return String(e).padStart(t,"0")},a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yyyy-MM-dd HH:mm:ss",r=e instanceof Date?e:new Date(e);if(Number.isNaN(r.getTime()))return"";var a={yyyy:String(r.getFullYear()),MM:n(r.getMonth()+1),dd:n(r.getDate()),HH:n(r.getHours()),mm:n(r.getMinutes()),ss:n(r.getSeconds())};return t.replace(/yyyy|MM|dd|HH|mm|ss/g,(function(e){return a[e]}))};e.exports={formatTimeAgo:function(e){var t=new Date,r=new Date(e),n=t.getTime()-r.getTime(),a=Math.floor(n/1e3),o=Math.floor(a/60),l=Math.floor(o/60),i=Math.floor(l/24);if(i>=7){var c=r.getFullYear(),s=("0"+(r.getMonth()+1)).slice(-2),u=("0"+r.getDate()).slice(-2);return"".concat(c,"-").concat(s,"-").concat(u)}return i>=1?"".concat(i,"天前"):l>=1?"".concat(l,"小时前"):o>=1?"".concat(o,"分钟前"):"刚刚"},formatRelativeTime:function(e){var t=Date.now(),r=e instanceof Date?e.getTime():new Date(e).getTime();if(Number.isNaN(r))return"";var n=t-r,o=Math.floor(Math.abs(n)/1e3),l=n>=0?"前":"后";if(o<60)return"刚刚";var i=Math.floor(o/60);if(i<60)return"".concat(i,"分钟").concat(l);var c=Math.floor(i/60);if(c<24)return"".concat(c,"小时").concat(l);var s=Math.floor(c/24);return s<7?"".concat(s,"天").concat(l):a(r,"yyyy-MM-dd")},formatDate:a}},2774:function(e,t,r){r("01a2"),r("e39c"),r("bf0f"),r("844d"),r("18f7"),r("de6c"),r("08eb"),e.exports=function(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},e.exports.__esModule=!0,e.exports["default"]=e.exports},"2b90":function(e,t,r){var n=r("bdbb").default,a=r("4550").default;r("5c47"),r("a1c1"),r("c223"),r("64aa");function o(e){return"undefined"===typeof uni||"function"!==typeof uni.createSelectorQuery?null:uni.createSelectorQuery().in(e)}function l(e,t,r){if("function"!==typeof e.setData){for(var o=t.replace(/\[(.*?)\]/g,".$1").replace(/^\./,""),l=o.split("."),i=e,c=0;c<l.length-1;c+=1){var s=l[c];i[s]&&"object"===n(i[s])||(i[s]={}),i=i[s]}i[l[l.length-1]]=r}else e.setData(a({},t,r))}e.exports={data:function(){return{__galleryImageMeta:{}}},created:function(){"undefined"===typeof this.swiperHeights&&(this.swiperHeights={}),"undefined"===typeof this.imageClampHeights&&(this.imageClampHeights={}),"undefined"===typeof this.imageCache&&(this.imageCache={})},methods:{onImageLoad:function(e){if(e&&e.detail&&e.currentTarget){var t=e.currentTarget.dataset||{},r=e.detail,n=r.width,a=r.height;if(n&&a){var o=function(e){return void 0!==e.galleryKey&&null!==e.galleryKey?e.galleryKey:void 0!==e.postindex&&null!==e.postindex?e.postindex:void 0!==e.postIndex&&null!==e.postIndex?e.postIndex:void 0!==e.index&&null!==e.index?e.index:void 0!==e.postid&&null!==e.postid?e.postid:void 0!==e.postId&&null!==e.postId?e.postId:void 0!==e.imgindex?"gallery-".concat(e.imgindex):"gallery"}(t),l="undefined"!==typeof t.imgindex?t.imgindex:t.imgIndex||0,i=t.type||t.imageType||"single",c="".concat(o,"_").concat(l);this.__galleryImageMeta&&(this.__galleryImageMeta[c]={width:n,height:a}),this.imageCache&&(this.imageCache[c]={width:n,height:a});var s=Number(this.galleryMinImageRatio)||9/16,u=Number(this.galleryMaxImageRatio)||16/9;if("multi"===i&&0===Number(l)){var f=t.swiperSelector||t.gallerySelector||"#swiper-".concat(o);this.__updateSwiperHeight({key:o,selector:f,originalWidth:n,originalHeight:a,minRatio:s,maxRatio:u})}if("single"===i){var d=t.singleSelector||t.imageSelector||"#single-image-".concat(o);this.__updateClampHeight({key:o,selector:d,originalWidth:n,originalHeight:a,minRatio:s})}}}},__updateSwiperHeight:function(e){var t=this,r=e.key,n=e.selector,a=e.originalWidth,i=e.originalHeight,c=e.minRatio,s=e.maxRatio;if(n){var u=o(this);u&&u.select(n).boundingClientRect((function(e){if(e&&e.width){var n=a/i,o=function(e,t,r){return e>r?r:e<t?t:e}(n,c,s),u=e.width/o;l(t,"swiperHeights[".concat(r,"]"),u)}})).exec()}},__updateClampHeight:function(e){var t=this,r=e.key,n=e.selector,a=e.originalWidth,i=e.originalHeight,c=e.minRatio,s=a/i;if(!(s>=c)){var u=n?o(this):null;if(n&&u)u.select(n).boundingClientRect((function(e){if(e&&e.width){var n=e.width/c;l(t,"imageClampHeights.".concat(r),n)}})).exec();else if(this.galleryFallbackWidth){var f=this.galleryFallbackWidth/c;l(this,"imageClampHeights.".concat(r),f)}}}}}},4550:function(e,t,r){r("6a54");var n=r("8bcf");e.exports=function(e,t,r){return t=n(t),t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},e.exports.__esModule=!0,e.exports["default"]=e.exports},"4db6":function(e,t,r){r("6a54");var n=r("8bcf");function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,n(a.key),a)}}e.exports=function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e},e.exports.__esModule=!0,e.exports["default"]=e.exports},5014:function(e,t,r){r("dc8a"),r("01a2"),r("8f71"),r("bf0f"),r("9a2c"),r("aa9c"),r("2797"),r("a644"),r("a03a"),r("6a54");var n=r("4550");function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}e.exports=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e},e.exports.__esModule=!0,e.exports["default"]=e.exports},"56c9":function(e,t,r){r("9e15"),r("884b"),r("01a2"),r("e39c"),r("bf0f"),r("7a76"),r("c9b5"),r("64aa");var n=r("bdbb")["default"];e.exports=function(e,t){if("object"!==n(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var a=r.call(e,t||"default");if("object"!==n(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)},e.exports.__esModule=!0,e.exports["default"]=e.exports},"73e1":function(e,t,r){"use strict";var n=r("29d8");e.exports=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(n)},"795c":function(e,t,r){"use strict";var n=r("8bdb"),a=r("db04").start,o=r("73e1");n({target:"String",proto:!0,forced:o},{padStart:function(e){return a(this,e,arguments.length>1?arguments[1]:void 0)}})},"883d":function(e,t,r){r("7a76"),r("c9b5"),e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.__esModule=!0,e.exports["default"]=e.exports},"8bcf":function(e,t,r){var n=r("bdbb")["default"],a=r("56c9");e.exports=function(e){var t=a(e,"string");return"symbol"===n(t)?t:String(t)},e.exports.__esModule=!0,e.exports["default"]=e.exports},"8e86":function(e,t,r){function n(e){if(!e)return{current:"",urls:[]};if(e.currentTarget&&e.currentTarget.dataset){var t=e.currentTarget.dataset,r=t.src||t.current||t.url||Array.isArray(t.urls)&&t.urls[0]||"",n=t.originalImageUrls||t.urls||t.urlList,a=Array.isArray(n)?n.filter(Boolean):"string"===typeof n&&n?[n]:[];return{current:r,urls:a}}var o=e.current||e.src||Array.isArray(e.urls)&&e.urls[0]||Array.isArray(e.list)&&e.list[0]||"",l=Array.isArray(e.urls)?e.urls.filter(Boolean):Array.isArray(e.list)?e.list.filter(Boolean):[];return{current:o,urls:l}}function a(e){"undefined"!==typeof uni&&uni.showToast&&uni.showToast({title:e,icon:"none"})}r("8f71"),r("bf0f"),e.exports={previewImage:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.fallbackToast,o=void 0===r||r,l=n(e);if(!l.current&&0===l.urls.length)return o&&a("图片数据缺失"),!1;var i=l.urls.length?l.urls:[l.current],c=l.current||i[0];return c&&0!==i.length?uni.previewImage({current:c,urls:i}):(o&&a("图片不可预览"),!1)}}},9376:function(e,t,r){r("7a76"),r("c9b5"),e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.__esModule=!0,e.exports["default"]=e.exports},a7cb:function(e,t,r){var n=r("5014").default,a=r("d189").default,o=r("4cf1").default,l=r("dd7e").default,i=r("46c5").default,c=r("883d").default,s=r("4db6").default;r("bf0f"),r("f3f7"),r("18f7"),r("de6c"),r("9db6"),r("2797"),r("aa9c"),r("8f71"),r("fd3c"),r("dc8a");var u=r("3ab8").default,f=r("c605").default||r("c605"),d=r("11ca"),g=d.cloudCall,h=u.namespace("avatars",{persistent:!0,maxItems:2048}),p=function(){"use strict";function e(){c(this,e),this.loadingAvatars=new Set}return s(e,[{key:"callCloudFunction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return g(e,t,{pageTag:"avatarCache"})}},{key:"getUserAvatar",value:function(e){if(!e)return Promise.resolve(null);var t=h.get(e);return t?(console.log("【头像缓存】命中缓存: ".concat(e)),Promise.resolve(t)):this.loadingAvatars.has(e)?(console.log("【头像缓存】正在加载中，等待: ".concat(e)),this.waitForAvatarLoad(e)):this.loadUserAvatar(e)}},{key:"waitForAvatarLoad",value:function(e){var t=this;return new Promise((function(r){var n=setInterval((function(){if(!t.loadingAvatars.has(e)){clearInterval(n);var a=h.get(e);r(a)}}),100);setTimeout((function(){clearInterval(n),t.loadingAvatars.delete(e),r(null)}),5e3)}))}},{key:"loadUserAvatar",value:function(e){var t=this;return this.loadingAvatars.add(e),console.log("【头像缓存】开始加载头像: ".concat(e)),new Promise((function(r){t.callCloudFunction("getUserProfile",{userId:e}).then(function(){var t=i(l().mark((function t(n){var a,o,i;return l().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!(n.result&&n.result.success&&n.result.userInfo)){t.next=23;break}if(a=n.result.userInfo,o=a.avatarUrl,t.prev=3,"string"!==typeof o||!o.startsWith("cloud://")){t.next=13;break}if(!f||!f.getTempUrl){t.next=11;break}return t.next=8,f.getTempUrl(o);case 8:t.t0=t.sent,t.next=12;break;case 11:t.t0=o;case 12:o=t.t0;case 13:t.next=17;break;case 15:t.prev=15,t.t1=t["catch"](3);case 17:i={avatarUrl:o,nickName:a.nickName,bio:a.bio,lastUpdated:Date.now()},h.set(e,i,{ttlMs:864e5}),console.log("【头像缓存】加载并缓存成功: ".concat(e)),r(i),t.next=25;break;case 23:console.warn("【头像缓存】获取用户信息失败: ".concat(e),n.result),r(null);case 25:case"end":return t.stop()}}),t,null,[[3,15]])})));return function(e){return t.apply(this,arguments)}}()).catch((function(t){console.error("【头像缓存】加载头像失败: ".concat(e),t),r(null)})).finally((function(){t.loadingAvatars.delete(e)}))}))}},{key:"getBatchUserAvatars",value:function(e){var t=this;if(!e||0===e.length)return Promise.resolve({});var r={},n=[];return e.forEach((function(e){var t=h.get(e);t?r[e]=t:n.push(e)})),n.length>0?(console.log("【头像缓存】批量加载头像: ".concat(n.length,"个")),new Promise((function(e){t.callCloudFunction("getBatchUserProfiles",{userIds:n}).then(function(){var t=i(l().mark((function t(n){var a,i,c,s,u;return l().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!(n.result&&n.result.success&&n.result.userProfiles)){t.next=35;break}a=o(n.result.userProfiles),t.prev=2,a.s();case 4:if((i=a.n()).done){t.next=27;break}if(c=i.value,!c||!c._openid){t.next=25;break}if(s=c.avatarUrl,t.prev=8,"string"!==typeof s||!s.startsWith("cloud://")){t.next=18;break}if(!f||!f.getTempUrl){t.next=16;break}return t.next=13,f.getTempUrl(s);case 13:t.t0=t.sent,t.next=17;break;case 16:t.t0=s;case 17:s=t.t0;case 18:t.next=22;break;case 20:t.prev=20,t.t1=t["catch"](8);case 22:u={avatarUrl:s,nickName:c.nickName,bio:c.bio,lastUpdated:Date.now()},r[c._openid]=u,h.set(c._openid,u,{ttlMs:864e5});case 25:t.next=4;break;case 27:t.next=32;break;case 29:t.prev=29,t.t2=t["catch"](2),a.e(t.t2);case 32:return t.prev=32,a.f(),t.finish(32);case 35:e(r);case 36:case"end":return t.stop()}}),t,null,[[2,29,32,35],[8,20]])})));return function(e){return t.apply(this,arguments)}}()).catch((function(t){console.error("【头像缓存】批量加载失败:",t),e(r)}))}))):Promise.resolve(r)}},{key:"preloadAvatarsFromPosts",value:function(e){var t=this;if(e&&0!==e.length){var r=a(new Set(e.map((function(e){return e._openid})).filter(Boolean)));0!==r.length&&setTimeout((function(){t.getBatchUserAvatars(r).then((function(e){console.log("【头像缓存】预加载完成: ".concat(Object.keys(e).length,"个头像"))}))}),100)}}},{key:"updateUserAvatar",value:function(e,t){if(!e||!t)return!1;var r=n(n({},t),{},{lastUpdated:Date.now()});try{return h.set(e,r,{ttlMs:864e5}),!0}catch(a){return!1}}},{key:"clearUserAvatar",value:function(e){if(!e)return!1;try{return h.delete(e),!0}catch(t){return!1}}},{key:"getDefaultAvatar",value:function(){return"/static/images/avatar.png"}}]),e}(),v=new p;e.exports=v},d189:function(e,t,r){var n=r("e2db"),a=r("2774"),o=r("79b7"),l=r("9376");e.exports=function(e){return n(e)||a(e)||o(e)||l()},e.exports.__esModule=!0,e.exports["default"]=e.exports},db04:function(e,t,r){"use strict";var n=r("bb80"),a=r("c435"),o=r("9e70"),l=r("f298"),i=r("862c"),c=n(l),s=n("".slice),u=Math.ceil,f=function(e){return function(t,r,n){var l,f,d=o(i(t)),g=a(r),h=d.length,p=void 0===n?" ":o(n);return g<=h||""===p?d:(l=g-h,f=c(p,u(l/p.length)),f.length>l&&(f=s(f,0,l)),e?d+f:f+d)}};e.exports={start:f(!1),end:f(!0)}},e2db:function(e,t,r){var n=r("e476");e.exports=function(e){if(Array.isArray(e))return n(e)},e.exports.__esModule=!0,e.exports["default"]=e.exports}}]);