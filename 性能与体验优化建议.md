# 性能与用户体验优化建议（uni-app + 腾讯云 CloudBase）

本文基于当前代码库实际结构与配置提出可落地的性能与体验优化方案。项目要点：
- 前端：uni-app（Vue 2），跨端：微信小程序、H5、App
- 云端：CloudBase（wx-server-sdk/@cloudbase/js-sdk），Node.js 16.13
- 主要功能：内容流、用户体系、文件/图片上传、消息与互动

建议分为“快速收益”“结构性优化”“可观测与质量保障”三个层次，并给出变更指引（含文件定位）。

---

## 快速收益（1–2 天）

- 首页首屏只渲染必要元素
  - 现状：`pages/index/index.vue` 首屏包含消息角标、搜索框、列表骨架等；图片懒加载已开启（`:lazy-load="true"`）。
  - 优化：
    - 控制列表首屏渲染数量（如前 5–8 条），下滑再按需追加，减少初始计算与布局抖动。
    - 为图片容器设置固定宽高比占位（已有 `:style="item.imageStyle"`，建议统一产出比例占位，避免重排）。

- 批量与缓存临时 URL（getTempFileURL）
  - 现状：`functions/getPostList/index.js`、`functions/getHotFeed/index.js` 已做去重后批量获取，但每次请求都会调用。
  - 优化：
    - 客户端增加 fileID→tempURL 的 LRU 缓存（带 TTL，例如 50–55 分钟），同一会话内复用，减少云端调用次数。
    - 列表分页滚动时，将新出现的 fileID 批量加入待解析队列，节流 200–400ms 合并请求。

- 减少聚合中的大表 lookup
  - 现状：聚合阶段多次 `lookup`（users、comments、votes_log），在列表页调用频率高。
  - 优化：
    - 列表页不实时统计评论数量：用文档上的 `commentCount` 字段，评论增删时触发器或事务维护计数，移除对 `comments` 的 `lookup` 与 `$.size()`。
    - 列表页不做用户信息 `lookup`：在 `posts` 中冗余写入作者昵称与头像快照（`authorNameSnapshot`、`authorAvatarSnapshot`），详情页再做精准补全。

- 小程序分包
  - 现状：`pages.json` 中 `subPackages: []`，未启用分包；`lazyCodeLoading: "requiredComponents"` 已设置。
  - 优化：
    - 将非首屏页面划入分包（如：`post-detail`、`image-manager`、`feedback-*`、`register/login`）。
    - 可将 `discover` 等非必要首屏页放独立分包，显著降低首包体积与冷启动时间。

- 静态资源按需加载
  - 现状：`uni_modules/mp-html` 与若干组件体积较大。
  - 优化：
    - 仅在需要富文本渲染的页面注册 `mp-html` 组件；H5 端可使用异步组件（`() => import('...')`）。
    - 图标与小图用 `sprite`/`iconfont`，减少请求；H5 端启用 HTTP 缓存（静态托管/CDN）。

- 统一 Toast/Loading/空态
  - 现状：多处手动 `uni.showToast`，风格不一。
  - 优化：封装 `ui/feedback.ts`（或 js）统一：加载、成功、失败、重试按钮、弱网提示，避免重复代码与不一致体验。

---

## 结构性优化（1–2 周）

- 数据模型与索引
  - 为高频查询建立复合索引（CloudBase 控制台）：
    - `posts`: `{ createTime: -1 }`（列表按时间倒序）；
    - `posts`: `{ isOriginal: 1, createTime: -1 }`（原创筛选）；
    - `posts`: `{ isPoem: 1, createTime: -1 }`（诗歌筛选）；
    - 若标签查询使用 `tags` 精确匹配，考虑 `{ tags: 1, createTime: -1 }`；
    - `votes_log`: `{ postId: 1, _openid: 1 }`。
  - 尽量避免在聚合中用 `$.size('comments')` 统计；维护 `commentCount` 字段并做乐观更新与兜底修正任务（定时校正）。

- 热度分值预计算
  - 现状：`getHotFeed` 在聚合阶段用 `$add/$multiply` 计算 `hotScore` 并排序，开销随数据量放大。
  - 优化：
    - 在投票、评论等动作发生时，通过云函数更新 `posts.hotScore`（增量计算），并建立 `{ hotScore: -1, createTime: -1 }` 索引，列表直接按字段排序。

- 云函数冷启动与依赖
  - 使用 SCF 公共层（Layer）/公共依赖，减少每个函数的重复依赖体积（`wx-server-sdk` 等）。
  - 将通用工具抽到 `functions/_common/`，各函数通过相对引用或 layer 共享；把 SDK 初始化放在文件模块作用域，避免每次 `exports.main` 重复初始化。
  - 若环境支持，云函数运行时升级至 Node.js 18 LTS，获得更好的性能与安全加固。

- 上传链路与图片策略
  - H5：优先使用直传（`tcb.uploadFile`），回退到 Base64→云函数路径；限制并发（3–4）并展示进度。
  - 小程序：`compressImage`/`uni.compressImage`（质量 0.6–0.8）+ 宽度上限（如 1440px），缩短上传与渲染时间。
  - 统一生成多规格图（封面/列表/原图），CDN（COS/静态托管）按 URL 参数做裁剪与 WebP 输出，降低流量与白屏时间。

- 列表与滚动体验
  - 长列表采用“虚拟列表”（H5 可用社区组件，mp 端可自研简化版：固定高度或可预估高度），避免一次性渲染过多节点。
  - 使用节流/防抖处理滚动监听；下拉刷新与触底加载提供显式的 Loading/结束提示。

- 登录与全局状态
  - 现状：在 `main.js` 对 `tcbApp.callFunction` 注入 openid，逻辑清晰。
  - 优化：
    - 抽象 `auth/session.ts`（或 js），统一：登录态恢复、openid 缓存、失效重登、游客模式；
    - Splash →（检查本地会话/静默续期）→ Index 的链路保证 300–500ms 内可见首屏骨架与首批数据。

---

## H5 端专项（静态托管/CDN）

- 打包与代码分割
  - 分析 `unpackage/dist/build/web/static/js/chunk-vendors.*.js` 体积，按路由/页面做更细粒度的动态 import；
  - 移除未使用的组件与 polyfill；仅在必要页面引入 `mp-html` 与第三方库。

- 缓存策略
  - 开启静态资源长缓存（文件名指纹），HTML 短缓存；使用 `preload/prefetch` 预取下一个可能访问的页面脚本。

- 交互优化
  - 键盘与输入法适配（移动端）：避免输入框被遮挡；点击外部区域收起键盘；
  - 使用 `IntersectionObserver` 控制懒加载与曝光埋点。

---

## 可观测与质量保障（持续）

- 性能与错误监控
  - 启用 `manifest.json` 中的统计能力或接入 Sentry/友盟：捕获报错、接口耗时、白屏时间、路由切换耗时。
  - 云函数：记录每个函数的入参概要、耗时分位（P50/P90）、依赖错误，配合报警与仪表盘。

- 灰度与回滚
  - 采用分环境配置（dev/test/prod），静态托管走灰度发布；云函数版本化管理与一键回滚。

- 质量基线
  - ESlint + Prettier，提交时校验；关键模块补充单测（工具方法/纯函数优先）。

---

## 变更指引（文件定位）

- 小程序分包
  - `pages.json`：配置 `subPackages`，将 `post-detail`、`image-manager`、`feedback-*`、`register/login` 等挪到分包；为 `pages/index/index` 等首屏配置 `preloadRule`。 

- 临时 URL 缓存
  - 新增 `src/utils/file-url-cache.js`（示例命名），导出 `getTempUrls(fileIds)`：内部做去重、节流与 TTL 缓存；列表滚动时批量调用。

- 列表聚合下沉
  - `functions/getPostList/index.js`、`functions/getHotFeed/index.js`：
    - 用 `posts.commentCount` 替换对 `comments` 的 `lookup` 与 `$.size()`；
    - 文章作者昵称/头像使用冗余字段（如 `authorNameSnapshot`/`authorAvatarSnapshot`）。

- 热度分值与索引
  - 新增触发器或在投票/评论函数中维护 `posts.hotScore`；为 `hotScore` 建 `{ hotScore: -1, createTime: -1 }` 索引。

- 图片处理
  - 上传前对大图压缩（H5 用 canvas，mp 用 `compressImage`）；生成不同规格 URL；在列表页优先使用小图。

---

## 优先级路线图

1. 第 1–2 天（快打快撤）
   - 启用分包；列表首屏裁剪；临时 URL 客户端缓存；统一 Toast/Loading 反馈。
2. 第 3–5 天（数据与函数）
   - 建索引；去除列表页 `lookup`；引入作者信息冗余；部署图片压缩链路。
3. 第 2 周（稳定提升）
   - 热度分值预计算；虚拟列表；监控与告警上线；H5 代码分割与缓存策略完善。

---

## 成效预期（经验区间）

- 首包体积与首屏可见：小程序冷启动 TTI 预计下降 20%–40%。
- 列表请求服务端耗时：去除 `lookup` 后聚合耗时降低 30%–60%。
- 图片链路总时延：压缩与多规格图+CDN 后流量下降 40%–70%。
- 云函数费用：批量/缓存 `getTempFileURL` 与依赖去重后，调用数与执行时长都有可观下降。

---

如需，我可以按上述“变更指引”为项目创建脚手架文件（分包示例、URL 缓存工具、索引清单）并提交初始改动，便于你逐步上线。

