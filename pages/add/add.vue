<template>
    <!-- pages/add/add.wxml -->
    <view class="container">
        <!-- ÂõæÁâáÈ¢ÑËßàÂå∫Âüü -->
        <view v-if="imageList.length > 0" class="image-section">
            <scroll-view class="image-preview-scroll" :scroll-x="true" :show-scrollbar="false">
                <view class="image-preview-container">
                    <view class="image-preview-item" v-for="(item, index) in imageList" :key="index">
                        <image class="preview-image" :src="item.previewUrl" mode="aspectFill" @error="onImageError"></image>

                        <view class="image-remove-btn" @tap="removeImage" :data-index="index">√ó</view>
                    </view>
                    <view v-if="imageList.length < maxImageCount" class="add-image-btn" @tap="handleChooseImage">
                        <view class="add-icon">+</view>
                    </view>
                </view>
            </scroll-view>
        </view>

        <!-- È¢úËâ≤ÈÄâÊã©ÂºπÂ±Ç -->
        <view v-if="showColorPicker" class="color-picker-mask" @tap="showColorPicker=false">
            <view class="color-picker" @tap.stop="noop">
                <view class="color-grid">
                    <view v-for="c in availableColors" :key="c" class="color-swatch" :style="{ backgroundColor: c }" @tap="chooseColor" :data-color="c">
                        <text v-if="selectedBackgroundColor === c" class="color-check">‚úì</text>
                    </view>
                </view>
                <view class="color-tip">‰ªÖÂΩ±Âìç‚ÄúË∑Ø‚ÄùÈ°µÂç°ÁâáÂ∫ïËâ≤</view>
            </view>
        </view>

        <!-- ÂÜÖÂÆπËæìÂÖ•Âå∫Âüü -->
        <view class="content-section">
  
            <!-- Ê≠£ÊñáËæìÂÖ•Âå∫Âüü -->
            <view class="content-input-wrapper" :data-highlight-mode="highlightModeEnabled">
                <textarea
                    class="content-textarea"
                    placeholder="Ê≠§Âàª‰Ω†ÊÉ≥Ë¶ÅÂàÜ‰∫´..."
                    @input="onContentInput"
                    @tap="onTextareaTap"
                    maxlength="1500"
                    :value="content"
                    :show-confirm-bar="false"
                    :adjust-position="false"
                    @focus="onTextareaFocus"
                    @blur="onTextareaBlur"
                    @scroll="onTextareaScroll"
                ></textarea>
                <view v-if="content.length > 1400" class="char-count">{{ content.length }}/1500</view>

                <!-- ÈïøÊåâÈÄâÊã©Ë¶ÜÁõñÂ±Ç -->
                <view v-if="content.trim() && highlightModeEnabled"
                      class="highlight-select-overlay"
                      @touchstart="onOverlayTouchStart"
                      @touchend="onOverlayTouchEnd"
                      @touchmove="onOverlayTouchMove"
                      catchtouchmove="true">
                    <scroll-view class="overlay-scroll" :scroll-y="true" :scroll-top="overlayScrollTop">
                        <view class="overlay-content">
                            <view v-for="(line, i) in splitContentLines"
                                  :key="'overlay-line-' + i"
                                  :class="'overlay-line ' + (highlightSelectedLineIndices.includes(i) ? 'highlighted' : '')"
                                  :data-index="i"
                                  @touchstart="onLineTouchStart"
                                  @touchend="onLineTouchEnd">
                                <view class="overlay-line-content">{{ line || ' ' }}</view>
                            </view>
                        </view>
                    </scroll-view>
                </view>

                <!-- Right-side vertical toolbar (placeholders) -->
                <view class="side-toolbar">
                    <view class="side-tool-btn" @tap="handleChooseImage"><view class="side-tool-icon">IMG</view></view>
                      <view class="side-tool-btn" @tap="toggleTagSelector"><view class="side-tool-icon">#</view></view>
                    <view class="side-tool-btn" @tap="onSelectColor"><view class="side-tool-icon">Ëâ≤</view></view>
                    <view class="side-tool-btn" @tap="toggleHighlightMode"><view class="side-tool-icon">È´ò</view></view>
                    <view class="side-tool-btn" @tap="switchMode"><view class="side-tool-icon">Ê®°</view></view>
                    <view class="side-tool-btn" @tap="goToPreview"><view class="side-tool-icon">‚ûî</view></view>
                </view>

                <!-- È´òÂÖâÈÄâÊã©ÊèêÁ§∫ -->
                <view v-if="showHighlightHint" class="highlight-hint">
                    <text class="hint-text">ÈïøÊåâÊñáÂ≠óÂç≥ÂèØÈÄâÊã©È´òÂÖâË°å</text>
                    <view class="hint-close" @tap="hideHighlightHint">√ó</view>
                </view>

                <!-- ÊóßÁöÑÈ´òÂÖâÈÄâÊã©ÂºπÂ±ÇÔºà‰øùÁïô‰Ωú‰∏∫Â§áÁî®Ôºâ -->
                <view v-if="highlightSelecting" class="highlight-overlay" catchtouchmove="true" @tap="noop">
                    <scroll-view class="highlight-scroll" :scroll-y="true">
                        <view v-for="(line, i) in splitContentLines" :key="i"
                              :class="'hl-line ' + (highlightSelectedLineIndices.includes(i) ? 'selected' : '')"
                              @tap.stop.prevent="toggleHighlightLine" :data-index="i">
                            <text class="hl-text">{{ line.length ? line : ' ' }}</text>
                        </view>
                    </scroll-view>
                    <view class="hl-actions">
                        <button class="hl-done" size="mini" @tap.stop.prevent="finishHighlight">ÂÆåÊàê</button>
                        <button class="hl-clear" size="mini" @tap.stop.prevent="clearHighlight">Ê∏ÖÈô§</button>
                    </view>
                </view>
            </view>
        </view>

        <!-- Ê®°ÂºèÈÄâÊã©Âô® -->
        <view v-if="showModeSelector" class="mode-selector">
            <view class="mode-title">ÈÄâÊã©ÂèëÂ∏ÉÊ®°Âºè</view>
            <view class="mode-grid">
                <view class="mode-item" @tap="selectPublishMode" :data-mode="'poem'" :data-original="true">
                    <view class="mode-icon">‚ú®</view>
                    <view class="mode-text">ÂéüÂàõËØóÊ≠å</view>
                </view>
                <view class="mode-item" @tap="selectPublishMode" :data-mode="'poem'" :data-original="false">
                    <view class="mode-icon">üìñ</view>
                    <view class="mode-text">ÈùûÂéüÂàõËØóÊ≠å</view>
                </view>
                <view class="mode-item" @tap="selectPublishMode" :data-mode="'normal'" :data-original="null">
                    <view class="mode-icon">üìù</view>
                    <view class="mode-text">ÊôÆÈÄöÂ∏ñÂ≠ê</view>
                </view>
                <view class="mode-item" @tap="selectPublishMode" :data-mode="'discussion'" :data-original="null">
                    <view class="mode-icon">üí¨</view>
                    <view class="mode-text">ËÆ®ËÆ∫Â∏ñÂ≠ê</view>
                </view>
            </view>
        </view>

        <!-- Ê†áÁ≠æÈÄâÊã©Âå∫Âüü -->
        <view v-if="showTagSelector" class="tag-section" :style="'bottom: 120rpx;'">
            <view class="tag-header">
                <text class="tag-title">Ê∑ªÂä†Ê†áÁ≠æ</text>
                <text class="tag-count">{{ selectedTags.length }}/5</text>
                <text class="tag-toggle" @tap="toggleTagSelector">Êî∂Ëµ∑</text>
            </view>

            <!-- Â∑≤ÈÄâÊ†áÁ≠æÊòæÁ§∫ -->
            <view v-if="selectedTags.length > 0" class="selected-tags">
                <view class="selected-tag" v-for="(item, index) in selectedTags" :key="index">
                    <text>{{ item }}</text>

                    <text class="remove-tag" @tap="removeTag" :data-tag="item">√ó</text>
                </view>
            </view>

            <!-- Ê†áÁ≠æÈÄâÊã©Âô® -->
            <view v-if="showTagSelector" class="tag-selector">
                <!-- ÂàÜÁ±ªÈÄâÊã©Âô® -->
                <view class="category-selector">
                    <scroll-view class="category-scroll" :scroll-x="true" :show-scrollbar="false">
                        <view class="category-list">
                            <view
                                :class="'category-item ' + (currentCategoryIndex === index ? 'active' : '')"
                                @tap="switchCategory"
                                :data-index="index"
                                v-for="(item, index) in tagCategories"
                                :key="index"
                            >
                                <text class="category-icon">{{ item.icon }}</text>

                                <text class="category-name">{{ item.name }}</text>
                            </view>
                        </view>
                    </scroll-view>
                </view>

                <!-- ÂΩìÂâçÂàÜÁ±ªÁöÑÊ†áÁ≠æ -->
                <view class="current-category-tags">
                    <view
                        :class="'preset-tag ' + (selectedTags.includes(item) ? 'selected' : '')"
                        @tap="selectTag"
                        :data-tag="item"
                        v-for="(item, index) in tagCategories[currentCategoryIndex].tags"
                        :key="index"
                    >
                        {{ item }}
                    </view>
                </view>

                <!-- Ëá™ÂÆö‰πâÊ†áÁ≠æËæìÂÖ• -->
                <view class="custom-tag-input">
                    <input placeholder="ËæìÂÖ•Ëá™ÂÆö‰πâÊ†áÁ≠æ" :value="customTag" @input="onCustomTagInput" maxlength="10" />
                    <button size="mini" @tap="addCustomTag">Ê∑ªÂä†</button>
                </view>

                <!-- ÂåπÈÖçÁöÑÊ†áÁ≠æÊé®Ëçê -->
                <view v-if="showMatchedTags && matchedTags.length > 0" class="matched-tags">
                    <view class="matched-tags-title">Êé®ËçêÊ†áÁ≠æÔºö</view>
                    <view class="matched-tags-list">
                        <view class="matched-tag" @tap="selectMatchedTag" :data-tag="item" v-for="(item, index) in matchedTags" :key="index">
                            {{ item }}
                        </view>
                    </view>
                </view>
            </view>
        </view>
    </view>
    <!-- Ëøô‰∏™ </view> ÊòØÁî®Êù•Èó≠ÂêàÊúÄÂ§ñÂ±ÇÁöÑ <view class="container"> ÁöÑ -->
</template>

<script>
// pages/add/add.js
// ‰øÆÂ§çÔºöÁßªÈô§ÂÖ®Â±ÄÊï∞ÊçÆÂ∫ìÂÆû‰æãÔºåÊîπ‰∏∫Âú®ÊñπÊ≥ï‰∏≠Âä®ÊÄÅËé∑Âèñ
const { cloudCall } = require('../../utils/cloudCall.js');
export default {
    data() {
        return {
            content: '',
            // ÈÄâÊã©È¢úËâ≤
            selectedBackgroundColor: '#a4c4bd',
            availableColors: ['#a4c4bd','#c9cfcf','#906161','#909388'],
            showColorPicker: false,

            // È´òÂÖâÈÄâÊã©
            highlightSelecting: false,
            highlightSelectedLineIndices: [],
            highlightLines: [],
            // È´òÂÖâÂè•ÔºàÂÖºÂÆπÊóßÂ≠óÊÆµÔºâ
            highlightSentence: '',

            // Êñ∞ÁöÑË¶ÜÁõñÂ±ÇÁõ∏ÂÖ≥Áä∂ÊÄÅ
            overlayScrollTop: 0,
            textareaScrollTop: 0,
            showHighlightHint: false,
            highlightModeEnabled: false,
            longPressTimer: null,
            touchStartLine: null,
            imageList: [],

            // ÂõæÁâáÂàóË°®ÔºåÂåÖÂê´ÂéüÂõæÂíåÂéãÁº©Âõæ‰ø°ÊÅØ
            maxImageCount: 9,

            // ÊúÄÂ§ßÂõæÁâáÊï∞Èáè
            publishMode: 'normal',

            // 'normal' | 'poem' | 'discussion' ÊôÆÈÄöÊ®°Âºè | ËØóÊ≠åÊ®°Âºè | ËÆ®ËÆ∫Ê®°Âºè
            isOriginal: false,

            // ÊòØÂê¶ÂéüÂàõ
            showModeSelector: false,

            // ÊòØÂê¶ÊòæÁ§∫Ê®°ÂºèÈÄâÊã©Âô®

            // ËÆ®ËÆ∫Ê®°ÂºèÁõ∏ÂÖ≥
            isDiscussion: false,
            parentPostId: '',
            parentPostInfo: null,
            canPublish: false,

            // ÊòØÂê¶ÂèØ‰ª•ÂèëÂ∏É
            selectedTags: [],

            // ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
            customTag: '',

            // Ëá™ÂÆö‰πâÊ†áÁ≠æËæìÂÖ•
            showTagSelector: false,

            // ÊòØÂê¶ÊòæÁ§∫Ê†áÁ≠æÈÄâÊã©Âô®
            currentCategoryIndex: 0,

            // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂàÜÁ±ªÁ¥¢Âºï
            allExistingTags: [],

            // ÊâÄÊúâÂ∑≤ÊúâÊ†áÁ≠æ
            matchedTags: [],

            // ÂåπÈÖçÁöÑÊ†áÁ≠æ
            showMatchedTags: false,

            // ÊòØÂê¶ÊòæÁ§∫ÂåπÈÖçÁöÑÊ†áÁ≠æ
            isPublished: false,

            // ÊòØÂê¶Â∑≤ÂèëÂ∏ÉÊàêÂäüÔºåÁî®‰∫éÈÅøÂÖçÂèëÂ∏ÉÂêéÂÜçÊ¨°ËØ¢ÈóÆ‰øùÂ≠òËçâÁ®ø
            isTemporaryHide: false,

            // ÊòØÂê¶‰∏¥Êó∂ÈöêËóèÔºàÂ¶ÇÈÄâÊã©ÂõæÁâáÔºâÔºåÁî®‰∫éÈÅøÂÖçËß¶ÂèëËçâÁ®ø‰øùÂ≠ò
            author: '',

            // ‰ΩúËÄÖ‰ø°ÊÅØ
            keyboardHeight: 0,

            // ÈîÆÁõòÈ´òÂ∫¶

            // Ê†áÁ≠æÂàÜÁ±ªÊï∞ÊçÆ
            tagCategories: [
                {
                    name: 'ÂÜÖÂÆπ‰∏ªÈ¢ò',
                    icon: 'üìù',
                    tags: [
                        'Áà±ÊÉÖ',
                        '‰∫≤ÊÉÖ',
                        'ÂèãÊÉÖ',
                        '‰π°ÊÑÅ',
                        'ÊÄùÂøµ',
                        'Â≠§Áã¨',
                        'ÂíèÁâ©',
                        'Â±±Ê∞¥',
                        'Áî∞Âõ≠',
                        'Â≠£ËäÇ',
                        'Êò•Â§©',
                        'Â§èÊó•',
                        'ÁßãÈ£é',
                        'ÂÜ¨Èõ™',
                        '‰∫∫Áîü',
                        'ÁêÜÊÉ≥',
                        'Âì≤ÁêÜ',
                        'Êó∂Èó¥',
                        'ÈùíÊò•',
                        'ÊàêÈïø',
                        'ÁîüÊ≠ª',
                        'ÊÄÄÂè§',
                        'ÂíèÂè≤',
                        'ËæπÂ°û',
                        'Êàò‰∫â',
                        'Áà±ÂõΩ',
                        'ÂüéÂ∏Ç',
                        '‰π°Êùë',
                        'ÁîüÊ¥ª',
                        'ÊóÖË°å',
                        'È•ÆÈ£ü',
                        'Âä≥Âä®'
                    ]
                },
                {
                    name: 'ÊÉÖÊÑüÂü∫Ë∞É',
                    icon: 'üí≠',
                    tags: [
                        'Ê≤ªÊÑà',
                        'Ê∏©Êöñ',
                        'Êµ™Êº´',
                        'ÂîØÁæé',
                        'ÊÇ≤‰º§',
                        '‰º§ÊÑü',
                        'ÊÉÜÊÄÖ',
                        'ÂØÇÂØû',
                        'Ë±™Êîæ',
                        'Ë±ÅËææ',
                        'ÊøÄÊòÇ',
                        'ÁÉ≠Ë°Ä',
                        'Â©âÁ∫¶',
                        'ÁªÜËÖª',
                        'Ê∏ÖÊñ∞',
                        'ÂÆÅÈùô',
                        'Âä±Âøó',
                        'ÈºìËàû',
                        'ÂùöÂÆö',
                        'ÂÖÖÊª°Â∏åÊúõ',
                        'ËÆΩÂà∫',
                        'ÊâπÂà§',
                        'Ê∑±Ê≤â',
                        'Âºï‰∫∫Ê∑±ÊÄù'
                    ]
                },
                {
                    name: 'ÂΩ¢Âºè‰ΩìË£Å',
                    icon: 'üìñ',
                    tags: [
                        'Âè§‰ΩìËØó',
                        'Ëøë‰ΩìËØó',
                        '‰∫îË®Ä',
                        '‰∏ÉË®Ä',
                        'ÁªùÂè•',
                        'ÂæãËØó',
                        'ËØç',
                        'Êõ≤',
                        '‰πêÂ∫ú',
                        'È™ö‰Ωì',
                        'Áé∞‰ª£ËØó',
                        'Ëá™Áî±ËØó',
                        'Êï£ÊñáËØó',
                        'ÂçÅÂõõË°åËØó',
                        'Âèô‰∫ãËØó',
                        '‰ø≥Âè•',
                        'Áü≠Ê≠å',
                        'Âè≤ËØó',
                        'ÈïøËØó',
                        'Áü≠ËØó',
                        'ÂæÆÂûãËØó',
                        '‰∏âË°åËØó'
                    ]
                },
                {
                    name: 'ÊÑèË±°ÂÖÉÁ¥†',
                    icon: 'üåô',
                    tags: [
                        'Êúà‰∫Æ',
                        'ÊòüÊòü',
                        'Â§™Èò≥',
                        'ÂÆáÂÆô',
                        'Èì∂Ê≤≥',
                        'È£é',
                        'Èõ®',
                        'Èõ™',
                        '‰∫ë',
                        'Èõæ',
                        'Ê≤≥ÊµÅ',
                        'Â§ßÊµ∑',
                        'Â±±Â≥∞',
                        'Ê£ÆÊûó',
                        'Ëä±',
                        'Ëçâ',
                        'Ê†ë',
                        'È∫¶Áî∞',
                        'ËêΩÂè∂',
                        'Ê¢Ö',
                        'ÂÖ∞',
                        'Á´π',
                        'Ëèä',
                        'È∏ü',
                        'È©¨',
                        'Ëùâ',
                        'È±º',
                        'Ëù¥Ëù∂',
                        'ÈÖí',
                        'Ââë',
                        'Áê¥',
                        'ÁÅØ',
                        'Ëàπ',
                        'ÈïúÂ≠ê',
                        'Á∫¢Ëâ≤',
                        'ÁôΩËâ≤',
                        'ËìùËâ≤',
                        'ÈáëËâ≤'
                    ]
                },
                {
                    name: 'È£éÊ†ºÊµÅÊ¥æ',
                    icon: 'üé≠',
                    tags: [
                        'ÂîêËØó',
                        'ÂÆãËØç',
                        'ÂÖÉÊõ≤',
                        'ÂÖàÁß¶',
                        '‰∏§Ê±â',
                        'È≠èÊôã',
                        'Âª∫ÂÆâÈ£éÈ™®',
                        'Êú¶ËÉßËØó',
                        'Êñ∞ÊúàÊ¥æ',
                        'Êµ™Êº´‰∏ª‰πâ',
                        'Áé∞ÂÆû‰∏ª‰πâ',
                        'Ë±°ÂæÅ‰∏ª‰πâ',
                        'Áé∞‰ª£‰∏ª‰πâ',
                        'ÊÑèË±°Ê¥æ',
                        'ÂûÆÊéâÁöÑ‰∏Ä‰ª£',
                        '‰∏≠ÊñáËØó',
                        'Ëã±ÊñáËØó',
                        'Êó•ÊñáËØó',
                        'Ê≥ïÊñáËØó',
                        'ÁøªËØëËØó',
                        '‰∏≠ÂõΩ',
                        'Ëã±ÂõΩ',
                        'ÁæéÂõΩ',
                        'Êó•Êú¨',
                        '‰øÑÁΩóÊñØ'
                    ]
                },
                {
                    name: 'Âú∫ÊôØÁî®ÈÄî',
                    icon: 'üéØ',
                    tags: [
                        'ÊôöÂÆâËØó',
                        'Êó©ÂÆâÈóÆÂÄô',
                        'ËäÇÊó•Á•ùÁ¶è',
                        'Êò•ËäÇ',
                        '‰∏≠Áßã',
                        'ÊÉÖ‰∫∫ËäÇ',
                        'ÊØï‰∏öÂ≠£',
                        'Â©öÁ§ºËá¥Ëæû',
                        'ÊóÖË°åÈÄî‰∏≠',
                        'Èõ®Â§©ËØªËØó',
                        'ÂÜôÁªôÂ≠©Â≠ê',
                        'Ëá¥Êï¨ÊØç‰∫≤',
                        'ÈÄÅÁªôÊúãÂèã',
                        'ÈÄÇÂêàÊëòÊäÑ',
                        'ÂèØ‰ª•Áî®‰ΩúÁ≠æÂêç'
                    ]
                }
            ],

            tags: []
        };
    },
    computed: {
        splitContentLines() {
            const raw = this.content || '';
            return raw.split(/\r?\n/);
        }
    },
    onLoad: function (options) {
        // ÂàùÂßãÂåñÈ¢úËâ≤/È´òÂÖâÁºñËæëÁõ∏ÂÖ≥Áä∂ÊÄÅÔºàÂêëÂêéÂÖºÂÆπÔºâ
        this.setData({
            selectedBackgroundColor: this.selectedBackgroundColor || '#a4c4bd',
            availableColors: this.availableColors || ['#a4c4bd','#c9cfcf','#906161','#909388'],
            showColorPicker: false,
            highlightSentence: this.highlightSentence || ''
        });
        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊâÄÊúâÂ∑≤ÊúâÊ†áÁ≠æ
        this.loadAllExistingTags();

        // Ê£ÄÊü•ÊòØÂê¶ÊòØÁºñËæëËçâÁ®øÊ®°Âºè
        if (options.mode === 'edit') {
            this.loadEditingDraft();
        } else {
            // Âä†ËΩΩËçâÁ®ø
            this.loadDraft();
        }

        // Á°Æ‰øùÈ°µÈù¢‰∏ç‰ºöÊªöÂä®
        this.preventPageScroll();
    },
    onShow: function () {
        // ÊØèÊ¨°ÊòæÁ§∫È°µÈù¢Êó∂ÈÉΩÁ°Æ‰øùÈ°µÈù¢‰∏ç‰ºöÊªöÂä®
        this.preventPageScroll();
    },
    onUnload: function () {
        // Âè™ÊúâÁúüÊ≠£ÈÄÄÂá∫ÂèëÂ∏ÉÈ°µÊó∂ÊèêÁ§∫‰øùÂ≠òËçâÁ®øÔºàÂ∑≤ÂèëÂ∏ÉÁöÑ‰∏çÊèêÁ§∫Ôºâ
        if ( !this.isPublished) {
            this.exitWithOptionalSave();
        }
    },
    onHide: function () {
        // ÂÖ∂ÂÆÉÊÉÖÂÜµ‰∏çÂÜçÊèêÁ§∫Ôºå‰ªÖÈáçÁΩÆ‰∏¥Êó∂ÈöêËóèÊ†áÂøó
        this.setData({ isTemporaryHide: false });
    },
    // App/H5ÔºöÊã¶Êà™Áâ©ÁêÜËøîÂõûÔºå‰ºòÂÖàÂºπÂá∫ËçâÁ®øÊèêÁ§∫
    onBackPress: function () {
        if (!this.isPublished && this.hasContent()) {

            this.exitWithOptionalSave();
        }
        return false;
    },
    methods: {
        // Áªü‰∏Ä‰∫ëÂáΩÊï∞Ë∞ÉÁî®ÊñπÊ≥ï
        callCloudFunction(name, data = {}, extraOptions = {}) {
            return cloudCall(name, data, Object.assign({ pageTag: 'add', context: this, requireAuth: true }, extraOptions));
        },

        // Âä†ËΩΩÊâÄÊúâÂ∑≤ÊúâÊ†áÁ≠æ
        loadAllExistingTags() {
            this.callCloudFunction('getAllTags')
                .then(res => {
                    if (res.result && res.result.success) {
                        this.allExistingTags = res.result.tags;
                    }
                })
                .catch(err => {
                    console.error('Failed to load all existing tags:', err);
                });
        },

        // ÈÄÄÂá∫ÂâçÊèêÁ§∫ÊòØÂê¶‰øùÂ≠òËçâÁ®øÂπ∂Ëá™Âä®ËøîÂõû
        exitWithOptionalSave: function () {
            if ( !this.hasContent()) { try { uni.navigateBack(); } catch (e) {} return; } 
            uni.showModal({
                title: '‰øùÂ≠òËçâÁ®ø',
                content: 'Ê£ÄÊµãÂà∞‰Ω†ÊúâÊú™ÂÆåÊàêÁöÑÂÜÖÂÆπÔºåÊòØÂê¶‰øùÂ≠ò‰∏∫ËçâÁ®øÔºü',
                confirmText: '‰øùÂ≠ò',
                cancelText: '‰∏ç‰øùÂ≠ò',
                success: (res) => {
                    if (res.confirm) {
                        try {
                            const p = this.saveDraft && this.saveDraft();
                            if (p && typeof p.finally === 'function') {
                                p.finally(() => { try { uni.navigateBack(); } catch (e) {} });
                            } else {
                                setTimeout(() => { try { uni.navigateBack(); } catch (e) {} }, 500);
                            }
                        } catch (_) { try { uni.navigateBack(); } catch (e) {} }
                    } else {
                        try { this.clearDraft && this.clearDraft(); } catch (_) {}
                        try { uni.navigateBack(); } catch (e) {}
                    }
                }
            });
        },
        // ÂÖºÂÆπÊÄßÊñá‰ª∂‰∏ä‰º†ÊñπÊ≥ï
        uploadFile(cloudPath, filePath) {
            return new Promise((resolve, reject) => {
                // ‰ΩøÁî®Êñ∞ÁöÑÂπ≥Âè∞Ê£ÄÊµãÂ∑•ÂÖ∑
                const { getCurrentPlatform, getCloudFunctionMethod } = require('../../utils/platformDetector.js');
                
                const platform = getCurrentPlatform();
                const method = getCloudFunctionMethod();
                
                if (method === 'tcb') {
                    // H5ÂíåAppÁéØÂ¢ÉÔºö‰ΩøÁî®‰∫ëÂáΩÊï∞‰∏ä‰º†ÔºåÈÅøÂÖçmultipart/form-dataÊ†ºÂºèÈóÆÈ¢ò
                    this.uploadFileViaCloudFunction(cloudPath, filePath).then(resolve).catch(reject);
                } else if (method === 'wx-cloud') {
                    // Â∞èÁ®ãÂ∫èÁéØÂ¢É‰ΩøÁî®ÂæÆ‰ø°‰∫ëÂºÄÂèë
                    if (wx.cloud && wx.cloud.uploadFile) {
                        wx.cloud.uploadFile({
                            cloudPath: cloudPath,
                            filePath: filePath,
                            success: (res) => {
                                resolve(res);
                            },
                            fail: (err) => {
                                reject(err);
                            }
                        });
                    } else {
                        reject(new Error('ÂæÆ‰ø°‰∫ëÂºÄÂèë‰∏çÂèØÁî®'));
                    }
                } else {
                    reject(new Error(`‰∏çÊîØÊåÅÁöÑ‰∫ëÂáΩÊï∞Ë∞ÉÁî®ÊñπÂºè: ${method}`));
                }
            });
        },

        // ÈÄöËøá‰∫ëÂáΩÊï∞‰∏ä‰º†Êñá‰ª∂ÔºàËß£ÂÜ≥H5ÁéØÂ¢Émultipart/form-dataÈóÆÈ¢òÔºâ
        uploadFileViaCloudFunction(cloudPath, filePath, retryCount = 0) {
            return new Promise((resolve, reject) => {
                // Ê£ÄÊü•ÁéØÂ¢ÉÂπ∂‰ΩøÁî®Áõ∏Â∫îÁöÑÊñá‰ª∂ËØªÂèñÊñπÂºè
                if (typeof window !== 'undefined' && typeof FileReader !== 'undefined') {
                    // H5ÁéØÂ¢ÉÔºö‰ΩøÁî®fetchËé∑ÂèñblobÔºåÁÑ∂ÂêéËΩ¨Êç¢‰∏∫base64
                    
                    fetch(filePath)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            const reader = new FileReader();
                            reader.onload = () => {
                                const result = reader.result;
                                if (!result || typeof result !== 'string') {
                                    console.error('‚ùå [AddÈ°µÈù¢] FileReaderÁªìÊûúÊó†Êïà:', result);
                                    reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
                                    return;
                                }
                                const base64 = result.split(',')[1];
                                console.log(`üîç [AddÈ°µÈù¢] Êñá‰ª∂ËΩ¨Êç¢‰∏∫base64ÂÆåÊàêÔºåÈïøÂ∫¶: ${base64.length}`);
                                // Ê£ÄÊü•base64Â§ßÂ∞èÔºåÂ¶ÇÊûúÂ§™Â§ßÂàôËøõ‰∏ÄÊ≠•ÂéãÁº©
                                if (base64.length > 6 * 1024 * 1024) { // 6MB base64Á∫¶Á≠â‰∫é4.5MBÊñá‰ª∂
                                    console.warn('‚ö†Ô∏è [AddÈ°µÈù¢] base64Êñá‰ª∂ËøáÂ§ßÔºåÂ∞ùËØïËøõ‰∏ÄÊ≠•ÂéãÁº©');
                                    // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Ëøõ‰∏ÄÊ≠•ÁöÑÂéãÁº©ÈÄªËæë
                                }
                                
                                this.callCloudFunction('upload', {
                                    cloudPath: cloudPath,
                                    fileContent: base64
                                }).then((uploadRes) => {
                                    console.log('‰∏ä‰º†‰∫ëÂáΩÊï∞ËøîÂõûÁªìÊûú:', uploadRes);
                                    // Ê£ÄÊü•‰∫ëÂáΩÊï∞ËøîÂõûÊ†ºÂºèÂπ∂ÊèêÂèñfileID
                                    if (uploadRes && uploadRes.result && uploadRes.result.success) {
                                        resolve({
                                            fileID: uploadRes.result.fileID,
                                            cloudPath: uploadRes.result.cloudPath
                                        });
                                    } else {
                                        reject(new Error('‰∏ä‰º†‰∫ëÂáΩÊï∞ËøîÂõûÊ†ºÂºèÈîôËØØ'));
                                    }
                                }).catch((err) => {
                                    // Â¶ÇÊûúÊòØÁΩëÁªúÈîôËØØ‰∏îÈáçËØïÊ¨°Êï∞Â∞è‰∫é2ÔºåÂàôÈáçËØï
                                    if (retryCount < 2 && (err.errMsg === 'request:fail' || err.message?.includes('fail'))) {
                                        console.log(`üîÑ [AddÈ°µÈù¢] ‰∏ä‰º†Â§±Ë¥•ÔºåÂáÜÂ§áÈáçËØï (${retryCount + 1}/2)`);
                                        setTimeout(() => {
                                            this.uploadFileViaCloudFunction(cloudPath, filePath, retryCount + 1)
                                                .then(resolve).catch(reject);
                                        }, 1000 * (retryCount + 1)); // ÈÄíÂ¢ûÂª∂Ëøü
                                    } else {
                                        reject(err);
                                    }
                                });
                            };
                            reader.onerror = () => {
                                console.error('‚ùå [AddÈ°µÈù¢] FileReaderËØªÂèñÂ§±Ë¥•');
                                reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
                            };
                            reader.readAsDataURL(blob);
                        })
                        .catch(err => {
                            console.error('‚ùå [AddÈ°µÈù¢] Ëé∑ÂèñÊñá‰ª∂blobÂ§±Ë¥•:', err);
                            reject(new Error('Ëé∑ÂèñÊñá‰ª∂Â§±Ë¥•: ' + err.message));
                        });
                } else {
                    // AppÁéØÂ¢É‰ΩøÁî®uni-app API
                    console.log('üîç [AddÈ°µÈù¢] AppÁéØÂ¢É‰ΩøÁî®uni-app APIËØªÂèñÊñá‰ª∂');
                    try {
                        const fs = uni.getFileSystemManager();
                        if (fs && fs.readFile) {
                            fs.readFile({
                                filePath: filePath,
                                encoding: 'base64',
                                success: (readRes) => {
                                    const base64 = readRes.data;
                                    console.log(`üîç [AddÈ°µÈù¢] Êñá‰ª∂ËØªÂèñÂÆåÊàêÔºåbase64ÈïøÂ∫¶: ${base64.length}`);
                                    this.callCloudFunction('upload', {
                                        cloudPath: cloudPath,
                                        fileContent: base64
                                    }).then((uploadRes) => {
                                        console.log('AppÁéØÂ¢É‰∏ä‰º†‰∫ëÂáΩÊï∞ËøîÂõûÁªìÊûú:', uploadRes);
                                        // Ê£ÄÊü•‰∫ëÂáΩÊï∞ËøîÂõûÊ†ºÂºèÂπ∂ÊèêÂèñfileID
                                        if (uploadRes && uploadRes.result && uploadRes.result.success) {
                                            resolve({
                                                fileID: uploadRes.result.fileID,
                                                cloudPath: uploadRes.result.cloudPath
                                            });
                                        } else {
                                            reject(new Error('‰∏ä‰º†‰∫ëÂáΩÊï∞ËøîÂõûÊ†ºÂºèÈîôËØØ'));
                                        }
                                    }).catch(reject);
                                },
                                fail: (readErr) => {
                                    console.error('‚ùå [AddÈ°µÈù¢] Êñá‰ª∂ËØªÂèñÂ§±Ë¥•Ôºö', readErr);
                                    reject(new Error(`Êñá‰ª∂ËØªÂèñÂ§±Ë¥•: ${readErr.errMsg || 'Êú™Áü•ÈîôËØØ'}`));
                                }
                            });
                        } else {
                            console.error('‚ùå [AddÈ°µÈù¢] getFileSystemManager‰∏çÂèØÁî®');
                            reject(new Error('Êñá‰ª∂Á≥ªÁªüAPI‰∏çÂèØÁî®'));
                        }
                    } catch (error) {
                        console.error('‚ùå [AddÈ°µÈù¢] Êñá‰ª∂Á≥ªÁªüAPIË∞ÉÁî®Â§±Ë¥•:', error);
                        reject(new Error('Êñá‰ª∂Á≥ªÁªüAPI‰∏çÂèØÁî®'));
                    }
                }
            });
        },

        preventPageScroll: function () {
            // Â∞ùËØïÁ¶ÅÁî®È°µÈù¢ÊªöÂä®
            try {
                uni.pageScrollTo({
                    scrollTop: 0,
                    duration: 0
                });
            } catch (e) {
                console.log('CatchClause', e);
                console.log('CatchClause', e);
                console.log('preventPageScroll error:', e);
            }
        },

  
        onContentInput: function (event) {
            const { value, cursor } = event.detail;
            this.setData({
                content: value
            });
            this.checkCanPublish();
        },

        onContainerTap: function (event) {
            // ÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÈÄÄÂá∫ËæìÂÖ•Ê≥ïÔºå‰ΩÜ‰∏çË¶ÅÁ´ãÂç≥ÈöêËóèÔºåÁªôtextarea‰∏ÄÁÇπÊó∂Èó¥
            console.log('ÂÆπÂô®Ë¢´ÁÇπÂáªÔºåÂáÜÂ§áÈöêËóèÈîÆÁõò');
            setTimeout(() => {
                uni.hideKeyboard();
            }, 100);
        },

        onTextareaTap: function (event) {
            // Á°Æ‰øùËæìÂÖ•Ê°ÜËÉΩÊ≠£Â∏∏Ëé∑ÂèñÁÑ¶ÁÇπ
            console.log('textareaË¢´ÁÇπÂáªÔºåÂ∫îËØ•Ëé∑ÂèñÁÑ¶ÁÇπ');
        },

        // ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπÊó∂Ëß¶ÂèëÔºåËé∑ÂèñÈîÆÁõòÈ´òÂ∫¶
        onTextareaFocus: function (e) {
            console.log('textareaËé∑ÂæóÁÑ¶ÁÇπÔºåÈîÆÁõòÈ´òÂ∫¶:', e.detail.height);
            // Âú®ÂºÄÂèëËÄÖÂ∑•ÂÖ∑‰∏≠ÔºåÈîÆÁõòÈ´òÂ∫¶ÂèØËÉΩ‰∏∫0ÔºåÊàë‰ª¨ÈúÄË¶ÅËÆæÁΩÆ‰∏Ä‰∏™ÈªòËÆ§ÂÄº
            let keyboardHeight = e.detail.height;

            // Â¶ÇÊûúÈîÆÁõòÈ´òÂ∫¶‰∏∫0ÔºåÂèØËÉΩÊòØÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÁöÑÈóÆÈ¢òÔºåËÆæÁΩÆ‰∏Ä‰∏™ÂêàÁêÜÁöÑÈªòËÆ§ÂÄº
            if (!keyboardHeight || keyboardHeight === 0) {
                // Ëé∑ÂèñÁ≥ªÁªü‰ø°ÊÅØÊù•ËÆæÁΩÆÂêàÈÄÇÁöÑÈîÆÁõòÈ´òÂ∫¶
                const systemInfo = uni.getSystemInfoSync();
                console.log('Á≥ªÁªü‰ø°ÊÅØ:', systemInfo);
                // Ê†πÊçÆÂ±èÂπïÈ´òÂ∫¶ËÆæÁΩÆÈîÆÁõòÈ´òÂ∫¶ÔºåÈÄöÂ∏∏ÊòØÂ±èÂπïÈ´òÂ∫¶ÁöÑ1/3Âà∞1/2
                keyboardHeight = Math.min(systemInfo.windowHeight * 0.4, 300);
                console.log('‰ΩøÁî®ÈªòËÆ§ÈîÆÁõòÈ´òÂ∫¶:', keyboardHeight);
            }
            this.setData({
                keyboardHeight: keyboardHeight
            });
        },

        // ËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÊó∂Ëß¶ÂèëÔºåÈáçÁΩÆÈîÆÁõòÈ´òÂ∫¶
        onTextareaBlur: function () {
            console.log('textareaÂ§±ÂéªÁÑ¶ÁÇπ');
            this.setData({
                keyboardHeight: 0
            });
        },

  
        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÂèëÂ∏É
        checkCanPublish: function () {
            const hasImages = this.imageList.length > 0;
            const hasContent = this.content && this.content.trim();
            let canPublish = hasImages || hasContent;

            // Â¶ÇÊûúÊòØÈùûÂéüÂàõËØóÊ≠åÔºåÂøÖÈ°ªÂ°´ÂÜô‰ΩúËÄÖ
            if (this.publishMode === 'poem' && !this.isOriginal) {
                const hasAuthor = this.author && this.author.trim();
                canPublish = canPublish && hasAuthor;
            }
            this.setData({
                canPublish: canPublish
            });
        },

        // ÂàáÊç¢ÂèëÂ∏ÉÊ®°Âºè
        switchMode: function () {
            this.setData({
                showModeSelector: !this.showModeSelector,
                showTagSelector: false // ÈöêËóèÊ†áÁ≠æÈÄâÊã©Âô®
            });
        },

        // ÈÄâÊã©ÂèëÂ∏ÉÊ®°Âºè
        selectPublishMode: function (e) {
            const mode = e.currentTarget.dataset.mode;
            const isOriginal = e.currentTarget.dataset.original;

            this.setData({
                publishMode: mode,
                isOriginal: isOriginal === null ? false : isOriginal,
                showModeSelector: false
            });

            // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆÂõæÁâáÈôêÂà∂
            if (mode === 'poem') {
                // ËØóÊ≠åÊ®°ÂºèÔºöÊúÄÂ§ö1Âº†ÂõæÁâá
                this.setData({
                    maxImageCount: 1,
                    imageList: this.imageList.length > 1 ? [this.imageList[0]] : this.imageList
                });
            } else {
                // ÊôÆÈÄöÂ∏ñÂ≠êÂíåËÆ®ËÆ∫Â∏ñÂ≠êÔºöÊúÄÂ§ö9Âº†ÂõæÁâá
                this.setData({
                    maxImageCount: 9
                });
            }

            this.checkCanPublish();
        },

        handleChooseImage: function () {
            const that = this;
            const remainingCount = this.maxImageCount - this.imageList.length;
            if (remainingCount <= 0) {
                uni.showToast({
                    title: 'ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†9Âº†ÂõæÁâá',
                    icon: 'none'
                });
                return;
            }

            // ËÆæÁΩÆ‰∏¥Êó∂ÈöêËóèÊ†áÂøóÔºåÈÅøÂÖçËß¶ÂèëËçâÁ®ø‰øùÂ≠ò
            this.setData({
                isTemporaryHide: true
            });
            uni.chooseImage({
                count: remainingCount,
                // ÂÖ≥ÈîÆ‰øÆÊîπ1ÔºöÂº∫Âà∂‰ΩøÁî®ÂéüÂõæÔºåÊääÂéãÁº©ÊéßÂà∂ÊùÉÂÆåÂÖ®‰∫§ÁªôËá™Â∑±ÁöÑ‰ª£Á†Å
                sizeType: ['original'],
                sourceType: ['album', 'camera'],
                success: (res) => {
                    uni.showLoading({
                        title: 'Â§ÑÁêÜ‰∏≠...'
                    });

                    // ÂÖ≥ÈîÆ‰øÆÊîπ2Ôºö‰∏çÂÜç‰ΩøÁî® res.tempFilePathsÔºåËÄåÊòØ‰ΩøÁî®ÂåÖÂê´sizeÁöÑ res.tempFiles
                    console.log('wx.chooseImage ËøîÂõûÁöÑËØ¶ÁªÜÊñá‰ª∂‰ø°ÊÅØ:', res.tempFiles);
                    const imagePromises = res.tempFiles.map((file) => {
                        // Áé∞Âú® file ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰æãÂ¶Ç {path: '...', size: 12345}
                        const tempFilePath = file.path;
                        const sizeInBytes = file.size;
                        console.log(`Ëé∑ÂèñÂà∞ÂõæÁâá ${tempFilePath} ÁöÑÂéüÂßãÂ§ßÂ∞è:`, (sizeInBytes / 1024).toFixed(2), 'KB');
                        
                        // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÈôêÂà∂Ôºà5MBÔºâ
                        if (sizeInBytes > 5 * 1024 * 1024) {
                            throw new Error(`ÂõæÁâáÊñá‰ª∂ËøáÂ§ß (${(sizeInBytes / 1024 / 1024).toFixed(2)}MB)ÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá`);
                        }
                        
                        const needCompression = sizeInBytes > 200000; // Èôç‰ΩéÂéãÁº©ÈòàÂÄº‰ªé300KBÂà∞200KB
                        const imageInfo = {
                            originalPath: tempFilePath,
                            imageSize: sizeInBytes,
                            needCompression: needCompression,
                            previewUrl: tempFilePath,
                            compressedPath: tempFilePath,
                            originalUrl: '',
                            compressedUrl: ''
                        };
                        if (needCompression) {
                            // Â¶ÇÊûúÈúÄË¶ÅÂéãÁº©ÔºåË∞ÉÁî®ËøîÂõûPromiseÁöÑÂéãÁº©ÂáΩÊï∞
                            return that.compressImage(imageInfo);
                        } else {
                            // Â¶ÇÊûú‰∏çÈúÄË¶ÅÂéãÁº©ÔºåÁõ¥Êé•Áî® Promise.resolve ÂåÖË£ÖÂêéËøîÂõû
                            return Promise.resolve(imageInfo);
                        }
                    });
                    Promise.all(imagePromises)
                        .then((newImages) => {
                            uni.hideLoading();
                            that.updateImageList(newImages);
                            that.checkCanPublish();
                        })
                        .catch((err) => {
                            uni.hideLoading();
                            console.error('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•:', err);
                            
                            // ÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                            let errorMessage = 'ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•';
                            if (err.message && err.message.includes('ÂõæÁâáÊñá‰ª∂ËøáÂ§ß')) {
                                errorMessage = err.message;
                            } else if (err.message) {
                                errorMessage = `ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•: ${err.message}`;
                            }
                            
                            uni.showModal({
                                title: 'ÈîôËØØ',
                                content: errorMessage,
                                showCancel: false,
                                confirmText: 'Á°ÆÂÆö'
                            });
                        });
                },
                fail: (err) => {
                    console.log('ÈÄâÊã©ÂõæÁâáÂèñÊ∂àÊàñÂ§±Ë¥•:', err);
                    // ÈáçÁΩÆ‰∏¥Êó∂ÈöêËóèÊ†áÂøó
                    this.setData({
                        isTemporaryHide: false
                    });
                }
            });
        },

        compressImage: function (imageInfo) {
            return new Promise((resolve) => {
                // Ê£ÄÊü•ËøêË°åÁéØÂ¢É
                const { getCurrentPlatform } = require('../../utils/platformDetector.js');
                const platform = getCurrentPlatform();
                
                if (platform === 'h5') {
                    // H5ÁéØÂ¢É‰ΩøÁî®CanvasÂéãÁº©
                    console.log('üîç [AddÈ°µÈù¢] H5ÁéØÂ¢É‰ΩøÁî®CanvasÂéãÁº©ÂõæÁâá');
                    this.compressImageWithCanvas(imageInfo).then(resolve).catch(() => {
                        // CanvasÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ
                        console.log('CanvasÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ');
                        imageInfo.compressedPath = imageInfo.originalPath;
                        imageInfo.previewUrl = imageInfo.originalPath;
                        resolve(imageInfo);
                    });
                } else {
                    // Â∞èÁ®ãÂ∫èÂíåAppÁéØÂ¢É‰ΩøÁî®uni.compressImage
                    console.log('üîç [AddÈ°µÈù¢] Â∞èÁ®ãÂ∫è/AppÁéØÂ¢É‰ΩøÁî®uni.compressImage');
                    uni.compressImage({
                        src: imageInfo.originalPath,
                        quality: 80,
                        success: (compressRes) => {
                            imageInfo.compressedPath = compressRes.tempFilePath;
                            imageInfo.previewUrl = compressRes.tempFilePath;
                            resolve(imageInfo);
                        },
                        fail: (err) => {
                            // ÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ‰Ωú‰∏∫Â§áÁî®
                            console.log('ÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ:', err);
                            imageInfo.compressedPath = imageInfo.originalPath;
                            imageInfo.previewUrl = imageInfo.originalPath;
                            resolve(imageInfo);
                        }
                    });
                }
            });
        },

        // H5ÁéØÂ¢É‰ΩøÁî®CanvasÂéãÁº©ÂõæÁâá
        compressImageWithCanvas: function (imageInfo) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    try {
                        // ÂàõÂª∫Canvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ËÆ°ÁÆóÂéãÁº©ÂêéÁöÑÂ∞∫ÂØ∏ - Èôç‰ΩéÊúÄÂ§ßÂ∞∫ÂØ∏‰ª•ÂáèÂ∞ëÊñá‰ª∂Â§ßÂ∞è
                        const maxWidth = 1200;  // ‰ªé1920Èôç‰ΩéÂà∞1200
                        const maxHeight = 1200; // ‰ªé1920Èôç‰ΩéÂà∞1200
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ÁªòÂà∂ÂéãÁº©ÂêéÁöÑÂõæÁâá
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ËΩ¨Êç¢‰∏∫blob
                        canvas.toBlob((blob) => {
                            if (blob) {
                                const compressedUrl = URL.createObjectURL(blob);
                                imageInfo.compressedPath = compressedUrl;
                                imageInfo.previewUrl = compressedUrl;
                                console.log('‚úÖ [AddÈ°µÈù¢] CanvasÂéãÁº©ÊàêÂäüÔºåÊñ∞Â∞∫ÂØ∏:', width, 'x', height);
                                resolve(imageInfo);
                            } else {
                                reject(new Error('CanvasÂéãÁº©Â§±Ë¥•'));
                            }
                        }, 'image/jpeg', 0.6); // Èôç‰ΩéÂéãÁº©Ë¥®Èáè‰ªé0.8Âà∞0.6
                        
                    } catch (error) {
                        console.error('CanvasÂéãÁº©ËøáÁ®ãÂá∫Èîô:', error);
                        reject(error);
                    }
                };
                
                img.onerror = () => {
                    reject(new Error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•'));
                };
                
                img.src = imageInfo.originalPath;
            });
        },

        updateImageList: function (newImages) {
            const currentList = this.imageList;
            const updatedList = currentList.concat(newImages);
            this.setData({
                imageList: updatedList
            });
        },

        removeImage: function (e) {
            const index = e.currentTarget.dataset.index;
            const imageList = this.imageList;
            imageList.splice(index, 1);
            this.setData({
                imageList: imageList
            });
            this.checkCanPublish();
        },

        // ÂèëÂ∏ÉÂäüËÉΩÂ∑≤ÁßªËá≥È¢ÑËßàÈ°µÈù¢
        submitPost: function () {
            // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞È¢ÑËßàÈ°µÈù¢ËøõË°åÂèëÂ∏É
            this.goToPreview();
        },

        // Ê£ÄÊü•ÈáçÂ§çËØóÊ≠å
        checkDuplicatePoem: function () {
            uni.showLoading({
                title: 'Ê£ÄÊü•‰∏≠...'
            });
            this.callCloudFunction('checkDuplicatePoem', {
                title: this.title.trim(),
                author: this.author.trim(),
                isOriginal: this.isOriginal
            }).then((res) => {
                    uni.hideLoading();
                    console.log('ÈáçÂ§çÊ£ÄÊü•ÁªìÊûú:', res.result);
                    if (res.result.success) {
                        if (res.result.isDuplicate) {
                            // ÂèëÁé∞ÈáçÂ§çÔºåÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                            this.showDuplicateConfirmDialog(res.result.duplicateCount);
                        } else {
                            // Ê≤°ÊúâÈáçÂ§çÔºåÁõ¥Êé•ÂèëÂ∏É
                            this.proceedWithPublish();
                        }
                    } else {
                        uni.showToast({
                            title: 'Ê£ÄÊü•Â§±Ë¥•ÔºåËØ∑ÈáçËØï',
                            icon: 'none'
                        });
                    }
                }).catch((err) => {
                    uni.hideLoading();
                    console.error('Ê£ÄÊü•ÈáçÂ§çÂ§±Ë¥•:', err);
                    uni.showToast({
                        title: 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï',
                        icon: 'none'
                    });
                });
        },

        // ÊòæÁ§∫ÈáçÂ§çÁ°ÆËÆ§ÂØπËØùÊ°Ü
        showDuplicateConfirmDialog: function (duplicateCount) {
            uni.showModal({
                title: 'ÂèëÁé∞ÈáçÂ§çËØóÊ≠å',
                content: `Â∑≤Êúâ ${duplicateCount} ÁØáÁõ∏ÂêåÁöÑËØóÊ≠åÂèëÂ∏ÉÔºåÊòØÂê¶ÁªßÁª≠ÂèëÂ∏ÉÔºü`,
                confirmText: 'ÁªßÁª≠ÂèëÂ∏É',
                cancelText: 'ÂèñÊ∂àÂèëÂ∏É',
                success: (res) => {
                    if (res.confirm) {
                        // Áî®Êà∑ÈÄâÊã©ÁªßÁª≠ÂèëÂ∏É
                        this.proceedWithPublish();
                    } else {
                        // Áî®Êà∑ÈÄâÊã©ÂèñÊ∂àÂèëÂ∏É
                        console.log('Áî®Êà∑ÂèñÊ∂àÂèëÂ∏ÉÈáçÂ§çËØóÊ≠å');
                    }
                }
            });
        },

        // ÁªßÁª≠ÂèëÂ∏ÉÊµÅÁ®ã
        proceedWithPublish: function () {
            uni.showLoading({
                title: 'ÂèëÂ∏É‰∏≠...'
            });
            if (this.imageList.length > 0) {
                this.uploadImagesAndSubmit();
            } else {
                this.submitTextOnly();
            }
        },

        uploadImagesAndSubmit: function () {
            const that = this;
            const timestamp = new Date().getTime();
            const imageList = this.imageList;
            console.log('ÂºÄÂßã‰∏ä‰º†ÂõæÁâá:', imageList.length + 'Âº†');
            const uploadPromises = imageList.map((imageInfo, index) => {
                return new Promise((resolve, reject) => {
                    const imageTimestamp = timestamp + index;
                    const compressedCloudPath = `post_images/${imageTimestamp}_compressed.jpg`;
                    
                    // ‰ΩøÁî®ÂÖºÂÆπÊÄß‰∏ä‰º†ÊñπÊ≥ï
                    that.uploadFile(compressedCloudPath, imageInfo.compressedPath)
                        .then((compressedRes) => {
                            console.log('ÂéãÁº©Âõæ‰∏ä‰º†ÊàêÂäü:', compressedRes);
                            console.log('ÂéãÁº©ÂõæfileID:', compressedRes.fileID);
                            console.log('ÂéãÁº©ÂõæfileIDÁ±ªÂûã:', typeof compressedRes.fileID);
                            const compressedFileID = compressedRes.fileID;
                            if (imageInfo.needCompression) {
                                const originalCloudPath = `post_images/${imageTimestamp}_original.jpg`;
                                return that.uploadFile(originalCloudPath, imageInfo.originalPath)
                                    .then((originalRes) => {
                                        console.log('ÂéüÂõæ‰∏ä‰º†ÊàêÂäü:', originalRes);
                                        console.log('ÂéüÂõæfileID:', originalRes.fileID);
                                        console.log('ÂéüÂõæfileIDÁ±ªÂûã:', typeof originalRes.fileID);
                                        resolve({
                                            compressedUrl: compressedFileID,
                                            originalUrl: originalRes.fileID
                                        });
                                    });
                            } else {
                                resolve({
                                    compressedUrl: compressedFileID,
                                    originalUrl: compressedFileID
                                });
                            }
                        })
                        .catch(reject);
                });
            });
            Promise.all(uploadPromises)
                .then((uploadResults) => {
                    console.log('ÊâÄÊúâÂõæÁâá‰∏ä‰º†ÂÆåÊàê:', uploadResults);
                    return that.submitWithContentCheck(uploadResults);
                })
                .catch((err) => {
                    console.error('‰∏ä‰º†Â§±Ë¥•:', err);
                    that.publishFail(err);
                });
        },

        submitToDatabase: function (uploadResults) {
            console.log('Êèê‰∫§Âà∞Êï∞ÊçÆÂ∫ì:', {
                uploadResults: uploadResults,
                title: this.title,
                content: this.content,
                publishMode: this.publishMode,
                isOriginal: this.isOriginal
            });
            console.log('uploadResultsËØ¶ÁªÜ‰ø°ÊÅØ:', uploadResults);
            console.log('uploadResultsÈïøÂ∫¶:', uploadResults.length);
            
            const imageUrls = uploadResults.map((result) => result.compressedUrl);
            const originalImageUrls = uploadResults.map((result) => result.originalUrl);
            
            console.log('Â§ÑÁêÜÂêéÁöÑÂõæÁâáURLs:', {
                imageUrls: imageUrls,
                originalImageUrls: originalImageUrls,
                imageUrlsType: imageUrls.map(url => typeof url),
                originalImageUrlsType: originalImageUrls.map(url => typeof url),
                imageUrlsValues: imageUrls.map(url => url ? url.substring(0, 50) + '...' : 'null/undefined')
            });

            // Á°ÆÂÆö‰ΩúËÄÖ‰ø°ÊÅØ
            let authorName = '';
            if (this.publishMode === 'poem') {
                if (this.isOriginal) {
                    // ÂéüÂàõËØóÊ≠åÔºöÂ¶ÇÊûúÂ°´ÂÜô‰∫Ü‰ΩúËÄÖÂ∞±Áî®Â°´ÂÜôÁöÑÔºåÂê¶Âàô‰ΩøÁî®Áî®Êà∑ÊòµÁß∞
                    const userInfo = uni.getStorageSync('userInfo');
                    const userNickName = userInfo ? userInfo.nickName : 'ÂåøÂêçÁî®Êà∑';
                    authorName = this.author && this.author.trim() ? this.author.trim() : userNickName;
                } else {
                    // ÈùûÂéüÂàõËØóÊ≠åÔºöÂøÖÈ°ª‰ΩøÁî®Â°´ÂÜôÁöÑ‰ΩúËÄÖ
                    authorName = this.author && this.author.trim() ? this.author.trim() : '';
                }
            }
            
            // ÂáÜÂ§áÊèê‰∫§Êï∞ÊçÆ
            const postData = {
                title: this.title,
                content: this.content,
                createTime: new Date(),
                votes: 0,
                // Êñ∞Â¢ûËØóÊ≠åÁõ∏ÂÖ≥Â≠óÊÆµ
                isPoem: this.publishMode === 'poem',
                isOriginal: this.isOriginal,
                // Êñ∞Â¢û‰ΩúËÄÖÂ≠óÊÆµ
                author: authorName,
                // Êñ∞Â¢ûÊ†áÁ≠æÂ≠óÊÆµ
                tags: this.selectedTags || [],
                backgroundColor: this.selectedBackgroundColor || '',
                highlightSentence: this.highlightSentence || ''
            };
            
            if (imageUrls.length > 0) {
                postData.imageUrl = imageUrls[0];
                postData.imageUrls = imageUrls;
                postData.originalImageUrl = originalImageUrls[0];
                postData.originalImageUrls = originalImageUrls;

                // Â¶ÇÊûúÊòØËØóÊ≠åÊ®°ÂºèÔºåÁ¨¨‰∏ÄÂº†ÂõæÁâá‰Ωú‰∏∫ËÉåÊôØÂõæ
                if (this.publishMode === 'poem' && imageUrls.length > 0) {
                    postData.poemBgImage = imageUrls[0];
                }
            }
            
            // ‰ΩøÁî®contentCheck‰∫ëÂáΩÊï∞Êèê‰∫§Êï∞ÊçÆÔºàÁé∞Âú®Â∑≤Á¶ÅÁî®ÂÆ°Ê†∏ÔºåÁõ¥Êé•ÂàõÂª∫Â∏ñÂ≠êÔºâ
            const fileIDs = imageUrls.filter(url => url); // ËøáÊª§ÊéânullÂÄº
            const originalFileIDs = originalImageUrls.filter(url => url); // ËøáÊª§ÊéânullÂÄº
            
            console.log('‰º†ÈÄíÁªô‰∫ëÂáΩÊï∞ÁöÑÂèÇÊï∞:', {
                fileIDs: fileIDs,
                originalFileIDs: originalFileIDs,
                fileIDsLength: fileIDs.length,
                originalFileIDsLength: originalFileIDs.length
            });
            
            const auditParams = {
                title: this.title,
                content: this.content,
                fileIDs: fileIDs,
                originalFileIDs: originalFileIDs, // Ê∑ªÂä†ÂéüÂõæURLÊï∞ÁªÑ
                publishMode: this.publishMode,
                isOriginal: this.isOriginal,
                author: this.author,
                tags: this.selectedTags || [],
                isDiscussion: this.isDiscussion || false,
                parentPostId: this.parentPostId || '',
            };
            
            return this.callCloudFunction('contentCheck', auditParams).then((res) => {
                console.log('Êï∞ÊçÆÂ∫ìÊèê‰∫§ÊàêÂäü:', res);
                // Ê£ÄÊü•‰∫ëÂáΩÊï∞ËøîÂõûÁöÑÁªìÊûúÊ†ºÂºè
                if (res && res.result && res.result.code === 0) {
                    // ‰∫ëÂáΩÊï∞ËøîÂõûÊàêÂäü
                    this.publishSuccess({
                        _id: res.result.postId
                    });
                } else {
                    // ‰∫ëÂáΩÊï∞ËøîÂõûÂ§±Ë¥•
                    console.error('‰∫ëÂáΩÊï∞ËøîÂõûÂ§±Ë¥•:', res);
                    this.publishFail(new Error(res.result?.msg || '‰∫ëÂáΩÊï∞ËøîÂõûÂ§±Ë¥•'));
                }
            }).catch((err) => {
                console.error('Êï∞ÊçÆÂ∫ìÊèê‰∫§Â§±Ë¥•:', err);
                this.publishFail(err);
            });
        },

        submitTextOnly: function () {
            this.submitWithContentCheck([]);
        },

        // Êñ∞Â¢ûÔºöÂ∏¶ÂÜÖÂÆπÂÆ°Ê†∏ÁöÑÊèê‰∫§ÂáΩÊï∞
        submitWithContentCheck: function (uploadResults) {
            const that = this;
            console.log('ÂºÄÂßãÂÜÖÂÆπÂÆ°Ê†∏ÂíåÊèê‰∫§:', {
                uploadResults: uploadResults,
                title: this.title,
                content: this.content,
                publishMode: this.publishMode,
                isOriginal: this.isOriginal,
                author: this.author,
                tags: this.selectedTags
            });

            // TODO: ÊöÇÊó∂ÂÖ≥Èó≠ÂÜÖÂÆπÂÆ°Ê†∏ÔºåËÖæËÆØ‰∫ëÂÜÖÂÆπÂÆ°Ê†∏ÊúçÂä°Êú™Áª≠Ë¥π
            // Êú™Êù•Áª≠Ë¥πÂêéÂèØ‰ª•ÈáçÊñ∞ÂêØÁî®‰ª•‰∏ã‰ª£Á†Å
            console.log('‚ö†Ô∏è ÂÜÖÂÆπÂÆ°Ê†∏Â∑≤ÊöÇÊó∂ÂÖ≥Èó≠ÔºåÁõ¥Êé•ÂèëÂ∏ÉÂÜÖÂÆπ');
            
            // Áõ¥Êé•ÂèëÂ∏ÉÔºåË∑≥ËøáÂÆ°Ê†∏
            return that.submitToDatabase(uploadResults);

            /* 
            // ‰ª•‰∏ãÊòØÂéüÊù•ÁöÑÂÜÖÂÆπÂÆ°Ê†∏ÈÄªËæëÔºåÊöÇÊó∂Ê≥®ÈáäÊéâÔºåÊú™Êù•Áª≠Ë¥πÂêéÂèØ‰ª•ÈáçÊñ∞ÂêØÁî®
            // ÂáÜÂ§áÂÆ°Ê†∏ÂèÇÊï∞
            const fileIDs = uploadResults.map((result) => result.compressedUrl);
            const auditParams = {
                title: this.title,
                content: this.content,
                fileIDs: fileIDs,
                publishMode: this.publishMode,
                isOriginal: this.isOriginal,
                author: this.author,
                tags: this.selectedTags || []
            };

            // Ë∞ÉÁî®ÂÜÖÂÆπÂÆ°Ê†∏‰∫ëÂáΩÊï∞
            that.callCloudFunction('contentCheck', auditParams)
                .then((res) => {
                    console.log('ÂÜÖÂÆπÂÆ°Ê†∏ÁªìÊûú:', res);
                    if (res.result.code === 0) {
                        // ÂÆ°Ê†∏ÈÄöËøáÔºåÂèëÂ∏ÉÊàêÂäü
                        that.publishSuccess({
                            _id: res.result.postId
                        });
                    } else {
                        // ÂÆ°Ê†∏‰∏çÈÄöËøáÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                        uni.hideLoading();
                        uni.showModal({
                            title: 'ÂèëÂ∏ÉÂ§±Ë¥•',
                            content: res.result.msg || 'ÂÜÖÂÆπÂÆ°Ê†∏‰∏çÈÄöËøáÔºåËØ∑Ê£ÄÊü•ÂÜÖÂÆπÂêéÈáçËØï',
                            showCancel: false
                        });
                    }
                })
                .catch((err) => {
                    console.error('ÂÜÖÂÆπÂÆ°Ê†∏Â§±Ë¥•:', err);
                    that.publishFail(err);
                });
            */
        },

        publishSuccess: function (res) {
            uni.hideLoading();
            uni.showToast({
                title: 'ÂèëÂ∏ÉÊàêÂäüÔºÅ'
            });
            // Êñ∞Â¢ûÔºöËÆæÁΩÆÂêÑÈ°µÈù¢ÈúÄË¶ÅÂà∑Êñ∞Ê†áËÆ∞
            try {
                uni.setStorageSync('shouldRefreshIndex', true);
                uni.setStorageSync('shouldRefreshProfile', true);
                uni.setStorageSync('shouldRefreshPoem', true);
                uni.setStorageSync('shouldRefreshMountain', true);
                const appInstance = getApp();
                const userId = appInstance && appInstance.globalData && appInstance.globalData.openid;
                try { const { emitPostCreated } = require('@/utils/events.js'); emitPostCreated(userId); } catch (e) { if (userId && uni.$emit) { uni.$emit('post-created', { userId }); } }
            } catch (e) {
                console.log('CatchClause', e);
                console.log('CatchClause', e);
            }
            // ËÆæÁΩÆÂèëÂ∏ÉÊàêÂäüÊ†áËÆ∞ÔºåÈÅøÂÖçÂêéÁª≠Ê£ÄÊü•ËçâÁ®ø
            this.setData({
                isPublished: true
            });
            // ÂèëÂ∏ÉÊàêÂäüÂêéÊ∏ÖÈô§ËçâÁ®ø
            this.clearDraft();
            uni.navigateBack({
                delta: 1
            });
        },

        publishFail: function (err) {
            uni.hideLoading();
            console.error('[ÂèëÂ∏ÉÊµÅÁ®ã] Â§±Ë¥•Ôºö', err);
            
            // ÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
            let errorMessage = 'ÂèëÂ∏ÉÂ§±Ë¥•';
            if (err && err.message) {
                errorMessage = `ÂèëÂ∏ÉÂ§±Ë¥•: ${err.message}`;
            } else if (err && err.errMsg) {
                errorMessage = `ÂèëÂ∏ÉÂ§±Ë¥•: ${err.errMsg}`;
            }
            
            uni.showModal({
                title: 'ÂèëÂ∏ÉÂ§±Ë¥•',
                content: errorMessage,
                showCancel: false,
                confirmText: 'Á°ÆÂÆö'
            });
        },

        // Êñ∞Â¢ûÔºöÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÂèçÈ¶à
        onImageError: function (e) {
            uni.showToast({
                title: 'ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•',
                icon: 'none'
            });
            console.error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•', e);
        },

        // Ê†áÁ≠æÁõ∏ÂÖ≥ÂäüËÉΩ
        toggleTagSelector: function () {
            this.setData({
                showTagSelector: !this.showTagSelector
            });
        },

        // ÂéªÈ¢ÑËßàÔºöÊääÂΩìÂâçÁºñËæëÂÜÖÂÆπÂ∏¶Âà∞È¢ÑËßàÈ°µÔºå‰ªÖÂ±ïÁ§∫‰∏çÊèê‰∫§
        goToPreview: function () {
            const previewPost = {
                _id: 'preview-temp-id',
                content: this.content || '',
                title: '', // Ê†áÈ¢òÂ∞ÜÂú®È¢ÑËßàÈ°µÈù¢ËæìÂÖ•
                textColor: '#000000',
                backgroundColor: this.selectedBackgroundColor || '#ffffff',
                isExpanded: true,
                likeIcon: '/static/images/seed.png',
                imageUrls: (this.imageList || []).map(i => i.previewUrl),
                highlightLines: this.highlightLines || [],
                // ‰º†ÈÄíÂΩìÂâçÁºñËæëÁöÑÊï∞ÊçÆ‰æõÈ¢ÑËßàÈ°µÈù¢‰ΩøÁî®
                editData: {
                    selectedBackgroundColor: this.selectedBackgroundColor,
                    imageList: this.imageList,
                    publishMode: this.publishMode,
                    isOriginal: this.isOriginal,
                    selectedTags: this.selectedTags,
                    author: this.author,
                    highlightLines: this.highlightLines,
                    highlightSelectedLineIndices: this.highlightSelectedLineIndices
                }
            };

            // Ë∞ÉËØïÔºöËæìÂá∫È¢ÑËßàÊï∞ÊçÆ
            console.log('„ÄêAdd„ÄëÂáÜÂ§áË∑≥ËΩ¨Âà∞È¢ÑËßàÔºåÊï∞ÊçÆ:', previewPost);
            console.log('„ÄêAdd„ÄëpublishMode:', this.publishMode);
            console.log('„ÄêAdd„ÄëeditData.publishMode:', previewPost.editData.publishMode);

            try { uni.setStorageSync('preview_post', previewPost); } catch (e) {}

            uni.navigateTo({
                url: '/pages/preview/preview',
                success: (res) => {
                    try { res.eventChannel.emit('preview-data', { post: previewPost }); } catch (e) {}
                }
            });
        },

        // Âç†‰ΩçÔºöÈÄâÊã©È¢úËâ≤
        onSelectColor: function () {
            this.setData({ showColorPicker: !this.showColorPicker });
        },

        // Âç†‰ΩçÔºöÈ´òÂÖâÂºÄÂÖ≥Ôºà‰øùÁïôÂéüÊù•ÁöÑÂºπÁ™óÊ®°Âºè‰Ωú‰∏∫Â§áÁî®Ôºâ
        onToggleHighlight: function () {
            this.setData({ highlightSelecting: !this.highlightSelecting });
            if (this.highlightSelecting) {
                uni.showToast({ title: 'ÁÇπÂáªË¶ÅÈ´ò‰∫ÆÁöÑË°å', icon: 'none' });
            }
        },

        // Êñ∞ÁöÑË¶ÜÁõñÂ±ÇÁõ∏ÂÖ≥ÊñπÊ≥ï
        toggleHighlightMode: function () {
            this.setData({
                highlightModeEnabled: !this.highlightModeEnabled,
                showHighlightHint: !this.highlightModeEnabled
            });
            if (this.highlightModeEnabled) {
                // ÊòæÁ§∫ÊèêÁ§∫3ÁßíÂêéËá™Âä®ÈöêËóè
                setTimeout(() => {
                    this.setData({ showHighlightHint: false });
                }, 3000);
            }
        },

        hideHighlightHint: function () {
            this.setData({ showHighlightHint: false });
        },

        // textareaÊªöÂä®‰∫ã‰ª∂
        onTextareaScroll: function (e) {
            this.setData({
                textareaScrollTop: e.detail.scrollTop,
                overlayScrollTop: e.detail.scrollTop
            });
        },

        // Ë¶ÜÁõñÂ±ÇËß¶Êë∏‰∫ã‰ª∂
        onOverlayTouchStart: function (e) {
            // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëtextareaÁöÑÁÑ¶ÁÇπ
            e.preventDefault();
        },

        onOverlayTouchEnd: function (e) {
            e.preventDefault();
        },

        onOverlayTouchMove: function (e) {
            e.preventDefault();
        },

        // Ë°åËß¶Êë∏‰∫ã‰ª∂
        onLineTouchStart: function (e) {
            e.preventDefault();
            e.stopPropagation();

            const index = Number(e.currentTarget.dataset.index);
            this.touchStartLine = index;

            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
            if (this.longPressTimer) {
                clearTimeout(this.longPressTimer);
            }

            // ËÆæÁΩÆÈïøÊåâÂÆöÊó∂Âô®Ôºà500msÔºâ
            this.longPressTimer = setTimeout(() => {
                this.toggleLineHighlight(index);
                // Ëß¶ËßâÂèçÈ¶àÔºàÂ¶ÇÊûúÊîØÊåÅÔºâ
                try {
                    uni.vibrateShort();
                } catch (e) {}
            }, 500);
        },

        onLineTouchEnd: function (e) {
            e.preventDefault();
            e.stopPropagation();

            // Ê∏ÖÈô§ÈïøÊåâÂÆöÊó∂Âô®
            if (this.longPressTimer) {
                clearTimeout(this.longPressTimer);
                this.longPressTimer = null;
            }

            this.touchStartLine = null;
        },

        // ÂàáÊç¢Ë°åÈ´ò‰∫Æ
        toggleLineHighlight: function (lineIndex) {
            const arr = this.highlightSelectedLineIndices.slice();
            const pos = arr.indexOf(lineIndex);

            if (pos >= 0) {
                // ÂèñÊ∂àÈÄâ‰∏≠
                arr.splice(pos, 1);
            } else {
                // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøáÈôêÂà∂
                if (arr.length >= 3) {
                    uni.showToast({
                        title: 'ÊúÄÂ§öÂè™ËÉΩÈÄâÊã©‰∏âË°åÈ´òÂÖâ',
                        icon: 'none'
                    });
                    return;
                }
                // Ê∑ªÂä†ÈÄâ‰∏≠
                arr.push(lineIndex);
            }

            arr.sort((a, b) => a - b);
            this.setData({ highlightSelectedLineIndices: arr });

            // Êõ¥Êñ∞È´òÂÖâË°åÊï∞ÊçÆ
            this.updateHighlightLines();
        },

        // Êõ¥Êñ∞È´òÂÖâË°åÊï∞ÊçÆ
        updateHighlightLines: function () {
            const lines = (this.content || '').split(/\r?\n/);
            const picked = this.highlightSelectedLineIndices.map(i => lines[i] || '').filter(Boolean);
            this.setData({
                highlightLines: picked,
                highlightSentence: picked[0] || ''
            });
        },

        // ÂàáÊç¢ÂçïË°åÈ´ò‰∫ÆÔºàÊóßÁöÑÊñπÊ≥ïÔºå‰øùÁïôÁî®‰∫éÂºπÁ™óÊ®°ÂºèÔºâ
        toggleHighlightLine: function (e) {
            const idx = Number(e.currentTarget.dataset.index);
            const arr = this.highlightSelectedLineIndices.slice();
            const pos = arr.indexOf(idx);
            if (pos >= 0) {
                arr.splice(pos, 1);
            } else {
                // ÈôêÂà∂ÊúÄÂ§öÈÄâÊã©‰∏âË°å
                if (arr.length >= 3) {
                    uni.showToast({
                        title: 'ÊúÄÂ§öÂè™ËÉΩÈÄâÊã©‰∏âË°åÈ´òÂÖâ',
                        icon: 'none'
                    });
                    return;
                }
                arr.push(idx);
            }
            arr.sort((a,b) => a - b);
            this.setData({ highlightSelectedLineIndices: arr });
        },

        // ÂÆåÊàêÈÄâÊã©ÔºåÁîüÊàêÈ´òÂÖâË°åÊï∞ÁªÑ
        finishHighlight: function () {
            const lines = (this.content || '').split(/\r?\n/);
            const picked = this.highlightSelectedLineIndices.map(i => lines[i] || '').filter(Boolean);
            this.setData({ highlightLines: picked, highlightSentence: picked[0] || '', highlightSelecting: false });
            uni.showToast({ title: 'Â∑≤ËÆæÁΩÆÈ´òÂÖâ', icon: 'success' });
        },

        // Ê∏ÖÈô§ÈÄâÊã©
        clearHighlight: function () {
            this.setData({ highlightSelectedLineIndices: [], highlightLines: [], highlightSentence: '' });
        },

        // ÈÄâÊã©È¢úËâ≤
        chooseColor: function (e) {
            const color = e.currentTarget.dataset.color;
            this.setData({ selectedBackgroundColor: color, showColorPicker: false });
            uni.showToast({ title: 'Â∑≤ËÆæÁΩÆÈ¢úËâ≤', icon: 'success' });
        },

        noop() {},

        selectTag: function (e) {
            const tag = e.currentTarget.dataset.tag;
            const selectedTags = this.selectedTags;
            if (selectedTags.includes(tag)) {
                // Â¶ÇÊûúÂ∑≤ÈÄâ‰∏≠ÔºåÂàôÂèñÊ∂àÈÄâÊã©
                const index = selectedTags.indexOf(tag);
                selectedTags.splice(index, 1);
            } else {
                // Â¶ÇÊûúÊú™ÈÄâ‰∏≠‰∏îÊú™Ë∂ÖËøáÈôêÂà∂ÔºåÂàôÊ∑ªÂä†
                if (selectedTags.length < 5) {
                    selectedTags.push(tag);
                } else {
                    uni.showToast({
                        title: 'ÊúÄÂ§öÈÄâÊã©5‰∏™Ê†áÁ≠æ',
                        icon: 'none'
                    });
                    return;
                }
            }
            this.setData({
                selectedTags: selectedTags
            });
        },

        onCustomTagInput: function (e) {
            const inputValue = e.detail.value;
            console.log('„ÄêÊ†áÁ≠æËæìÂÖ•„ÄëÁî®Êà∑ËæìÂÖ•:', inputValue);
            this.setData({ customTag: inputValue });
            // ÂÆûÊó∂ÊêúÁ¥¢ÂåπÈÖçÊ†áÁ≠æ
            this.searchMatchingTags(inputValue);
        },

        addCustomTag: function () {
            const tag = this.customTag && this.customTag.trim();
            if (!tag) {
                uni.showToast({
                    title: 'ËØ∑ËæìÂÖ•Ê†áÁ≠æÂÜÖÂÆπ',
                    icon: 'none'
                });
                return;
            }
            if (this.selectedTags.includes(tag)) {
                uni.showToast({
                    title: 'Ê†áÁ≠æÂ∑≤Â≠òÂú®',
                    icon: 'none'
                });
                return;
            }
            if (this.selectedTags.length >= 5) {
                uni.showToast({
                    title: 'ÊúÄÂ§öÈÄâÊã©5‰∏™Ê†áÁ≠æ',
                    icon: 'none'
                });
                return;
            }
            this.selectedTags.push(tag);
            this.setData({
                selectedTags: this.selectedTags,
                customTag: '',
                showMatchedTags: false,
                matchedTags: []
            });
        },

        // ‰øùÂ≠òËçâÁ®ø
        saveDraft: function () {
            return new Promise((resolve) => {
                const draftData = {
                    title: this.title,
                    content: this.content,
                    imageList: this.imageList,
                    publishMode: this.publishMode,
                    isOriginal: this.isOriginal,
                    selectedTags: this.selectedTags,
                    customTag: this.customTag,
                    author: this.author,
                    saveTime: new Date()
                };
                uni.showLoading({ title: "‰øùÂ≠ò‰∏≠..." });
                this.callCloudFunction("getMyProfileData", {
                    action: "saveDraft",
                    draftData: draftData
                }).then((res) => {
                    uni.hideLoading();
                    if (res.result && res.result.success) {
                        uni.showToast({ title: "ËçâÁ®øÂ∑≤‰øùÂ≠ò", icon: "success" });
                        this.clearDraft();
                        resolve(true);
                    } else {
                        console.error("‰øùÂ≠òËçâÁ®øÂ§±Ë¥•:", res.result);
                        uni.showToast({ title: (res.result && res.result.message) ? res.result.message : "‰øùÂ≠òËçâÁ®øÂ§±Ë¥•", icon: "none" });
                        resolve(false);
                    }
                }).catch((err) => {
                    uni.hideLoading();
                    console.error("‰øùÂ≠òËçâÁ®øÂ§±Ë¥•:", err);
                    uni.showToast({ title: "ÁΩëÁªúÈîôËØØÔºå‰øùÂ≠òÂ§±Ë¥•", icon: "none" });
                    resolve(false);
                });
            });
        },

        removeTag: function (e) {
            const tag = e.currentTarget.dataset.tag;
            const selectedTags = this.selectedTags.filter((t) => t !== tag);
            this.setData({
                selectedTags: selectedTags
            });
        },

        // Âä†ËΩΩËçâÁ®ø
        loadDraft: function () {
            try {
                const draftData = uni.getStorageSync('publish_draft');
                if (draftData && draftData.saveTime) {
                    // Ê£ÄÊü•ËçâÁ®øÊòØÂê¶ËøáÊúüÔºà7Â§©Ôºâ
                    const now = new Date().getTime();
                    const draftAge = now - draftData.saveTime;
                    const sevenDays = 10080 * 60 * 1000;
                    if (draftAge < sevenDays) {
                        uni.showModal({
                            title: 'ÊÅ¢Â§çËçâÁ®ø',
                            content: 'Ê£ÄÊµãÂà∞ÊÇ®ÊúâÊú™ÂÆåÊàêÁöÑËçâÁ®øÔºåÊòØÂê¶ÊÅ¢Â§çÔºü',
                            confirmText: 'ÊÅ¢Â§ç',
                            cancelText: 'ÈáçÊñ∞ÂºÄÂßã',
                            success: (res) => {
                                if (res.confirm) {
                                    this.setData({
                                        title: draftData.title || '',
                                        content: draftData.content || '',
                                        imageList: draftData.imageList || [],
                                        publishMode: draftData.publishMode || 'normal',
                                        isOriginal: draftData.isOriginal || false,
                                        selectedTags: draftData.selectedTags || [],
                                        customTag: draftData.customTag || '',
                                        author: draftData.author || '',
                                        maxImageCount: draftData.publishMode === 'poem' ? 1 : 9
                                    });
                                    this.checkCanPublish();
                                    uni.showToast({
                                        title: 'ËçâÁ®øÂ∑≤ÊÅ¢Â§ç',
                                        icon: 'success'
                                    });
                                } else {
                                    this.clearDraft();
                                }
                            }
                        });
                    } else {
                        // ËçâÁ®øËøáÊúüÔºåËá™Âä®Ê∏ÖÈô§
                        this.clearDraft();
                    }
                }
            } catch (e) {
                console.log('CatchClause', e);
                console.log('CatchClause', e);
                console.error('Âä†ËΩΩËçâÁ®øÂ§±Ë¥•:', e);
            }
        },

        // Âä†ËΩΩÁºñËæë‰∏≠ÁöÑËçâÁ®ø
        loadEditingDraft: function () {
            try {
                const draftData = uni.getStorageSync('editing_draft');
                if (draftData) {
                    this.setData({
                        title: draftData.title || '',
                        content: draftData.content || '',
                        imageList: draftData.imageList || [],
                        publishMode: draftData.publishMode || 'normal',
                        isOriginal: draftData.isOriginal || false,
                        selectedTags: draftData.selectedTags || [],
                        customTag: draftData.customTag || '',
                        author: draftData.author || '',
                        maxImageCount: draftData.publishMode === 'poem' ? 1 : 9
                    });
                    this.checkCanPublish();
                    uni.showToast({
                        title: 'ËçâÁ®øÂ∑≤Âä†ËΩΩ',
                        icon: 'success'
                    });
                    // Ê∏ÖÈô§ÁºñËæëËçâÁ®øÊï∞ÊçÆ
                    uni.removeStorageSync('editing_draft');
                }
            } catch (e) {
                console.log('CatchClause', e);
                console.log('CatchClause', e);
                console.error('Âä†ËΩΩÁºñËæëËçâÁ®øÂ§±Ë¥•:', e);
                uni.showToast({
                    title: 'Âä†ËΩΩËçâÁ®øÂ§±Ë¥•',
                    icon: 'none'
                });
            }
        },

        // Ê∏ÖÈô§ËçâÁ®ø
        clearDraft: function () {
            try {
                uni.removeStorageSync('publish_draft');
            } catch (e) {
                console.log('CatchClause', e);
                console.log('CatchClause', e);
                console.error('Ê∏ÖÈô§ËçâÁ®øÂ§±Ë¥•:', e);
            }
        }
    }
};
</script>
<style>
/* pages/add/add.wxss */
page {
    height: 100vh;
    overflow: hidden; /* È°µÈù¢Á∫ßÂà´Á¶ÅÊ≠¢ÊªöÂä® */
}

.container {
    background: #fff;
    height: 100vh; /* Êîπ‰∏∫Âõ∫ÂÆöÈ´òÂ∫¶ÔºåÁ°Æ‰øùÂú®iOS‰∏ãÊ≠£Á°ÆËÆ°ÁÆó */
    display: flex;
    flex-direction: column;
    padding-right: 100rpx; /* reserve space for side toolbar */
    box-sizing: border-box; /* Á°Æ‰øùpaddingËÆ°ÁÆóÂú®ÂÜÖ */
    overflow: hidden; /* Èò≤Ê≠¢Êï¥‰∏™È°µÈù¢ÊªöÂä® */
    position: relative; /* Á°Æ‰øùÂÆö‰Ωç‰∏ä‰∏ãÊñá */
}


/* ÂõæÁâáÈ¢ÑËßàÂå∫Âüü */
.image-section {
    padding: 30rpx;
    background: #f8f9fa;
}

.image-preview-scroll {
    width: 100%;
    white-space: nowrap;
}

.image-preview-container {
    display: flex;
    gap: 20rpx;
    padding: 0 10rpx;
}

.image-preview-item {
    position: relative;
    width: 200rpx;
    height: 200rpx;
    border-radius: 12rpx;
    overflow: hidden;
    flex-shrink: 0;
}

.preview-image {
    width: 100%;
    height: 100%;
    border-radius: 12rpx;
}

.image-remove-btn {
    position: absolute;
    top: -8rpx;
    right: -8rpx;
    width: 40rpx;
    height: 40rpx;
    background: #ff4444;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24rpx;
    font-weight: bold;
    box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.2);
}

.add-image-btn {
    width: 200rpx;
    height: 200rpx;
    border: 2rpx dashed #ddd;
    border-radius: 12rpx;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.add-image-btn:active {
    background: #f5f5f5;
    border-color: #9ed7ee;
}

.add-icon {
    font-size: 60rpx;
    color: #999;
}

/* ÂÜÖÂÆπËæìÂÖ•Âå∫Âüü */
.content-section {
    padding: 30rpx;
    padding-bottom: 30rpx; /* Ëøõ‰∏ÄÊ≠•ÂáèÂ∞ëÂ∫ïÈÉ®Èó¥Ë∑ùÔºåËÆ©ËæìÂÖ•Ê°ÜÊõ¥Êé•ËøëÂ∫ïÈÉ®Â∑•ÂÖ∑Ê†è */
    background: #fff;
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* ÂÖ≥ÈîÆÔºöÂÖÅËÆ∏flexÂ≠êÂÖÉÁ¥†Êî∂Áº© */
    overflow: hidden; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
    position: relative; /* Á°Æ‰øùÂÆö‰Ωç‰∏ä‰∏ãÊñá */
}

.content-input-wrapper {
    position: relative;
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-bottom: 0rpx; /* ÊúÄÂ∞èÂåñÂ∫ïÈÉ®Èó¥Ë∑ùÔºåËÆ©ËæìÂÖ•Ê°ÜÊõ¥Êé•ËøëÂ∫ïËæπÊ†è */
    min-height: 0; /* ÂÖ≥ÈîÆÔºöÂÖÅËÆ∏flexÂ≠êÂÖÉÁ¥†Êî∂Áº© */
    overflow: hidden; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
}

.content-textarea {
    flex: 1;
    width: 100%;
    height: 100%; /* Âõ∫ÂÆöÈ´òÂ∫¶ÔºåÂ°´ÂÖÖÁà∂ÂÆπÂô® */
    border: none;
    font-size: 30rpx;
    line-height: 1.6;
    padding: 24rpx;
    background: #f8f9fa;
    resize: none;
    overflow-y: auto; /* ÂÖÅËÆ∏ÂûÇÁõ¥ÊªöÂä® */
    overflow-x: hidden; /* Á¶ÅÊ≠¢Ê∞¥Âπ≥ÊªöÂä® */
    -webkit-appearance: none;
    appearance: none;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    /* Á°Æ‰øùÂú®iOS‰∏äÊ≠£Á°ÆÊòæÁ§∫ */
    -webkit-user-select: text;
    user-select: text;
    -webkit-touch-callout: default;
    /* Èò≤Ê≠¢iOS‰∏äÁöÑÈªòËÆ§Ê†∑ÂºèÂπ≤Êâ∞ */
    border-radius: 12rpx;
    outline: none;
    /* Á°Æ‰øùÊªöÂä®Ë°å‰∏∫ */
    -webkit-overflow-scrolling: touch; /* iOSÂπ≥ÊªëÊªöÂä® */
    position: relative; /* Á°Æ‰øùÂÆö‰Ωç‰∏ä‰∏ãÊñá */
}

/* ÂΩìÈ´òÂÖâÊ®°ÂºèÂêØÁî®Êó∂ÔºåÈöêËóètextareaÁöÑÊñáÂ≠óÂÜÖÂÆπ */
.content-input-wrapper[data-highlight-mode="true"] .content-textarea {
    color: transparent;
}

.char-count {
    position: absolute;
    bottom: 10rpx; /* ÁßªÂà∞textareaÂ§ñÈù¢ÔºåÁªôÊñáÂ≠óÁïôÂá∫Á©∫Èó¥ */
    right: 110rpx; /* leave space for side toolbar */
    font-size: 24rpx;
    color: #666;
    background: #fdfdfd;
    padding: 8rpx 12rpx;
    border-radius: 6rpx;
    box-shadow: none;
    pointer-events: none; /* Èò≤Ê≠¢ÈÅÆÊå°textareaÁöÑÁÇπÂáª */
}


/* Ê®°ÂºèÈÄâÊã©Âô® */
.mode-selector {
    position: fixed;
    bottom: 120rpx;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    border-radius: 16rpx;
    padding: 24rpx;
    z-index: 99;
    box-shadow: 0 -4rpx 20rpx rgba(0, 0, 0, 0.15);
    animation: slideUp 0.3s ease;
    border: 1rpx solid #f0f0f0;
    margin-left: -98rpx; /* ÂêëÂ∑¶ÂÅèÁßªÔºåÂØπÈΩêÊ®°ÊåâÈíÆ */
    min-width: 320rpx;
}

.mode-title {
    text-align: center;
    font-size: 28rpx;
    font-weight: 500;
    color: #333;
    margin-bottom: 20rpx;
    padding-bottom: 16rpx;
    border-bottom: 1rpx solid #f0f0f0;
}

.mode-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16rpx;
}

.mode-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20rpx 16rpx;
    border-radius: 12rpx;
    background: #f8f9fa;
    transition: all 0.3s ease;
    border: 1rpx solid transparent;
}

.mode-item:active {
    transform: scale(0.95);
    background: #e9ecef;
}

.mode-item:hover {
    border-color: #9ed7ee;
    background: #f0f8ff;
}

.mode-icon {
    font-size: 36rpx;
    margin-bottom: 8rpx;
}

.mode-text {
    font-size: 24rpx;
    color: #666;
    text-align: center;
    line-height: 1.2;
}

@keyframes slideUp {
    from {
        transform: translateX(-50%) translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}


/* Ê†áÁ≠æÈÄâÊã©Âå∫ÂüüÊ†∑Âºè */
.tag-section {
    position: fixed; /* Á°Æ‰øùÊ†áÁ≠æÈÄâÊã©Âô®ÊòØÂü∫‰∫éÁ™óÂè£ÂÆö‰ΩçÁöÑ */
    bottom: 120rpx; /* ÂàùÂßã‰ΩçÁΩÆÂú®Â∑•ÂÖ∑Ê†è‰∏äÊñπ */
    left: 0;
    right: 100rpx; /* ‰∏∫Âè≥‰æßÂ∑•ÂÖ∑Ê†èÈ¢ÑÁïôÁ©∫Èó¥ */
    background: #f8f9fa;
    border-radius: 12rpx;
    padding: 20rpx;
    z-index: 90; /* z-index ÊØîÂ∑•ÂÖ∑Ê†è‰ΩéÔºå‰ΩÜÊØîÂÜÖÂÆπÈ´ò */
    transition: bottom 0.3s ease-out; /* ‰∏∫‰ΩçÁΩÆÂèòÂåñÊ∑ªÂä†ËøáÊ∏° */
}

.tag-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10rpx 0;
    border-bottom: 1px solid #eee;
    margin-bottom: 20rpx;
}

.tag-title {
    font-size: 30rpx;
    font-weight: bold;
    color: #333;
}

.tag-count {
    font-size: 24rpx;
    color: #999;
}

.tag-toggle {
    font-size: 26rpx;
    color: #9ed7ee;
}

.selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10rpx;
    margin-bottom: 20rpx;
}

.selected-tag {
    display: flex;
    align-items: center;
    background: #9ed7ee;
    color: white;
    padding: 8rpx 16rpx;
    border-radius: 20rpx;
    font-size: 24rpx;
}

.remove-tag {
    margin-left: 8rpx;
    font-size: 20rpx;
    font-weight: bold;
    cursor: pointer;
}

.tag-selector {
    animation: slideDown 0.3s ease;
}

/* ÂàÜÁ±ªÈÄâÊã©Âô®Ê†∑Âºè */
.category-selector {
    margin-bottom: 20rpx;
    border-bottom: 1px solid #eee;
    padding-bottom: 15rpx;
}

.category-scroll {
    width: 100%;
    white-space: nowrap;
}

.category-list {
    display: flex;
    gap: 15rpx;
    padding: 0 10rpx;
}

.category-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10rpx 15rpx;
    border-radius: 12rpx;
    background: #f5f5f5;
    transition: all 0.3s ease;
    min-width: 80rpx;
    flex-shrink: 0;
}

.category-item.active {
    background: #9ed7ee;
    color: white;
}

.category-icon {
    font-size: 24rpx;
    margin-bottom: 5rpx;
}

.category-name {
    font-size: 20rpx;
    text-align: center;
    line-height: 1.2;
}

/* ÂΩìÂâçÂàÜÁ±ªÊ†áÁ≠æÊ†∑Âºè */
.current-category-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10rpx;
    margin-bottom: 20rpx;
}

.preset-tag {
    padding: 8rpx 16rpx;
    background: white;
    border: 1px solid #ddd;
    border-radius: 20rpx;
    font-size: 24rpx;
    color: #666;
    transition: all 0.3s ease;
}

.preset-tag.selected {
    background: #9ed7ee;
    color: white;
    border-color: #9ed7ee;
}

.custom-tag-input {
    display: flex;
    align-items: center;
    gap: 10rpx;
}

.custom-tag-input input {
    flex: 1;
    height: 60rpx;
    border: 1px solid #ddd;
    border-radius: 8rpx;
    padding: 0 15rpx;
    font-size: 26rpx;
}

.custom-tag-input button {
    background: #9ed7ee;
    color: white;
    border: none;
    border-radius: 8rpx;
    padding: 0 20rpx;
    height: 60rpx;
    font-size: 24rpx;
}

/* ÂåπÈÖçÊ†áÁ≠æÊé®ËçêÊ†∑Âºè */
.matched-tags {
    margin-top: 15rpx;
    padding: 15rpx;
    background: #f8f9fa;
    border-radius: 8rpx;
    border: 1px solid #e9ecef;
}

.matched-tags-title {
    font-size: 24rpx;
    color: #666;
    margin-bottom: 10rpx;
}

.matched-tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8rpx;
}

.matched-tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 6rpx 12rpx;
    border-radius: 12rpx;
    font-size: 22rpx;
    border: 1px solid #bbdefb;
    transition: all 0.2s ease;
}

.matched-tag:active {
    background: #bbdefb;
    transform: scale(0.95);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10rpx);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ====== Êñ∞Â¢ûÔºöÂè≥‰æßÂ∑•ÂÖ∑Ê†èÊ†∑Âºè ====== */
.side-toolbar {
    position: fixed;
    top: 120rpx;
    right: 0;
    bottom: 120rpx;
    width: 100rpx;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 22rpx;
    z-index: 10;
    padding: 40rpx 0 8rpx 0;
    background: #fff;
    border-left: 1rpx solid #f0f0f0;
}

.side-tool-btn {
    width: 72rpx;
    height: 72rpx;
    border-radius: 12rpx;
    border: 1rpx solid #e5e5e5;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2rpx 8rpx rgba(0,0,0,.04);
}

.side-tool-btn:active { transform: scale(0.96); }

.side-tool-icon { font-size: 24rpx; color: #333; }

/* ËÆ©Ê≠£Êñá‰∏∫Âè≥‰æßÂ∑•ÂÖ∑Ê†èÈ¢ÑÁïôÁ©∫Èó¥ÂèäËÆ°Êï∞ÈÅøËÆ© */
.content-input-wrapper { padding-right: 20rpx; }
.char-count { right: 130rpx; }

/* È¢úËâ≤ÈÄâÊã©ÂºπÂ±Ç */
.color-picker-mask { position: fixed; left: 0; right: 0; top: 0; bottom: 0; background: rgba(0,0,0,.35); z-index: 130; display: flex; align-items: flex-end; }
.color-picker { width: 100%; background: #fff; border-top-left-radius: 24rpx; border-top-right-radius: 24rpx; padding: 24rpx 28rpx calc(24rpx + env(safe-area-inset-bottom)); }
.color-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-gap: 24rpx; }
.color-swatch { height: 88rpx; border-radius: 16rpx; position: relative; box-shadow: 0 4rpx 12rpx rgba(0,0,0,.08); }
.color-check { position: absolute; right: 12rpx; top: 8rpx; color: #fff; font-size: 28rpx; text-shadow: 0 1rpx 2rpx rgba(0,0,0,.3); }
.color-tip { margin-top: 14rpx; color: #999; font-size: 24rpx; text-align: center; }

/* È´òÂÖâÈÄâÊã© - ÂÖ®Â±èË¶ÜÁõñÊ†∑Âºè */
.highlight-overlay { position: fixed; left: 0; right: 0; top: 0; bottom: 0; background: rgba(0,0,0,.6); z-index: 1000; display: flex; align-items: stretch; justify-content: stretch; }
.hl-panel { background: #fff; width: 100%; height: 100%; display: flex; flex-direction: column; }
.hl-header { display: flex; align-items: center; justify-content: space-between; padding: 20rpx 28rpx; border-bottom: 1rpx solid #eee; position: sticky; top: 0; background: #fff; z-index: 1; }
.hl-title { font-size: 30rpx; color: #333; }
.highlight-scroll { flex: 1; padding: 16rpx 24rpx 40rpx; }
.hl-line { padding: 14rpx 18rpx; border-radius: 10rpx; margin: 8rpx 0; background: #f6f7f9; }
.hl-line.selected { font-weight: 700; background: #e8f2ff; }
.hl-text { white-space: pre-wrap; word-break: break-word; font-size: 30rpx; color: #333; }
.hl-done { background: #1c9bd6; color: #fff; padding: 0 20rpx; }
.hl-clear { background: #eee; color: #333; padding: 0 20rpx; }

/* È´òÂÖâÈÄâÊã©Ë¶ÜÁõñÂ±ÇÊ†∑Âºè */
.highlight-overlay {
    border: none;
}

.hl-done {
    background: #9ed7ee;
    color: #fff;
}

.hl-clear {
    background: #666;
    color: #fff;
}

/* Êñ∞ÁöÑË¶ÜÁõñÂ±ÇÊ†∑Âºè */
.highlight-select-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    pointer-events: auto;
}

.overlay-scroll {
    height: 100%;
    width: 100%;
}

.overlay-content {
    padding: 24rpx;
    font-size: 30rpx;
    line-height: 1.6;
    color: transparent; /* ÈÄèÊòéÊñáÂ≠óÔºåÂè™Áî®‰∫éÂ∏ÉÂ±Ä */
}

.overlay-line {
    min-height: 48rpx;
    margin: 0;
    position: relative;
    transition: background-color 0.2s ease;
}

.overlay-line.highlighted {
    background-color: rgba(158, 215, 238, 0.2);
    border-radius: 8rpx;
}

.overlay-line-content {
    color: #666; /* ÂçäÈÄèÊòéÈ¢úËâ≤ÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞‰∏ãÈù¢ÁöÑÊñáÂ≠ó */
    white-space: pre-wrap;
    word-break: break-word;
    font-family: inherit;
}

/* È´òÂÖâÈÄâÊã©ÊèêÁ§∫ */
.highlight-hint {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 20rpx 30rpx;
    border-radius: 12rpx;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 20rpx;
}

.hint-text {
    font-size: 28rpx;
}

.hint-close {
    width: 40rpx;
    height: 40rpx;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32rpx;
    opacity: 0.7;
    touch-action: none;
}

/* Ë∞ÉÊï¥textareaÁöÑz-indexÔºåÁ°Æ‰øùÂú®Ë¶ÜÁõñÂ±Ç‰∏ãÊñπ */
.content-textarea {
    z-index: 0;
}

/* ÂΩìÈ´òÂÖâÊ®°ÂºèÂêØÁî®Êó∂ÔºåtextareaÁöÑÊ†∑ÂºèË∞ÉÊï¥ */
.content-input-wrapper {
    position: relative;
}

</style>







