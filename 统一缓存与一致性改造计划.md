# 统一缓存与一致性改造计划（uni-app × CloudBase）

本文给出“临时 URL 缓存 + 统一缓存工具（CacheManager）+ 跨端一致性”的实施路线，按优先级分阶段落地，确保简单易用、可灰度回滚。

— 版本：v1（2025-10-11）

## 目标与原则

- 目标：
  - 提升首屏与滚动性能，降低云函数与网络调用量。
  - 保持多端一致性（多设备/多平台），允许短暂可控陈旧，关键数据“近实时”。
  - 对前端开发者暴露简洁稳定的 API，便于后续功能扩展/重构。
- 原则：
  - 客户端优先，本地缓存先返回，必要时后台刷新（SWR）。
  - 可观测：有命中率/耗时统计与日志开关。
  - 安全：尊重服务端过期（maxAge），为临时 URL 预留刷新裕量。
  - 可灰度、可回滚：功能开关与回退预案完善。

## 优先级说明

- P0：强相关、立竿见影，优先完成。
- P1：结构化优化，提升长期可维护性与一致性。
- P2：增强与体验加分项。

## 路线图（分阶段）

### Phase 1（P0，1–2 天）：临时 URL 缓存落地与接入

- 任务
  - 接入 `_utils/file-url-cache.js`（已完成初版）：
    - 批处理 + TTL + 去重 + 多端兜底（tcb / wx.cloud / 云函数）。
    - 默认 TTL：55 分钟；安全提前量：≥ 5 分钟（从 1 分钟提升）。
  - 页面集成：
    - 在列表与详情页引入 `hydrateTempUrls(list)`，批量映射 cloud:// → http(s)。
    - 触底/预判下一页调用 `fileUrlCache.warm(nextIds)` 进行预热。
  - 本机失效：
    - 上传/更换头像/删除图片成功后，`fileUrlCache.invalidate(oldFileId)`。
  - 版本化 URL（cache-busting）：
    - 展示层拼接 `?v=<updatedAt|version>`（头像、帖子图片），避免跨设备“长 TTL 显旧图”。
- 交付物
  - 工具：`_utils/file-url-cache.js`（已存在）。
  - 接入示例/混入：`_utils/hydrate-temp-urls.js`（新增，便于在各页直接复用）。
  - 文档：使用说明与最佳实践（本计划 + 代码注释）。
- 验收标准
  - 首屏与翻页图片加载云函数调用量下降 ≥30%。
  - 页面未出现因 URL 过期导致的图片 404（稳态）。
  - 常用路径不增加白屏时长（监控 P75/P95）。

### Phase 2（P1，2–4 天）：统一缓存工具 CacheManager

- 任务
  - 新增 `_utils/cache-manager.js`：
    - 多层缓存：内存层（Map/LRU）+ 可选持久层（uniStorage）。
    - 命名空间：按 `openid` 与业务划分（如 `fileUrls:`, `profiles:`, `tags:`）。
    - 统一 API：
      - `namespace(name)` → 命名空间句柄
      - `get(key) / set(key, val, { ttlMs }) / delete(key) / clear()`
      - `getOrFetch(key, loader, { ttlMs, swrMs })`（SWR 支持）
      - 容量与淘汰：内存 LRU（条目上限），持久层容量与清理策略。
    - 观测：`hits/misses/evictions` 计数，`debug` 日志开关。
  - 将 `file-url-cache` 的 Map 替换为 `cacheManager.namespace('fileUrls')` 存取（对外 API 不变）。
  - 提供通用工具：
    - `stableKey(params)`（稳定 JSON 序列化）
    - `withSWR()` 辅助函数
  - 开关与配置：
    - `CACHE_DEBUG`、`CACHE_MAX_ITEMS`、`CACHE_STORAGE_ENABLED` 等配置位（从 `manifest.json` 或环境注入）。
- 交付物
  - 工具：`_utils/cache-manager.js`、改造后的 `_utils/file-url-cache.js`。
  - 文档：API 说明与示例。
- 验收标准
  - 替换后所有页面行为一致；`file-url-cache` 命中率提升、内存可控。
  - 开启持久层后，冷启动列表请求减少，性能数据无明显回退。

### Phase 3（P1，3–5 天）：数据缓存与一致性增强

- 任务
  - 基于 CacheManager 实现以下业务缓存：
    - 用户资料（`profiles`）：TTL 30–60 分钟，SWR 5 分钟。
    - 标签列表（`tags`）：TTL 30–60 分钟，SWR 5 分钟。
    - 未读数（`unread`）：TTL 30–60 秒，页面 onShow 轻刷新。
    - Feed 列表（`postList`/`discover`）：分页分键，SWR 开启，前后台切换无闪烁。
  - 变更驱动失效：
    - 点赞/评论/删除后，失效当前帖子详情与所在分页条目键。
    - 登出/切账号：清空与用户相关的命名空间。
  - 监控与告警：
    - 前端埋点（命中率/耗时）+ 云函数侧请求量对比。
- 交付物
  - `api-cache/*.js` 示例与封装。
  - 页面改造 PR（index、post-detail、profile 等）。
- 验收标准
  - 页面返回/切换明显更快；接口总请求量下降 ≥20%。
  - 未读等易变数据“近实时”，无明显延迟感。

### Phase 4（P1→P2，2–4 天）：后端配合与灰度治理

- 任务
  - 云函数去除列表接口内的 `getTempFileURL`（改为返回 `cloud://`），由客户端统一转换（先灰度分流 10%/30%/100%）。
  - 引入“revision 水位线”：
    - 变更时写入 per-user/全局 revision；客户端 onShow/interval 对比，落后时批量失效关键缓存。
  - 可选：对用户/未读等小集合使用 CloudBase 实时推送（watch），实现秒级刷新。
- 交付物
  - 云函数改造 PR（getPostList、getHotFeed、imageManager 等）。
  - 灰度/回滚配置与实施文档。
- 验收标准
  - 灰度期间错误率不升高；调用量与时延指标稳定或下降。

### Phase 5（P2，持续）：优化与清理

- 任务
  - 指标看板：命中率、P75/P95 加载耗时、云函数调用量。
  - 策略调优：按业务热度调 TTL/SWR；冷热分层与黑/白名单键。
  - 文档与示例保持更新；清理废弃路径与冗余代码。

## 统一 API 设计（摘要）

```ts
// cache-manager
type CacheOptions = { ttlMs?: number; swrMs?: number };
type Namespace = {
  get: (key: string) => Promise<any> | any;
  set: (key: string, val: any, opts?: CacheOptions) => Promise<void> | void;
  delete: (key: string) => Promise<void> | void;
  clear: () => Promise<void> | void;
  getOrFetch: <T>(key: string, loader: () => Promise<T>, opts?: CacheOptions) => Promise<T>;
};
namespace(name: string): Namespace;

// file-url-cache（对外不变）
getTempUrls(fileIds: string[]): Promise<Record<string, string>>;
getTempUrl(fileId: string): Promise<string>;
warm(fileIds: string[]): void;
invalidate(ids?: string | string[]): void;
setResolver(fn: (ids: string[]) => Promise<Record<string, { url: string; maxAgeSec?: number }>>): void;
```

## 风险与缓解

- 旧图/不一致（跨设备）：用版本参数或新路径、缩短 TTL、onShow 轻刷新、revision 机制。
- Storage 空间/内存占用：容量上限 + LRU 淘汰；按命名空间清理。
- 兼容性（多端差异）：优先 tcb，其次 wx.cloud，最后云函数兜底；统一错误处理与重试。
- 监控缺失：上线即埋点与日志开关；设定阈值告警。

## 工期与分工建议（可并行）

- Phase 1：1–2 天（1 前端）
- Phase 2：2–4 天（1 前端）
- Phase 3：3–5 天（1 前端 + 1 后端）
- Phase 4：2–4 天（1 前端 + 1 后端）
- Phase 5：持续（0.5 人天/周巡检）

## 验收指标（关键 KPI）

- 云函数 `getTempFileURL` 总调用量下降 ≥40%。
- 首屏/翻页图片可见时间 P75 降低 ≥20%。
- 列表接口聚合耗时 P75 降低 ≥20%（移除 lookup 后）。
- 重大问题零回滚（灰度期间）。

---

如同意此计划，我将先提交 Phase 1 的混入/工具与页面接入 PR，然后推进 CacheManager 的实现与替换。

---

## 已完成（2025-10-11）

- 通用与工具
  - 新增统一缓存工具 CacheManager（_utils/cache-manager.js）：内存 LRU + 可选 uniStorage 持久化，支持 getOrFetch + SWR。
  - 临时 URL 缓存接入 CacheManager 命名空间（fileUrls），保留原 API（_utils/file-url-cache.js）。
  - 新增 hydrate 工具（_utils/hydrate-temp-urls.js），统一批量映射 cloud:// → http(s)。
  - 新增全局事件工具（utils/events.js）：EVENTS 常量与 emitAvatarUpdated/emitPostCreated/emitFavoriteChanged。

- 页面接入（首批）
  - 首页（pages/index/index.vue）：图片 URL hydrate + 预热；未读数改为缓存封装（api-cache/unread.js）。
  - 详情页（pages/post-detail/post-detail.vue）：post 与评论图片 hydrate；收藏成功触发 favorite-changed（修复过一次语法问题）。
  - 他人主页（pages/user-profile/user-profile.vue）：资料与帖子分页改为缓存（api-cache/user-profile.js），仅监听头像变更与发帖事件；不因收藏变化刷新。
  - 我的主页（pages/profile/profile.vue）：我的帖子与收藏分页改为缓存（api-cache/my.js）；绑定事件驱动失效（头像/发帖/收藏）。
  - 头像编辑页（pages/profile-edit/profile-edit.vue）：保存成功触发 avatar-updated。
  - 发帖页（pages/add/add.vue）：发布成功触发 post-created。
  - 收藏夹选择组件（components/folder-selector/folder-selector.vue）：收藏成功触发 favorite-changed（同时保留组件内 favoriteSuccess 事件）。

- API 缓存封装
  - api-cache/unread.js：未读数，TTL 60s + SWR 60s（首页已接入）。
  - api-cache/profile.js：我的资料（持久化，TTL 30min + SWR 5min，预留给后续页面）。
  - api-cache/tags.js：标签列表（持久化，TTL 30min + SWR 5min，预留）。
  - api-cache/user-profile.js：他人主页的资料与帖子（无 TTL，仅事件触发失效）。
  - api-cache/my.js：我的资料/帖子/收藏（无 TTL，仅事件触发失效）。

- 触发与监听规范（已落地）
  - 触发点：
    - 发帖成功（pages/add/add.vue）→ post-created
    - 头像保存成功（pages/profile-edit/profile-edit.vue）→ avatar-updated
    - 收藏成功（components/folder-selector/folder-selector.vue、pages/post-detail/post-detail.vue）→ favorite-changed
    - 取消收藏成功（pages/profile/profile.vue）→ favorite-changed（favored:false）
  - 监听：
    - 他人主页仅监听 avatar-updated、post-created
    - 我的主页监听 avatar-updated、post-created、favorite-changed

---

## 下一步（建议优先级与粒度）

P1（优先）
- 发现页（index.vue: discover）与标签筛选页（pages/tag-filter/tag-filter.vue）
  - 列表分页接入 CacheManager：namespace 形如 posts:discover:<page>、posts:tag:<tag>:<page>（TTL 60–120s + SWR 30–60s）
  - 使用 hydrateTempUrls 与 warm 预热
- 首页/发现页聚合降负
  - 云函数 getPostList/getHotFeed 去除服务端 getTempFileURL 转换（先灰度），返回原始 cloud://，完全由前端缓存解析

P1（结构与一致性）
- 收藏夹列表页与收藏夹删除操作
  - 在“删除收藏夹”与“批量取消收藏”成功后，emit favorite-changed（可不带 postId，监听侧做整页失效）
  - 我的主页 favorites 命名空间增加整页失效入口（已支持 invalidateMyFavorites() 全清）
- 统一 dataCache 双写与迁移
  - 将历史 dataCache 键映射到 CacheManager（过渡期双写/回读），最终移除 dataCache 依赖

P2（可选增强）
- 引入 revision 水位线
  - 云端维护 per-user/global revision；前端 onShow 轻量对比，落后则批量失效关键缓存
- 监控与观测
  - 埋点命中率/耗时（命名空间/键维度），看板化；发现异常命中或大键及时调整 TTL/SWR

---

## 提交与发布

- 当前环境未安装 Git，已在仓库生成待提交说明：
  - .pending_commits/2025-10-11-commit-01.txt ～ 07.txt（按阶段与功能拆分）
- 本机提交命令：
  - git add -A
  - git commit -F .pending_commits/2025-10-11-commit-0X.txt（依次提交或 squash）


---

## 追加实施记录（2025-10-11）

以下为本次在“统一缓存与一致性改造计划”基础上已落地的补充与优化，便于对照验收与后续迭代。

### 一、列表与页面接入（P1 优先项）

- 首页广场分页缓存（posts:home）
  - 新增 `api-cache/home-posts.js`（TTL 90s + SWR 45s）。
  - `pages/index/index.vue`：
    - `getPostList` 改为调用 `getHomePosts`，保留 normalize + `hydrateTempUrls` + 预热；删除旧的直调 `this.$tcb.callFunction('getPostList')` 分支。
    - `getIndexData` 改为直接通过 `getHomePosts` 首屏拉取；去除 `dataCache` 首屏命中与后续读写。
    - 去除点赞状态的 dataCache 同步逻辑（由 CacheManager 接管）。

- 发现页推荐缓存（posts:discover）
  - 新增 `api-cache/discover.js`（TTL 90s + SWR 45s）。
  - `pages/index/index.vue` 的 `loadRecommendationPosts` 已切换到缓存封装，并继续执行 hydrate + 预热。

- 标签筛选分页缓存（posts:tag:<tag>）
  - 新增 `api-cache/tag-posts.js`（TTL 90s + SWR 45s）。
  - `pages/tag-filter/tag-filter.vue` 接入缓存封装，normalize + hydrate + 预热。

### 二、临时 URL 持久化与失效

- `/_utils/file-url-cache.js`
  - 批量换取结果现在会同步写入 `cacheManager.namespace('fileUrls')`（持久化）；`invalidate()` 同步清理命名空间，冷启动也能命中。
  - 仍保留 55min 默认 TTL 与 1min 安全裕量（SKEW），列表页继续支持预热（warm）。

### 三、事件驱动的跨页一致性

- 新增 `api-cache/events.js`：桥接全局事件 → 缓存失效
  - `post-created` → 失效首页（posts:home）并清理发现页缓存（posts:discover）。
  - `avatar-updated` → 失效用户资料与其主页分页（profiles:user / userPosts:<uid>）。
  - 暂不处理收藏夹整页失效（按现阶段取舍）。
- `main.js`：在初始化处调用 `setupCacheEventBridges()` 完成一次性注册。

### 四、我的主页体验优化（头像/签名首屏慢）

- `api-cache/my.js`
  - `getMyInfo` 调整为 TTL 30min + SWR 5min，并兼容 `result.userInfo / result.profile / result.data` 等后端返回结构。
  - 若 `avatarUrl` 为 `cloud://`，在 loader 内预先通过 `fileUrlCache.getTempUrl()` 映射为可访问 URL，并在可用时拼接 `?v=<updatedAt|updateTime|_updateTime>`，避免跨设备旧图缓存。
  - 修正工具导入路径为 `@/_utils/*`。
- `pages/profile/profile.vue`
  - 新增 `fetchUserProfileFast()`，直接使用 `getMyInfo`（SWR）返回，替换原来的串行 `getOpenId → getMyProfileData` 请求链路；多处调用点已改为 `this.fetchUserProfileFast()`。
  - 移除脱离方法体的旧直调代码，修复 Unexpected keyword 'this' 编译错误。

### 五、提交记录

- 由于当前环境未装 Git，额外新增 `/.pending_commits/2025-10-11-commit-08.txt`，说明上述改动内容与建议提交命令。

### 六、当前效果与验证建议

- 首页/发现/标签：90s 内二次进入命中缓存；90–135s 为 SWR 窗口，先展示缓存、后台刷新；图片 URL 通过 hydrate 转换，避免过期 404。
- 我的主页：资料与头像首屏更快，二次进入几乎秒到；头像跨设备更新依赖事件桥接与 `?v=` 版本参数。

### 七、后续建议（可作为下一阶段）

1) 登录完成后的资料与头像预热：在 `main.js` 登录完成后并行调用 `getMyInfo()` 并对头像做 `fileUrlCache.warm()`，实现“未进页面先准备好”。
2) CacheManager 观测与开关：新增 `CACHE_DEBUG` 与 `hits/misses/evictions` 统计，提供按命名空间打印方法，便于压测与调参。
3) dataCache 全量迁移/清理：搜索仓库残留使用点，逐一替换为 CacheManager；首页已完成。
4) 后端灰度“只返回 cloud://”：列表类接口移除服务端 `getTempFileURL`，10%→30%→100% 渐进；前端已具备 hydrate 能力。
5) revision 水位线（可选增强）：轻量对比 per-user/global revision，落后即时批量失效关键缓存。

---

## 使用说明（新增能力）

- 资料与头像预热
  - 位置：`main.js`
  - 行为：登录完成（检测 `globalData._loginProcessCompleted` 且存在 `openid`）后自动调用 `getMyInfo` 进行预热；头像在接口侧完成 cloud:// → https 映射并写入持久层。
  - 观察：控制台出现 `🔰 [prewarm] getMyInfo done`。

- CacheManager 调试与统计
  - 位置：`@/_utils/cache-manager.js`、`main.js`
  - 开关：`uni.setStorageSync('CACHE_DEBUG','1')` 后重启；或运行时调用 `uni.$cacheDebug(true|false)` 动态切换。
  - 查看：`uni.$cacheStats()` 输出各命名空间 `hits/misses/evictions/size` 等统计。
  - 作用：辅助压测与监控缓存命中情况，便于调整 TTL/SWR 与容量。

---

## 彻底迁移与清理（已完成）

- dataCache 适配与移除直依赖
  - 删除 `utils/dataCache.js`（历史适配层已移除）；工程内不再直接依赖 dataCache。
  - `utils/avatarCache.js` 与 `utils/followCache.js` 已改为直接使用 CacheManager 命名空间，不再依赖 dataCache：
    - 头像命名空间：`avatars`（TTL 24h，持久化）。
    - 关注命名空间：`follow:<currentUserId>`（TTL 1h，持久化）。
  - `pages/index/index.vue` 修复预加载依赖，显式导入 `utils/followCache.js`。
  - `utils/likeService.js`：点赞后会在 CacheManager 命名空间内进行局部键更新（`posts:home`、`posts:discover`、`posts:tag:*`、`me:posts`、`userPosts:*`）。

- 验证与回归项
  - 首页加载后执行 `uni.$cacheStats()`，应看到 `avatars` 与 `follow:<uid>` 命中增长。
  - 清除用户关注缓存：调用 `require('utils/followCache.js').clearUserFollowCache('<uid>')`，再次进入应触发加载并回写。

---

## 改造后现状（2025-10-11）

以下为当前“统一缓存与一致性”上线后的实际缓存拓扑、时效策略与触发器，便于全局把握与后续调优。

### 缓存命名空间与时效

- 列表/分页（持久化，通用 TTL 90s + SWR 45s）
  - `posts:home`：广场首页分页。
  - `posts:discover`：发现页推荐（单页）。
  - `posts:tag:<tag>`：标签筛选分页。

- 资料/详情
  - `me:info`：我的资料；TTL 30min + SWR 5min；持久化；登录完成会预热（main.js）。
  - `me:posts`：我的帖子；TTL 0（仅事件失效）。
  - `me:favorites`：我的收藏；TTL 0（仅事件失效）。
  - `profiles`：我的资料（备用封装，TTL 30min + SWR 5min，持久化）。
  - `profiles:user`：他人资料；TTL 0（仅事件失效）。
  - `userPosts:<userId>`：他人主页帖子；TTL 0（仅事件失效）。

- 运营/基础数据
  - `tags`：标签列表；TTL 30min + SWR 5min；持久化。
  - `unread`：未读数；TTL 60s + SWR 60s；非持久化。

- 媒体/临时 URL
  - `fileUrls`：cloud:// → https 临时 URL 映射；有效期≈55min（预留 1min 裕量）；当前为内存 + 命名空间存取（非持久化），页面统一 `hydrateTempUrls` + `warm` 预热。

- 头像与关注
  - `avatars`：用户头像/昵称/个签；TTL 24h；持久化；头像为 cloud:// 时在写缓存前完成一次映射（fileUrlCache）。
  - `follow:<currentUserId>`：关注状态；TTL 1h；持久化；支持批量预热。

说明：SWR 表示“过期后在 SWR 窗口内返回陈旧值并后台刷新”，提升首屏可见速度与滚动顺畅度。

### 触发器（事件/动作）

- 全局事件（见 `api-cache/events.js` + `main.js`）
  - `post-created`：失效 `posts:home`，清理 `posts:discover`。
  - `avatar-updated`：失效 `me:info` 与 `profiles:user`/`userPosts:<uid>`（若在他人主页）。
  - `favorite-changed`：当前阶段按你的要求不做整页失效（留给后续增强）。

- 页面内动作
  - 点赞成功：在 CacheManager 的 `posts:home` / `posts:discover` / `posts:tag:*` / `me:posts` / `userPosts:*` 中“局部键更新”目标帖子的 `votes/isVoted/likeIcon`（无需整页失效）。
  - 临时 URL 相关：上传/替换/删除成功后对涉及的 fileID 调用 `fileUrlCache.invalidate()`；页面 hydrate 负责批量换取与预热。
  - 登录完成：`main.js` 自动预热 `me:info`（首进“我的”更快）。

### 调试与观测

- 打开/关闭调试：`uni.$cacheDebug(true|false)`。
- 查看统计：`uni.$cacheStats()`（输出各命名空间的 `hits/misses/evictions/gets/sets/size`）。

---

## 可继续优化方向（建议）

- 收藏变更治理（P1）
  - 收藏/取消收藏/删除收藏夹后，按页或整页对 `me:favorites`、`posts:home|discover|tag:*` 进行“局部键更新”或快速失效，保证列表与详情一致。

- 后端“只返回 cloud://”灰度（P1）
  - 去除列表类接口中的 `getTempFileURL`，分 10% → 30% → 100% 灰度；依赖前端统一 `hydrate`；观测云函数调用量与 P75 指标回归。

- revision 水位线（P2）
  - 维护 per-user / global revision；前端在 onShow 或轮询对比，落后时批量失效关键命名空间（如 me:info、posts:*、tags 等），降低长驻陈旧概率。

- 更新范围收敛（P2）
  - 将点赞/收藏后的局部更新限定到“当前活跃分页附近”的键，减少不必要的扫描与更新。

- 可视化看板（P2）
  - 将 `uni.$cacheStats()` 序列化上报到看板（如云函数/日志服务），长期跟踪命中率与流量下降幅度。
