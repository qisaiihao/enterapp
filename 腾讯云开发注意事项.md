# 腾讯云开发（TCB）使用注意事项

## 📋 项目概述

本项目使用**腾讯云开发（TCB）**作为后端服务，而不是uniCloud。所有云函数都部署在腾讯云开发环境中。

## 🔧 环境配置

### 环境ID
- **环境ID**: `cloud1-5gb0pbyl400845f5`
- **配置文件**: `cloudbaserc.json`
- **框架类型**: uni-app

### 云函数配置
- **运行时**: Node.js 16.13
- **内存配置**: 根据函数复杂度调整（128MB-512MB）
- **超时时间**: 根据函数需求调整（5-30秒）

## ⚠️ 重要注意事项

### 1. SDK初始化问题

#### 问题描述
```
TypeError: Cannot read property 'database' of undefined
```

#### 解决方案
在访问数据库前，必须确保TCB SDK正确初始化：

```javascript
// ✅ 正确的数据库访问方式
let db;
if (this.$tcb && this.$tcb.database) {
    db = this.$tcb.database();
    console.log('使用TCB数据库实例');
} else if (typeof wx !== 'undefined' && wx.cloud && wx.cloud.database) {
    db = wx.cloud.database();
    console.log('使用微信云数据库实例');
} else {
    console.error('无法获取数据库实例，$tcb和wx.cloud都不可用');
    return;
}
```

### 2. 云函数调用方式

#### ❌ 错误方式（uniCloud）
```javascript
// 不要使用uniCloud
uniCloud.callFunction({
    name: 'getUserProfile',
    data: { userId: authorOpenid },
    success: (res) => { /* 处理成功 */ },
    fail: (err) => { /* 处理失败 */ }
});
```

#### ✅ 正确方式（TCB）
```javascript
// 使用TCB调用云函数
if (this.$tcb && this.$tcb.callFunction) {
    this.$tcb.callFunction({
        name: 'getUserProfile',
        data: { userId: authorOpenid }
    }).then((res) => {
        // 处理成功响应
        console.log('云函数调用成功:', res);
    }).catch((err) => {
        // 处理错误
        console.error('云函数调用失败:', err);
    });
}
```

### 3. 数据库访问兼容性

项目需要同时支持H5和小程序环境，因此需要兼容性处理：

```javascript
// 兼容性数据库访问
const getDatabase = () => {
    if (this.$tcb && this.$tcb.database) {
        return this.$tcb.database(); // H5环境
    } else if (typeof wx !== 'undefined' && wx.cloud && wx.cloud.database) {
        return wx.cloud.database(); // 小程序环境
    } else {
        throw new Error('无法获取数据库实例');
    }
};
```

### 4. 云函数部署

#### 部署命令
```bash
# 部署所有云函数
cloudbase framework:deploy

# 部署单个云函数
cloudbase fn deploy [functionName]
```

#### 部署状态检查
```bash
# 查看云函数列表
cloudbase fn list

# 查看环境信息
cloudbase env list
```

### 5. 调试和错误处理

#### 调试信息
在main.js中添加了详细的调试日志：

```javascript
// TCB初始化调试
console.log('🔧 [TCB初始化] TCB实例已创建:', tcbApp);
console.log('🔧 [TCB初始化] 环境ID:', tcbApp.config?.env);
console.log('🔧 [TCB初始化] 数据库方法可用:', typeof tcbApp.database === 'function');
```

#### 错误处理
所有云函数调用都应该包含错误处理：

```javascript
this.$tcb.callFunction({
    name: 'functionName',
    data: { /* 参数 */ }
}).then((res) => {
    // 成功处理
}).catch((err) => {
    console.error('云函数调用失败:', err);
    // 错误处理
}).finally(() => {
    // 清理工作
});
```

## 🚀 最佳实践

### 1. 云函数调用检查
在调用云函数前，始终检查TCB实例是否可用：

```javascript
if (!this.$tcb || !this.$tcb.callFunction) {
    console.error('TCB实例不可用');
    return;
}
```

### 2. 数据库操作检查
在访问数据库前，检查数据库实例：

```javascript
if (!this.$tcb || !this.$tcb.database) {
    console.error('数据库实例不可用');
    return;
}
```

### 3. 环境兼容性
确保代码在不同环境下都能正常工作：

```javascript
// 检查运行环境
const isH5 = typeof window !== 'undefined';
const isMiniProgram = typeof wx !== 'undefined';

if (isH5) {
    // H5环境使用TCB
    const db = this.$tcb.database();
} else if (isMiniProgram) {
    // 小程序环境使用微信云开发
    const db = wx.cloud.database();
}
```

## 🔍 常见问题排查

### 1. TCB实例未定义
**症状**: `this.$tcb is undefined`
**解决**: 检查main.js中的TCB初始化代码是否正确执行

### 2. 云函数调用失败
**症状**: 云函数返回错误或超时
**解决**: 
- 检查云函数是否已部署
- 检查环境ID是否正确
- 检查网络连接

### 3. 数据库访问失败
**症状**: 数据库操作返回错误
**解决**:
- 检查数据库权限
- 检查集合名称是否正确
- 检查查询条件是否正确

### 4. Vue组件加载失败
**症状**: `Failed to resolve async component`
**解决**:
- 检查组件导入路径
- 检查组件是否存在
- 重启开发服务器

## 📝 开发建议

1. **始终使用TCB SDK**，不要混用uniCloud
2. **添加完善的错误处理**，确保用户体验
3. **使用调试日志**，便于问题排查
4. **测试不同环境**，确保兼容性
5. **定期检查云函数状态**，确保服务正常

## 🔄 uniCloud迁移经验

### 迁移策略
1. **创建兼容性工具**：在`utils/cloudFunction.js`中创建统一的云函数调用方法
2. **环境检测**：自动检测H5和小程序环境，选择合适的调用方式
3. **渐进式迁移**：优先修复工具类（avatarCache.js、followCache.js），再修复页面

### 常见问题
- **错误信息**：`应用未关联服务空间,请在uniCloud目录右键关联服务空间`
- **解决方案**：将所有`uniCloud.callFunction`替换为兼容性调用方法
- **调试技巧**：添加详细的日志输出，便于追踪调用流程

### 迁移步骤
1. 为工具类添加`callCloudFunction`方法
2. 替换所有`uniCloud.callFunction`调用
3. 添加环境检测和错误处理
4. 测试H5和小程序环境兼容性

## 🛠️ 实际修复经验总结

### 修复过程中发现的问题类型

#### 1. 语法错误类型
- **多余的逗号**：`uniCloud.callFunction({...}),` → `this.callCloudFunction({...})`
- **多余的括号**：`});` → `});`
- **回调结构错误**：`success: (res) => {...}, fail: (err) => {...}` → `.then((res) => {...}).catch((err) => {...})`

#### 2. 文件上传兼容性
- **问题**：`uniCloud.uploadFile`在小程序环境不可用
- **解决方案**：创建兼容性`uploadFile`方法，支持TCB和微信云开发
- **实现**：在profile-edit.vue中添加了`uploadFile`方法

#### 3. 批量修复策略
- **自动化脚本**：创建`fix_unicloud.js`脚本批量修复多个文件
- **修复范围**：17个页面文件 + 3个工具类文件
- **修复效果**：从22个文件包含uniCloud调用减少到0个

### 修复后的文件状态

#### 工具类文件
- ✅ `utils/cloudFunction.js` - 修复H5环境中的`this`引用问题
- ✅ `utils/avatarCache.js` - 已有兼容性方法，无需修改
- ✅ `utils/followCache.js` - 已有兼容性方法，无需修改
- ✅ `utils/imageManager.js` - 替换了所有`uniCloud.callFunction`调用

#### 页面文件
- ✅ `pages/splash/splash.vue` - 修复2处云函数调用
- ✅ `pages/messages/messages.vue` - 修复4处云函数调用
- ✅ `pages/profile-edit/profile-edit.vue` - 修复云函数调用和文件上传
- ✅ `pages/add/add.vue` - 修复2处云函数调用
- ✅ 其他13个页面文件 - 批量修复完成

#### 组件文件
- ✅ `components/folder-selector/folder-selector.vue` - 修复3处云函数调用

### 修复效果统计

#### 语法错误修复
- **messages.vue**: 从36个错误减少到0个
- **profile-edit.vue**: 从10个错误减少到0个
- **add.vue**: 从46个错误减少到0个
- **folder-selector.vue**: 从40个错误减少到0个

#### 兼容性实现
- **H5环境**: 使用`this.$tcb.callFunction`和`this.$tcb.uploadFile`
- **小程序环境**: 使用`wx.cloud.callFunction`和`wx.cloud.uploadFile`
- **错误处理**: 添加了详细的调试日志和用户提示

### 最佳实践建议

#### 1. 云函数调用模式
```javascript
// ✅ 推荐方式
this.callCloudFunction('functionName', {
    param1: value1,
    param2: value2
}).then((res) => {
    // 处理成功响应
}).catch((err) => {
    // 处理错误
}).finally(() => {
    // 清理工作
});
```

#### 2. 文件上传模式
```javascript
// ✅ 推荐方式
this.uploadFile(cloudPath, filePath).then((res) => {
    // 处理上传成功
}).catch((err) => {
    // 处理上传失败
});
```

#### 3. 错误处理模式
```javascript
// ✅ 推荐方式
.catch((err) => {
    console.error('操作失败:', err);
    uni.showToast({
        title: '操作失败',
        icon: 'none'
    });
});
```

### 调试技巧

#### 1. 环境检测日志
```javascript
console.log(`🔍 [页面] 运行环境检测 - H5: ${isH5}, 小程序: ${isMiniProgram}`);
```

#### 2. 云函数调用日志
```javascript
console.log(`🔍 [页面] 调用云函数: ${name}`, data);
console.log(`✅ [页面] 云函数调用成功: ${name}`, res);
console.error(`❌ [页面] 云函数调用失败: ${name}`, err);
```

#### 3. 错误分类处理
- **网络错误**: 显示"网络错误，请重试"
- **业务错误**: 显示具体错误信息
- **系统错误**: 显示"系统错误，请联系管理员"

## 🔗 相关文档

- [腾讯云开发文档](https://cloud.tencent.com/document/product/876)
- [CloudBase CLI文档](https://cloud.tencent.com/document/product/876/41392)
- [uni-app文档](https://uniapp.dcloud.io/)

---

**最后更新**: 2025-01-27  
**维护者**: 项目开发团队  
**更新内容**: 添加实际修复经验总结、最佳实践建议和调试技巧
